<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 5 Spatial Interactions of Vector and Raster Data | R as GIS for Economists</title>
<meta name="author" content="Taro Mieno">
<meta name="description" content="Before you start In this chapter we learn the spatial interactions of a vector and raster dataset. We first look at how to crop (spatially subset) a raster dataset based on the geographic extent...">
<meta name="generator" content="bookdown 0.27 with bs4_book()">
<meta property="og:title" content="Chapter 5 Spatial Interactions of Vector and Raster Data | R as GIS for Economists">
<meta property="og:type" content="book">
<meta property="og:description" content="Before you start In this chapter we learn the spatial interactions of a vector and raster dataset. We first look at how to crop (spatially subset) a raster dataset based on the geographic extent...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 5 Spatial Interactions of Vector and Raster Data | R as GIS for Economists">
<meta name="twitter:description" content="Before you start In this chapter we learn the spatial interactions of a vector and raster dataset. We first look at how to crop (spatially subset) a raster dataset based on the geographic extent...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><link href="libs/_Lato-0.4.1/font.css" rel="stylesheet">
<link href="libs/_Roboto%20Mono-0.4.1/font.css" rel="stylesheet">
<link href="libs/_Montserrat-0.4.1/font.css" rel="stylesheet">
<script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script><link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet">
<script src="libs/leaflet-1.3.1/leaflet.js"></script><link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet">
<script src="libs/proj4-2.6.2/proj4.min.js"></script><script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script><link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet">
<script src="libs/leaflet-binding-2.1.1/leaflet.js"></script><script src="libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script><script src="libs/leaflet-providers-plugin-2.1.1/leaflet-providers-plugin.js"></script><link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="libs/datatables-binding-0.23/datatables.js"></script><link href="libs/dt-core-1.11.3/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="libs/dt-core-1.11.3/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="libs/dt-core-1.11.3/js/jquery.dataTables.min.js"></script><link href="libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet">
<script src="libs/crosstalk-1.2.0/js/crosstalk.min.js"></script><link href="style.css" rel="stylesheet" type="text/css">
<!-- Google tag (gtag.js) --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-59758608-3"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag() { dataLayer.push(arguments); }
      gtag('js', new Date());

      gtag('config', 'UA-59758608-3');
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
<link rel="stylesheet" href="style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">R as GIS for Economists</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome</a></li>
<li><a class="" href="preface.html">Preface</a></li>
<li class="book-part">Demonstration</li>
<li><a class="" href="demo.html"><span class="header-section-number">1</span> R as GIS: Demonstrations</a></li>
<li class="book-part">Foundations</li>
<li><a class="" href="vector-basics.html"><span class="header-section-number">2</span> Vector Data Handling with sf</a></li>
<li><a class="" href="int-vv.html"><span class="header-section-number">3</span> Spatial Interactions of Vector Data: Subsetting and Joining</a></li>
<li><a class="" href="raster-basics.html"><span class="header-section-number">4</span> Raster Data Handling</a></li>
<li><a class="active" href="int-RV.html"><span class="header-section-number">5</span> Spatial Interactions of Vector and Raster Data</a></li>
<li class="book-part">(slightly) Advanced Topics</li>
<li><a class="" href="EE.html"><span class="header-section-number">6</span> Extraction Speed Considerations</a></li>
<li><a class="" href="stars-basics.html"><span class="header-section-number">7</span> Spatiotemporal Raster Data Handling with stars</a></li>
<li class="book-part">Extensions</li>
<li><a class="" href="create-maps.html"><span class="header-section-number">8</span> Creating Maps using ggplot2</a></li>
<li><a class="" href="download-data.html"><span class="header-section-number">9</span> Download and process spatial datasets from within R</a></li>
<li class="book-part">Appendix</li>
<li><a class="" href="par-comp.html"><span class="header-section-number">A</span> Loop and Parallel Computing</a></li>
<li><a class="" href="ggplot2-minimals.html"><span class="header-section-number">B</span> ggplot2 minimals</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="int-RV" class="section level1" number="5">
<h1>
<span class="header-section-number">5</span> Spatial Interactions of Vector and Raster Data<a class="anchor" aria-label="anchor" href="#int-RV"><i class="fas fa-link"></i></a>
</h1>
<div id="before-you-start-4" class="section level2 unnumbered">
<h2>Before you start<a class="anchor" aria-label="anchor" href="#before-you-start-4"><i class="fas fa-link"></i></a>
</h2>
<p>In this chapter we learn the spatial interactions of a vector and raster dataset. We first look at how to crop (spatially subset) a raster dataset based on the geographic extent of a vector dataset. We then cover how to extract values from raster data for points and polygons. To be precise, here is what we mean by raster data extraction and what it does for points and polygons data:</p>
<ul>
<li><p><strong>Points</strong>: For each of the points, find which raster cell it is located within, and assign the value of the cell to the point.</p></li>
<li><p><strong>Polygons</strong>: For each of the polygons, identify all the raster cells that intersect with the polygon, and assign a vector of the cell values to the polygon</p></li>
</ul>
<p>This is probably the most important operation economists run on raster datasets.</p>
<p>We will show how we can use <code><a href="https://rdrr.io/pkg/terra/man/extract.html">terra::extract()</a></code> for both cases. But, we will also see that for polygons, <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract()</a></code> from the <code>exactextractr</code> package is often considerably faster than <code><a href="https://rdrr.io/pkg/terra/man/extract.html">terra::extract()</a></code>.</p>
<p>Finally, you will see conversions between <code>Raster</code><span class="math inline">\(^*\)</span> (<code>raster</code> package) objects and <code>SpatRaster</code> object (<code>terra</code> package) because of the incompatibility of object classes across the key packages. I believe that these hassles will go away soon when they start supporting each other.</p>
<div id="direction-for-replication-4" class="section level3 unnumbered">
<h3>Direction for replication<a class="anchor" aria-label="anchor" href="#direction-for-replication-4"><i class="fas fa-link"></i></a>
</h3>
<p><strong>Datasets</strong></p>
<p>All the datasets that you need to import are available <a href="https://www.dropbox.com/sh/l84zfidaxmjrti9/AAB1GrDRoIlidJ3_zArMN24ua?dl=0">here</a>. In this chapter, the path to files is set relative to my own working directory (which is hidden). To run the codes without having to mess with paths to the files, follow these steps:</p>
<ul>
<li>set a folder (any folder) as the working directory using <code><a href="https://rdrr.io/r/base/getwd.html">setwd()</a></code>
</li>
<li>create a folder called “Data” inside the folder designated as the working directory (if you have created a “Data” folder previously, skip this step)</li>
<li>download the pertinent datasets from <a href="https://www.dropbox.com/sh/l84zfidaxmjrti9/AAB1GrDRoIlidJ3_zArMN24ua?dl=0">here</a>
</li>
<li>place all the files in the downloaded folder in the “Data” folder</li>
</ul>
<p><strong>Packages</strong></p>
<p>Run the following code to install or load (if already installed) the <code>pacman</code> package, and then install or load (if already installed) the listed package inside the <code><a href="https://rdrr.io/pkg/pacman/man/p_load.html">pacman::p_load()</a></code> function.</p>
<div class="sourceCode" id="cb448"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="st"><a href="https://github.com/trinker/pacman">"pacman"</a></span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"pacman"</span><span class="op">)</span></span>
<span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span></span>
<span>  <span class="va">terra</span>, <span class="co"># handle raster data</span></span>
<span>  <span class="va">raster</span>, <span class="co"># handle raster data</span></span>
<span>  <span class="va">exactextractr</span>, <span class="co"># fast extractions</span></span>
<span>  <span class="va">sf</span>, <span class="co"># vector data operations</span></span>
<span>  <span class="va">dplyr</span>, <span class="co"># data wrangling</span></span>
<span>  <span class="va">tidyr</span>, <span class="co"># data wrangling</span></span>
<span>  <span class="va">data.table</span>, <span class="co"># data wrangling</span></span>
<span>  <span class="va">prism</span>, <span class="co"># download PRISM data</span></span>
<span>  <span class="va">tictoc</span>, <span class="co"># timing codes</span></span>
<span>  <span class="va">tigris</span>, <span class="co"># to get county sf</span></span>
<span>  <span class="va">tmap</span> <span class="co"># for mapping</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div id="raster-crop" class="section level2" number="5.1">
<h2>
<span class="header-section-number">5.1</span> Cropping to the Area of Interest<a class="anchor" aria-label="anchor" href="#raster-crop"><i class="fas fa-link"></i></a>
</h2>
<p>Here we use PRISM maximum temperature (tmax) data as a raster dataset and Kansas county boundaries as a vector dataset.</p>
<p>Let’s download the tmax data for July 1, 2018 (Figure <a href="int-RV.html#fig:prism-tmax-map">5.1</a>).</p>
<div class="sourceCode" id="cb449"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#--- set the path to the folder to which you save the downloaded PRISM data ---#</span></span>
<span><span class="co"># This code sets the current working directory as the designated folder</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>prism.path <span class="op">=</span> <span class="st">"Data"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- download PRISM precipitation data ---#</span></span>
<span><span class="fu">get_prism_dailys</span><span class="op">(</span></span>
<span>  type <span class="op">=</span> <span class="st">"tmax"</span>,</span>
<span>  date <span class="op">=</span> <span class="st">"2018-07-01"</span>,</span>
<span>  keepZip <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- the file name of the PRISM data just downloaded ---#</span></span>
<span><span class="va">prism_file</span> <span class="op">&lt;-</span> <span class="st">"Data/PRISM_tmax_stable_4kmD2_20180701_bil/PRISM_tmax_stable_4kmD2_20180701_bil.bil"</span></span>
<span></span>
<span><span class="co">#--- read in the prism data ---#</span></span>
<span><span class="va">prism_tmax_0701_sr</span> <span class="op">&lt;-</span> <span class="fu">rast</span><span class="op">(</span><span class="va">prism_file</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:prism-tmax-map"></span>
<img src="R_GIS_Book_files/figure-html/prism-tmax-map-1.png" alt="Map of PRISM tmax data on July 1, 2018" width="672"><p class="caption">
Figure 5.1: Map of PRISM tmax data on July 1, 2018
</p>
</div>
<p>We now get Kansas county border data from the <code>tigris</code> package (Figure <a href="int-RV.html#fig:ks-county-map">5.2</a>) as <code>sf</code>.</p>
<div class="sourceCode" id="cb450"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#--- Kansas boundary (sf) ---#</span></span>
<span><span class="va">KS_county_sf</span> <span class="op">&lt;-</span></span>
<span>  <span class="co">#--- get Kansas county boundary ---</span></span>
<span>  <span class="fu">tigris</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tigris/man/counties.html">counties</a></span><span class="op">(</span>state <span class="op">=</span> <span class="st">"Kansas"</span>, cb <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- sp to sf ---#</span></span>
<span>  <span class="fu">st_as_sf</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">#--- transform using the CRS of the PRISM tmax data  ---#</span></span>
<span>  <span class="fu">st_transform</span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/crs.html">crs</a></span><span class="op">(</span><span class="va">prism_tmax_0701_sr</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:ks-county-map"></span>
<img src="R_GIS_Book_files/figure-html/ks-county-map-1.png" alt="Kansas county boundaries" width="672"><p class="caption">
Figure 5.2: Kansas county boundaries
</p>
</div>
<hr>
<p>Sometimes, it is convenient to crop a raster layer to the specific area of interest so that you do not have to carry around unnecessary parts of the raster layer. Moreover, it takes less time to extract values from a raster layer when the size of the raster layer is smaller. You can crop a raster layer by using <code><a href="https://rdrr.io/pkg/terra/man/crop.html">terra::crop()</a></code>. It works like this:</p>
<div class="sourceCode" id="cb451"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#--- syntax (this does not run) ---#</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/crop.html">crop</a></span><span class="op">(</span><span class="va">SpatRaster</span>, <span class="va">sf</span><span class="op">)</span></span></code></pre></div>
<p>So, in this case, this does the job.</p>
<div class="sourceCode" id="cb452"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#--- crop the entire PRISM to its KS portion---#</span></span>
<span><span class="va">prism_tmax_0701_KS_sr</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/crop.html">crop</a></span><span class="op">(</span><span class="va">prism_tmax_0701_sr</span>, <span class="va">KS_county_sf</span><span class="op">)</span></span></code></pre></div>
<p>The figure below (Figure <a href="int-RV.html#fig:prism-ks-viz">5.3</a>) shows the PRISM tmax raster data cropped to the geographic extent of Kansas. Notice that the cropped raster layer extends beyond the outer boundary of Kansas state boundary (it is a bit hard to see, but look at the upper right corner).</p>
<div class="figure">
<span style="display:block;" id="fig:prism-ks-viz"></span>
<img src="R_GIS_Book_files/figure-html/prism-ks-viz-1.png" alt="PRISM tmax raster data cropped to the geographic extent of Kansas" width="672"><p class="caption">
Figure 5.3: PRISM tmax raster data cropped to the geographic extent of Kansas
</p>
</div>
</div>
<div id="extracting-values-from-raster-layers-for-vector-data" class="section level2" number="5.2">
<h2>
<span class="header-section-number">5.2</span> Extracting Values from Raster Layers for Vector Data<a class="anchor" aria-label="anchor" href="#extracting-values-from-raster-layers-for-vector-data"><i class="fas fa-link"></i></a>
</h2>
<p>In this section, we will learn how to extract information from raster layers for spatial units represented as vector data (points and polygons). For the demonstrations in this section, we use the following datasets:</p>
<ul>
<li>Raster: PRISM tmax data cropped to Kansas state border for 07/01/2018 (obtained in <a href="int-RV.html#raster-crop">5.1</a>) and 07/02/2018 (downloaded below)</li>
<li>Polygons: Kansas county boundaries (obtained in <a href="int-RV.html#raster-crop">5.1</a>)</li>
<li>Points: Irrigation wells in Kansas (imported below)</li>
</ul>
<div id="simple-visual-illustrations-of-raster-data-extraction" class="section level3" number="5.2.1">
<h3>
<span class="header-section-number">5.2.1</span> Simple visual illustrations of raster data extraction<a class="anchor" aria-label="anchor" href="#simple-visual-illustrations-of-raster-data-extraction"><i class="fas fa-link"></i></a>
</h3>
<p><strong>Extracting to Points</strong></p>
<p>Figure <a href="int-RV.html#fig:illustrate-points">5.4</a> shows visually what we mean by “extract raster values to points.”</p>
<div class="figure">
<span style="display:block;" id="fig:illustrate-points"></span>
<img src="R_GIS_Book_files/figure-html/illustrate-points-1.png" alt="Visual illustration of raster data extraction for points data" width="672"><p class="caption">
Figure 5.4: Visual illustration of raster data extraction for points data
</p>
</div>
<p>In the figure, we have grids (cells) and each grid holds a value (presented at the center). There are three points. We will find which grid the points fall inside and get the associated values and assign them to the points. In this example, Points 1, 2, and 3 will have 50, 4, 54, respectively,</p>
<p><strong>Extracting to Polygons</strong></p>
<p>Figure <a href="int-RV.html#fig:polygons-extact-viz">5.5</a> shows visually what we mean by “extract raster values to polygons.”</p>
<div class="figure">
<span style="display:block;" id="fig:polygons-extact-viz"></span>
<img src="R_GIS_Book_files/figure-html/polygons-extact-viz-1.png" alt="Visual illustration of raster data extraction for polygons data" width="672"><p class="caption">
Figure 5.5: Visual illustration of raster data extraction for polygons data
</p>
</div>
<p>There is a polygon overlaid on top of the cells along with their centroids represented by black dots. Extracting raster values to a polygon means finding raster cells that intersect with the polygons and get the value of all those cells and assigns them to the polygon. As you can see some cells are completely inside the polygon, while others are only partially overlapping with the polygon. Depending on the function you use and its options, you regard different cells as being spatially related to the polygons. For example, by default, <code><a href="https://rdrr.io/pkg/terra/man/extract.html">terra::extract()</a></code> will extract only the cells whose centroid is inside the polygon. But, you can add an option to include the cells that are only partially intersected with the polygon. In such a case, you can also get the fraction of the cell what is overlapped with the polygon, which enables us to find area-weighted values later. We will discuss the details these below.</p>
<p><strong>PRISM tmax data for 07/02/2018</strong></p>
<div class="sourceCode" id="cb453"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#--- download PRISM precipitation data ---#</span></span>
<span><span class="fu">get_prism_dailys</span><span class="op">(</span></span>
<span>  type <span class="op">=</span> <span class="st">"tmax"</span>,</span>
<span>  date <span class="op">=</span> <span class="st">"2018-07-02"</span>,</span>
<span>  keepZip <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- the file name of the PRISM data just downloaded ---#</span></span>
<span><span class="va">prism_file</span> <span class="op">&lt;-</span> <span class="st">"Data/PRISM_tmax_stable_4kmD2_20180702_bil/PRISM_tmax_stable_4kmD2_20180702_bil.bil"</span></span>
<span></span>
<span><span class="co">#--- read in the prism data and crop it to Kansas state border ---#</span></span>
<span><span class="va">prism_tmax_0702_KS_sr</span> <span class="op">&lt;-</span> <span class="fu">rast</span><span class="op">(</span><span class="va">prism_file</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/crop.html">crop</a></span><span class="op">(</span><span class="va">KS_county_sf</span><span class="op">)</span></span></code></pre></div>
<p><strong>Irrigation wells in Kansas:</strong></p>
<div class="sourceCode" id="cb454"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#--- read in the KS points data ---#</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">KS_wells</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"Data/Chap_5_wells_KS.rds"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code>Simple feature collection with 37647 features and 1 field
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: -102.0495 ymin: 36.99552 xmax: -94.62089 ymax: 40.00199
Geodetic CRS:  NAD83
First 10 features:
   well_id                   geometry
1        1 POINT (-100.4423 37.52046)
2        3 POINT (-100.7118 39.91526)
3        5 POINT (-99.15168 38.48849)
4        7 POINT (-101.8995 38.78077)
5        8  POINT (-100.7122 38.0731)
6        9 POINT (-97.70265 39.04055)
7       11 POINT (-101.7114 39.55035)
8       12 POINT (-95.97031 39.16121)
9       15 POINT (-98.30759 38.26787)
10      17 POINT (-100.2785 37.71539)</code></pre>
<hr>
<p>Here is how the wells are spatially distributed over the PRISM grids and Kansas county borders (Figure <a href="int-RV.html#fig:tmax-prism-wells">5.6</a>):</p>
<div class="figure">
<span style="display:block;" id="fig:tmax-prism-wells"></span>
<img src="R_GIS_Book_files/figure-html/tmax-prism-wells-1.png" alt="Map of Kansas county borders, irrigation wells, and PRISM tmax" width="672"><p class="caption">
Figure 5.6: Map of Kansas county borders, irrigation wells, and PRISM tmax
</p>
</div>
</div>
<div id="extracting-to-points" class="section level3" number="5.2.2">
<h3>
<span class="header-section-number">5.2.2</span> Extracting to Points<a class="anchor" aria-label="anchor" href="#extracting-to-points"><i class="fas fa-link"></i></a>
</h3>
<p>You can extract values from raster layers to points using <code><a href="https://rdrr.io/pkg/terra/man/extract.html">terra::extract()</a></code>. <code><a href="https://rdrr.io/pkg/terra/man/extract.html">terra::extract()</a></code> finds which raster cell each of the points is located within and assigns the value of the cell to the point.</p>
<div class="sourceCode" id="cb456"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#--- syntax (this does not run) ---#</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/extract.html">extract</a></span><span class="op">(</span><span class="va">raster</span>, <span class="va">points</span><span class="op">)</span></span></code></pre></div>
<p>Let’s extract tmax values from the PRISM tmax layer (<code>prism_tmax_0701_KS_sr</code>) to the irrigation wells:</p>
<div class="sourceCode" id="cb457"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tmax_from_prism</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/extract.html">extract</a></span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr</span>, <span class="va">KS_wells</span><span class="op">)</span></span></code></pre></div>
<p>Oh, okay. So, the problem is that the points data (<code>KS_wells</code>) is an <code>sf</code> object, and <code><a href="https://rdrr.io/pkg/terra/man/extract.html">terra::extract()</a></code> does not like it (I thought this would be fixed by now …). Let’s turn KS_wells into an <code>SpatVect</code> object and then apply <code><a href="https://rdrr.io/pkg/terra/man/extract.html">terra::extract()</a></code>:</p>
<div class="sourceCode" id="cb458"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tmax_from_prism</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/extract.html">extract</a></span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr</span>, <span class="fu">vect</span><span class="op">(</span><span class="va">KS_wells</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- take a look ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">tmax_from_prism</span><span class="op">)</span></span></code></pre></div>
<pre><code>  ID PRISM_tmax_stable_4kmD2_20180701_bil
1  1                               34.241
2  2                               29.288
3  3                               32.585
4  4                               30.104
5  5                               34.232
6  6                               35.168</code></pre>
<p>The resulting object is a <code>data.frame</code>, where the <code>ID</code> variable represents the order of the observations in the points data and the second column represents that values extracted for the points from the raster cells. So, you can assign the extracted values as a new variable of the points data as follows:</p>
<div class="sourceCode" id="cb460"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">KS_wells</span><span class="op">$</span><span class="va">tmax_07_01</span> <span class="op">&lt;-</span> <span class="va">tmax_from_prism</span><span class="op">[</span>, <span class="op">-</span><span class="fl">1</span><span class="op">]</span></span></code></pre></div>
<p>Extracting values from a multi-layer <code>SpatRaster</code> works the same way. Here, we combine <code>prism_tmax_0701_KS_sr</code> and <code>prism_tmax_0702_KS_sr</code> to create a multi-layer <code>SpatRaster</code> and then extract values from them.</p>
<div class="sourceCode" id="cb461"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#--- create a multi-layer SpatRaster ---#</span></span>
<span><span class="va">prism_tmax_stack</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr</span>, <span class="va">prism_tmax_0702_KS_sr</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- extract tmax values ---#</span></span>
<span><span class="va">tmax_from_prism_stack</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/extract.html">extract</a></span><span class="op">(</span><span class="va">prism_tmax_stack</span>, <span class="fu">vect</span><span class="op">(</span><span class="va">KS_wells</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- take a look ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">tmax_from_prism_stack</span><span class="op">)</span></span></code></pre></div>
<pre><code>  ID PRISM_tmax_stable_4kmD2_20180701_bil PRISM_tmax_stable_4kmD2_20180702_bil
1  1                               34.241                               30.544
2  2                               29.288                               29.569
3  3                               32.585                               29.866
4  4                               30.104                               29.819
5  5                               34.232                               30.481
6  6                               35.168                               30.640</code></pre>
<p>We now have two columns that hold values extracted from the raster cells: the 2nd column for the 1st raster layer and the 3rd column for the 2nd raster layer in <code>prism_tmax_stack</code>.</p>
<p><strong>Side note:</strong></p>
<p>Interestingly, <code><a href="https://rdrr.io/pkg/terra/man/extract.html">terra::extract()</a></code> can work with <code>sf</code> as long as the raster object is of type <code>Raster</code><span class="math inline">\(^*\)</span>. In the code below, <code>prism_tmax_stack</code> is converted to <code>RasterStack</code> before <code><a href="https://rdrr.io/pkg/terra/man/extract.html">terra::extract()</a></code> does its job and it works just fine.</p>
<div class="sourceCode" id="cb463"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tmax_from_prism</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/extract.html">extract</a></span><span class="op">(</span><span class="fu">as</span><span class="op">(</span><span class="va">prism_tmax_stack</span>, <span class="st">"Raster"</span><span class="op">)</span>, <span class="va">KS_wells</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb464"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#--- take a look ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">tmax_from_prism</span><span class="op">)</span></span></code></pre></div>
<pre><code>  ID PRISM_tmax_stable_4kmD2_20180701_bil
1  1                               34.241
2  2                               29.288
3  3                               32.585
4  4                               30.104
5  5                               34.232
6  6                               35.168</code></pre>
<div class="sourceCode" id="cb466"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#--- check the class ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">tmax_from_prism</span><span class="op">)</span></span></code></pre></div>
<pre><code>[1] "data.frame"</code></pre>
<p>As you can see, the resulting object is a <code>matrix</code> instead of a <code>data.frame</code>. Now, let’s see if we can use a <code>SpatVect</code> instead of an <code>sf</code>.</p>
<div class="sourceCode" id="cb468"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tmax_from_prism</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/extract.html">extract</a></span><span class="op">(</span></span>
<span>    <span class="fu">as</span><span class="op">(</span><span class="va">prism_tmax_stack</span>, <span class="st">"Raster"</span><span class="op">)</span>,</span>
<span>    <span class="fu">vect</span><span class="op">(</span><span class="va">KS_wells</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<pre><code>Error in (function (classes, fdef, mtable) : unable to find an inherited method for function 'extract' for signature '"RasterBrick", "SpatVector"'</code></pre>
<p>So, it does not work. It turns out that <code><a href="https://rdrr.io/pkg/terra/man/extract.html">terra::extract()</a></code> works for the combinations of <code>SpatRaster</code>-<code>SpatVect</code> or <code>Raster</code><span class="math inline">\(^*\)</span>-<code>sf</code>/<code>sp</code>.</p>
</div>
<div id="extracting-to-polygons-terra-way" class="section level3" number="5.2.3">
<h3>
<span class="header-section-number">5.2.3</span> Extracting to Polygons (<code>terra</code> way)<a class="anchor" aria-label="anchor" href="#extracting-to-polygons-terra-way"><i class="fas fa-link"></i></a>
</h3>
<p>You can use <code><a href="https://rdrr.io/pkg/terra/man/extract.html">terra::extract()</a></code> for extracting raster cell values for polygons as well. For each of the polygons, it will identify all the raster cells whose center lies inside the polygon and assign the vector of values of the cells to the polygon. Let’s first convert <code>KS_county_sf</code> (an <code>sf</code> object) to a <code>SpatVector</code>.</p>
<div class="sourceCode" id="cb470"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#--- Kansas boundary (SpatVector) ---#</span></span>
<span><span class="va">KS_county_sv</span> <span class="op">&lt;-</span> <span class="fu">vect</span><span class="op">(</span><span class="va">KS_county_sf</span><span class="op">)</span></span></code></pre></div>
<!-- (You can change this to the cells that intersect with polygons using the `touch = TRUE` option).  -->
<p>Now, let’s extract tmax values for each of the KS counties.</p>
<div class="sourceCode" id="cb471"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#--- extract values from the raster for each county ---#</span></span>
<span><span class="va">tmax_by_county</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/extract.html">extract</a></span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr</span>, <span class="va">KS_county_sv</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb472"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#--- check the class ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">tmax_by_county</span><span class="op">)</span></span></code></pre></div>
<pre><code>[1] "data.frame"</code></pre>
<div class="sourceCode" id="cb474"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#--- take a look ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">tmax_by_county</span><span class="op">)</span></span></code></pre></div>
<pre><code>  ID PRISM_tmax_stable_4kmD2_20180701_bil
1  1                               34.228
2  1                               34.222
3  1                               34.256
4  1                               34.268
5  1                               34.262
6  1                               34.477</code></pre>
<div class="sourceCode" id="cb476"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#--- take a look ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span><span class="op">(</span><span class="va">tmax_by_county</span><span class="op">)</span></span></code></pre></div>
<pre><code>       ID PRISM_tmax_stable_4kmD2_20180701_bil
12840 105                               34.185
12841 105                               34.180
12842 105                               34.241
12843 105                               34.381
12844 105                               34.295
12845 105                               34.267</code></pre>
<p>So, <code><a href="https://rdrr.io/pkg/terra/man/extract.html">terra::extract()</a></code> returns a <code>data.frame</code>, where <code>ID</code> values represent the corresponding row number in the polygons data. For example, the observations with <code>ID == n</code> are for the <strong>n</strong>th polygon. Using this information, you can easily merge the extraction results to the polygons data. Suppose you are interested in the mean of the tmax values of the intersecting cells for each of the polygons, then you can do the following:</p>
<div class="sourceCode" id="cb478"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#--- get mean tmax ---#</span></span>
<span><span class="va">mean_tmax</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">tmax_by_county</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">ID</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span>tmax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">PRISM_tmax_stable_4kmD2_20180701_bil</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">KS_county_sf</span> <span class="op">&lt;-</span></span>
<span>    <span class="co">#--- back to sf ---#</span></span>
<span>    <span class="fu">st_as_sf</span><span class="op">(</span><span class="va">KS_county_sv</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- define ID ---#</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span><span class="va">ID</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- merge by ID ---#</span></span>
<span>    <span class="fu">left_join</span><span class="op">(</span><span class="va">.</span>, <span class="va">mean_tmax</span>, by <span class="op">=</span> <span class="st">"ID"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code>Simple feature collection with 105 features and 14 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: -102.0517 ymin: 36.99302 xmax: -94.58841 ymax: 40.00316
Geodetic CRS:  NAD83
First 10 features:
   STATEFP COUNTYFP COUNTYNS       AFFGEOID GEOID         NAME
1       20      123 00485026 0500000US20123 20123     Mitchell
2       20      149 00485038 0500000US20149 20149 Pottawatomie
3       20      203 00485062 0500000US20203 20203      Wichita
4       20      151 00485039 0500000US20151 20151        Pratt
5       20      043 00484991 0500000US20043 20043     Doniphan
6       20      145 00485036 0500000US20145 20145       Pawnee
7       20      119 00485024 0500000US20119 20119        Meade
8       20      071 00485002 0500000US20071 20071      Greeley
9       20      001 00484970 0500000US20001 20001        Allen
10      20      169 00485047 0500000US20169 20169       Saline
              NAMELSAD STUSPS STATE_NAME LSAD      ALAND   AWATER ID     tmax
1      Mitchell County     KS     Kansas   06 1817632931 44979980  1 34.21421
2  Pottawatomie County     KS     Kansas   06 2177507162 54149295  2 32.58354
3       Wichita County     KS     Kansas   06 1861078197    61987  3 34.63195
4         Pratt County     KS     Kansas   06 1903740950  1771939  4 33.40829
5      Doniphan County     KS     Kansas   06 1019105691 12424174  5 34.01768
6        Pawnee County     KS     Kansas   06 1953531647   992041  6 35.54426
7         Meade County     KS     Kansas   06 2533222397  3258258  7 34.47948
8       Greeley County     KS     Kansas   06 2016057907        0  8 33.55797
9         Allen County     KS     Kansas   06 1295764235 13021929  9 34.77049
10       Saline County     KS     Kansas   06 1865429339  2760902 10 33.56413
                         geometry
1  POLYGON ((-98.49007 39.2416...
2  POLYGON ((-96.72833 39.4271...
3  POLYGON ((-101.5673 38.4666...
4  POLYGON ((-99.01535 37.6438...
5  POLYGON ((-95.3399 40, -95....
6  POLYGON ((-99.58479 38.3493...
7  POLYGON ((-100.6526 37.4022...
8  POLYGON ((-102.0453 38.5054...
9  POLYGON ((-95.52522 37.7473...
10 POLYGON ((-97.92865 38.8835...</code></pre>
<p>Instead of finding the mean after applying <code><a href="https://rdrr.io/pkg/terra/man/extract.html">terra::extract()</a></code> as done above, you can do that within <code><a href="https://rdrr.io/pkg/terra/man/extract.html">terra::extract()</a></code> using the <code>fun</code> option.</p>
<div class="sourceCode" id="cb480"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#--- extract values from the raster for each county ---#</span></span>
<span><span class="va">tmax_by_county</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/extract.html">extract</a></span><span class="op">(</span></span>
<span>    <span class="va">prism_tmax_0701_KS_sr</span>,</span>
<span>    <span class="va">KS_county_sv</span>,</span>
<span>    fun <span class="op">=</span> <span class="va">mean</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb481"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#--- take a look ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">tmax_by_county</span><span class="op">)</span></span></code></pre></div>
<pre><code>  ID PRISM_tmax_stable_4kmD2_20180701_bil
1  1                             34.21421
2  2                             32.58354
3  3                             34.63195
4  4                             33.40829
5  5                             34.01768
6  6                             35.54426</code></pre>
<p>You can apply other summary functions like <code><a href="https://rdrr.io/r/base/Extremes.html">min()</a></code>, <code><a href="https://rdrr.io/r/base/Extremes.html">max()</a></code>, <code><a href="https://rdrr.io/r/base/sum.html">sum()</a></code>.</p>
<hr>
<p>Extracting values from a multi-layer raster data works exactly the same way except that data processing after the value extraction is slightly more complicated.</p>
<div class="sourceCode" id="cb483"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#--- extract from a multi-layer raster object ---#</span></span>
<span><span class="va">tmax_by_county_from_stack</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/extract.html">extract</a></span><span class="op">(</span></span>
<span>    <span class="va">prism_tmax_stack</span>,</span>
<span>    <span class="va">KS_county_sv</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">#--- take a look ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">tmax_by_county_from_stack</span><span class="op">)</span></span></code></pre></div>
<pre><code>  ID PRISM_tmax_stable_4kmD2_20180701_bil PRISM_tmax_stable_4kmD2_20180702_bil
1  1                               33.290                               29.831
2  1                               33.305                               29.730
3  1                               33.299                               29.811
4  1                               33.257                               29.819
5  1                               33.181                               29.750
6  1                               33.235                               29.757</code></pre>
<p>Similar to the single-layer case, the resulting object is a <code>data.frame</code> and you have two columns corresponding to each of the layers in the two-layer raster object.</p>
<hr>
<p>Sometimes, you would like to have how much of the raster cells are intersecting with the intersecting polygon to find area-weighted summary later. In that case, you can add <code>exact = TRUE</code> option to <code><a href="https://rdrr.io/pkg/terra/man/extract.html">terra::extract()</a></code>.</p>
<div class="sourceCode" id="cb485"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#--- extract from a multi-layer raster object ---#</span></span>
<span><span class="va">tmax_by_county_from_stack</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/extract.html">extract</a></span><span class="op">(</span></span>
<span>    <span class="va">prism_tmax_stack</span>,</span>
<span>    <span class="va">KS_county_sv</span>,</span>
<span>    exact <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">#--- take a look ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">tmax_by_county_from_stack</span><span class="op">)</span></span></code></pre></div>
<pre><code>  ID PRISM_tmax_stable_4kmD2_20180701_bil PRISM_tmax_stable_4kmD2_20180702_bil
1  1                               33.348                               29.844
2  1                               33.259                               29.709
3  1                               33.248                               29.590
4  1                               33.222                               29.560
5  1                               33.215                               29.670
6  1                               33.147                               29.599
    fraction
1 0.02375324
2 0.11818764
3 0.11906455
4 0.11701276
5 0.11494852
6 0.11659929</code></pre>
<p>As you can see, now you have <code>fraction</code> column to the resulting <code>data.frame</code> and you can find area-weighted summary of the extracted values like this:</p>
<div class="sourceCode" id="cb487"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tmax_by_county_from_stack</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">ID</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span></span>
<span>    tmax_0701 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">fraction</span> <span class="op">*</span> <span class="va">PRISM_tmax_stable_4kmD2_20180701_bil</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">fraction</span><span class="op">)</span>,</span>
<span>    tmax_0702 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">fraction</span> <span class="op">*</span> <span class="va">PRISM_tmax_stable_4kmD2_20180702_bil</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">fraction</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<pre><code># A tibble: 105 × 3
      ID tmax_0701 tmax_0702
   &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
 1     1      33.5      30.1
 2     2      35.7      28.8
 3     3      32.6      30.6
 4     4      32.9      29.0
 5     5      34.8      28.3
 6     6      33.0      30.0
 7     7      34.2      30.9
 8     8      31.7      30.1
 9     9      34.3      29.4
10    10      34.4      30.5
# ℹ 95 more rows</code></pre>
</div>
<div id="extracting-to-polygons-exactextractr-way" class="section level3" number="5.2.4">
<h3>
<span class="header-section-number">5.2.4</span> Extracting to Polygons (<code>exactextractr</code> way)<a class="anchor" aria-label="anchor" href="#extracting-to-polygons-exactextractr-way"><i class="fas fa-link"></i></a>
</h3>
<p><code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract()</a></code> function from the <code>exactextractr</code> package is a faster alternative than <code><a href="https://rdrr.io/pkg/terra/man/extract.html">terra::extract()</a></code> for a large raster data as we confirm later (<code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract()</a></code> does not work with points data at the moment).<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;See &lt;a href="https://github.com/isciences/exactextract"&gt;here&lt;/a&gt; for how it does extraction tasks differently from other major GIS software.&lt;/p&gt;'><sup>79</sup></a> <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract()</a></code> also provides a coverage fraction value for each of the cell-polygon intersections. The syntax of <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract()</a></code> is very much similar to <code><a href="https://rdrr.io/pkg/terra/man/extract.html">terra::extract()</a></code>.</p>
<div class="sourceCode" id="cb489"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#--- syntax (this does not run) ---#</span></span>
<span><span class="fu">exact_extract</span><span class="op">(</span><span class="va">raster</span>, <span class="va">polygons</span><span class="op">)</span></span></code></pre></div>
<p><code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract()</a></code> can accept both <code>SpatRaster</code> and <code>Raster</code><span class="math inline">\(^*\)</span> objects as the raster object. However, while it accepts <code>sf</code> as the polygons object, but it does not accept <code>SpatVect</code>.</p>
<p>Let’s get tmax values from the PRISM raster layer for Kansas county polygons, the following does the job:</p>
<div class="sourceCode" id="cb490"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://isciences.gitlab.io/exactextractr/">"exactextractr"</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- extract values from the raster for each county ---#</span></span>
<span><span class="va">tmax_by_county</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract</a></span><span class="op">(</span></span>
<span>    <span class="va">prism_tmax_0701_KS_sr</span>,</span>
<span>    <span class="va">KS_county_sf</span>,</span>
<span>    <span class="co">#--- this is for not displaying progress bar ---#</span></span>
<span>    progress <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>The resulting object is a list of <code>data.frame</code>s where <strong>i</strong>th element of the list is for <strong>i</strong>th polygon of the polygons <code>sf</code> object.</p>
<div class="sourceCode" id="cb491"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#--- take a look at the first 6 rows of the first two list elements ---#</span></span>
<span><span class="va">tmax_by_county</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>[[1]]
   value coverage_fraction
1 33.348        0.02374719
2 33.259        0.11816581
3 33.248        0.11903353
4 33.222        0.11700913
5 33.215        0.11494034
6 33.147        0.11656883

[[2]]
   value coverage_fraction
1 35.492        0.04248790
2 35.552        0.08910853
3 35.638        0.08570296
4 35.668        0.08580886
5 35.655        0.08667702
6 35.543        0.08706726</code></pre>
<p>For each element of the list, you see <code>value</code> and <code>coverage_fraction</code>. <code>value</code> is the tmax value of the intersecting raster cells, and <code>coverage_fraction</code> is the fraction of the intersecting area relative to the full raster grid, which can help find coverage-weighted summary of the extracted values (like <code>fraction</code> variable when you use <code><a href="https://rdrr.io/pkg/terra/man/extract.html">terra::extract()</a></code> with <code>exact = TRUE</code>).</p>
<p>We can take advantage of <code><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">dplyr::bind_rows()</a></code> to combine the list of the datasets into a single <code>data.frame</code>. In doing so, you can use <code>.id</code> option to create a new identifier column that links each row to its original data.</p>
<div class="sourceCode" id="cb493"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="co">#--- combine ---#</span></span>
<span>  <span class="va">tmax_combined</span> <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span><span class="va">tmax_by_county</span>, .id <span class="op">=</span> <span class="st">"id"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code># A tibble: 15,149 × 3
   id    value coverage_fraction
   &lt;chr&gt; &lt;dbl&gt;             &lt;dbl&gt;
 1 1      33.3            0.0237
 2 1      33.3            0.118 
 3 1      33.2            0.119 
 4 1      33.2            0.117 
 5 1      33.2            0.115 
 6 1      33.1            0.117 
 7 1      33.2            0.117 
 8 1      33.2            0.116 
 9 1      33.1            0.112 
10 1      33.1            0.110 
# ℹ 15,139 more rows</code></pre>
<p><code>data.table</code> users can use <code>rbindlist()</code> with the <code>idcol</code> option like below:</p>
<div class="sourceCode" id="cb495"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">rbindlist</span><span class="op">(</span><span class="va">tmax_by_county</span>, idcol <span class="op">=</span> <span class="st">"id"</span><span class="op">)</span></span></code></pre></div>
<pre><code>        id  value coverage_fraction
    1:   1 33.348        0.02374719
    2:   1 33.259        0.11816581
    3:   1 33.248        0.11903353
    4:   1 33.222        0.11700913
    5:   1 33.215        0.11494034
   ---                             
15145: 105 35.028        0.83252323
15146: 105 35.059        0.83167112
15147: 105 35.111        0.83026636
15148: 105 35.093        0.82874411
15149: 105 35.053        0.28677887</code></pre>
<p>Note that <code>id</code> value of <strong>i</strong> represents <strong>i</strong>th element of the list, which in turn corresponds to <strong>i</strong>th polygon in the polygons sf data. Let’s summarize the data by <code>id</code> and then merge it back to the polygons <code>sf</code> data. Here, we calculate coverage-weighted mean of tmax.</p>
<div class="sourceCode" id="cb497"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#--- weighted mean ---#</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">tmax_by_id</span> <span class="op">&lt;-</span> <span class="va">tmax_combined</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- convert from character to numeric  ---#</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co">#--- group summary ---#</span></span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">summarise</span><span class="op">(</span>tmax_aw <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">value</span> <span class="op">*</span> <span class="va">coverage_fraction</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">coverage_fraction</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code># A tibble: 105 × 2
      id tmax_aw
   &lt;dbl&gt;   &lt;dbl&gt;
 1     1    33.5
 2     2    35.7
 3     3    32.6
 4     4    32.9
 5     5    34.8
 6     6    33.0
 7     7    34.2
 8     8    31.7
 9     9    34.3
10    10    34.4
# ℹ 95 more rows</code></pre>
<div class="sourceCode" id="cb499"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#--- merge ---#</span></span>
<span><span class="va">KS_county_sf</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="va">id</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">.</span>, <span class="va">tmax_by_id</span>, by <span class="op">=</span> <span class="st">"id"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">tmax_aw</span><span class="op">)</span></span></code></pre></div>
<pre><code>Simple feature collection with 105 features and 2 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: -102.0517 ymin: 36.99302 xmax: -94.58841 ymax: 40.00316
Geodetic CRS:  NAD83
First 10 features:
   id  tmax_aw                       geometry
1   1 33.53676 POLYGON ((-98.49007 39.2416...
2   2 35.67419 POLYGON ((-96.72833 39.4271...
3   3 32.59908 POLYGON ((-101.5673 38.4666...
4   4 32.92020 POLYGON ((-99.01535 37.6438...
5   5 34.80511 POLYGON ((-95.3399 40, -95....
6   6 32.98675 POLYGON ((-99.58479 38.3493...
7   7 34.16909 POLYGON ((-100.6526 37.4022...
8   8 31.68179 POLYGON ((-102.0453 38.5054...
9   9 34.32246 POLYGON ((-95.52522 37.7473...
10 10 34.37591 POLYGON ((-97.92865 38.8835...</code></pre>
<hr>
<p>Extracting values from <code>RasterStack</code> works in exactly the same manner as <code>RasterLayer</code>.</p>
<div class="sourceCode" id="cb501"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tmax_by_county_stack</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract</a></span><span class="op">(</span></span>
<span>    <span class="va">prism_tmax_stack</span>,</span>
<span>    <span class="va">KS_county_sf</span>,</span>
<span>    progress <span class="op">=</span> <span class="cn">F</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">#--- take a look at the first 6 lines of the first element---#</span></span>
<span><span class="va">tmax_by_county_stack</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>  PRISM_tmax_stable_4kmD2_20180701_bil PRISM_tmax_stable_4kmD2_20180702_bil
1                               34.235                               29.632
2                               34.228                               29.562
3                               34.222                               29.557
4                               34.256                               29.662
5                               34.268                               29.704
6                               34.262                               29.750
  coverage_fraction
1      0.0007206142
2      0.7114530802
3      0.7162888646
4      0.7163895965
5      0.7166024446
6      0.7175790071</code></pre>
<p>As you can see above, <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract()</a></code> appends additional columns for additional layers.</p>
<div class="sourceCode" id="cb503"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#--- combine them ---#</span></span>
<span><span class="va">tmax_all_combined</span> <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span><span class="va">tmax_by_county_stack</span>, .id <span class="op">=</span> <span class="st">"id"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#--- take a look ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">tmax_all_combined</span><span class="op">)</span></span></code></pre></div>
<pre><code>  id PRISM_tmax_stable_4kmD2_20180701_bil PRISM_tmax_stable_4kmD2_20180702_bil
1  1                               34.235                               29.632
2  1                               34.228                               29.562
3  1                               34.222                               29.557
4  1                               34.256                               29.662
5  1                               34.268                               29.704
6  1                               34.262                               29.750
  coverage_fraction
1      0.0007206142
2      0.7114530802
3      0.7162888646
4      0.7163895965
5      0.7166024446
6      0.7175790071</code></pre>
<p>In order to find the coverage-weighted tmax by date, you can first pivot it to a long format using <code>dplyr::pivot_longer()</code>.</p>
<div class="sourceCode" id="cb505"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#--- pivot to a longer format ---#</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">tmax_long</span> <span class="op">&lt;-</span> <span class="fu">pivot_longer</span><span class="op">(</span></span>
<span>    <span class="va">tmax_all_combined</span>,</span>
<span>    <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">coverage_fraction</span><span class="op">)</span>,</span>
<span>    names_to <span class="op">=</span> <span class="st">"date"</span>,</span>
<span>    values_to <span class="op">=</span> <span class="st">"tmax"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code># A tibble: 30,298 × 4
   id    coverage_fraction date                                  tmax
   &lt;chr&gt;             &lt;dbl&gt; &lt;chr&gt;                                &lt;dbl&gt;
 1 1              0.000721 PRISM_tmax_stable_4kmD2_20180701_bil  34.2
 2 1              0.000721 PRISM_tmax_stable_4kmD2_20180702_bil  29.6
 3 1              0.711    PRISM_tmax_stable_4kmD2_20180701_bil  34.2
 4 1              0.711    PRISM_tmax_stable_4kmD2_20180702_bil  29.6
 5 1              0.716    PRISM_tmax_stable_4kmD2_20180701_bil  34.2
 6 1              0.716    PRISM_tmax_stable_4kmD2_20180702_bil  29.6
 7 1              0.716    PRISM_tmax_stable_4kmD2_20180701_bil  34.3
 8 1              0.716    PRISM_tmax_stable_4kmD2_20180702_bil  29.7
 9 1              0.717    PRISM_tmax_stable_4kmD2_20180701_bil  34.3
10 1              0.717    PRISM_tmax_stable_4kmD2_20180702_bil  29.7
# ℹ 30,288 more rows</code></pre>
<p>And then find coverage-weighted tmax by date:</p>
<div class="sourceCode" id="cb507"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">tmax_long</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">id</span>, <span class="va">date</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">summarize</span><span class="op">(</span>tmax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">tmax</span> <span class="op">*</span> <span class="va">coverage_fraction</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">coverage_fraction</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code># A tibble: 210 × 3
# Groups:   id [105]
   id    date                                  tmax
   &lt;chr&gt; &lt;chr&gt;                                &lt;dbl&gt;
 1 1     PRISM_tmax_stable_4kmD2_20180701_bil  34.2
 2 1     PRISM_tmax_stable_4kmD2_20180702_bil  29.7
 3 10    PRISM_tmax_stable_4kmD2_20180701_bil  33.6
 4 10    PRISM_tmax_stable_4kmD2_20180702_bil  31.2
 5 100   PRISM_tmax_stable_4kmD2_20180701_bil  35.2
 6 100   PRISM_tmax_stable_4kmD2_20180702_bil  29.8
 7 101   PRISM_tmax_stable_4kmD2_20180701_bil  29.9
 8 101   PRISM_tmax_stable_4kmD2_20180702_bil  30.0
 9 102   PRISM_tmax_stable_4kmD2_20180701_bil  33.3
10 102   PRISM_tmax_stable_4kmD2_20180702_bil  30.2
# ℹ 200 more rows</code></pre>
<p>For <code>data.table</code> users, this does the same:</p>
<div class="sourceCode" id="cb509"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">tmax_all_combined</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">data.table</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">melt</span><span class="op">(</span>id.var <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"coverage_fraction"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="va">.</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>tmax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">value</span> <span class="op">*</span> <span class="va">coverage_fraction</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">coverage_fraction</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">id</span>, <span class="va">variable</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code>      id                             variable     tmax
  1:   1 PRISM_tmax_stable_4kmD2_20180701_bil 34.21148
  2:   2 PRISM_tmax_stable_4kmD2_20180701_bil 32.59907
  3:   3 PRISM_tmax_stable_4kmD2_20180701_bil 34.62680
  4:   4 PRISM_tmax_stable_4kmD2_20180701_bil 33.41405
  5:   5 PRISM_tmax_stable_4kmD2_20180701_bil 34.02482
 ---                                                  
206: 101 PRISM_tmax_stable_4kmD2_20180702_bil 30.01027
207: 102 PRISM_tmax_stable_4kmD2_20180702_bil 30.23891
208: 103 PRISM_tmax_stable_4kmD2_20180702_bil 30.16537
209: 104 PRISM_tmax_stable_4kmD2_20180702_bil 30.54567
210: 105 PRISM_tmax_stable_4kmD2_20180702_bil 30.85847</code></pre>
</div>
</div>
<div id="extract-speed" class="section level2" number="5.3">
<h2>
<span class="header-section-number">5.3</span> Extraction speed comparison<a class="anchor" aria-label="anchor" href="#extract-speed"><i class="fas fa-link"></i></a>
</h2>
<p>Here we compare the extraction speed of <code><a href="https://rdrr.io/pkg/terra/man/extract.html">raster::extract()</a></code>, <code><a href="https://rdrr.io/pkg/terra/man/extract.html">terra::extract()</a></code>, and <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract()</a></code>.</p>
<div id="points-terraextract-and-rasterextract" class="section level3" number="5.3.1">
<h3>
<span class="header-section-number">5.3.1</span> Points: <code>terra::extract()</code> and <code>raster::extract()</code><a class="anchor" aria-label="anchor" href="#points-terraextract-and-rasterextract"><i class="fas fa-link"></i></a>
</h3>
<p><code><a href="https://rdrr.io/pkg/terra/man/extract.html">terra::extract()</a></code> uses C++ as the backend. Therefore, it is considerably faster than <code><a href="https://rdrr.io/pkg/terra/man/extract.html">raster::extract()</a></code>.</p>
<div class="sourceCode" id="cb511"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#--- terra ---#</span></span>
<span><span class="va">KS_wells_sv</span> <span class="op">&lt;-</span> <span class="fu">vect</span><span class="op">(</span><span class="va">KS_wells</span><span class="op">)</span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/extract.html">extract</a></span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr</span>, <span class="va">KS_wells_sv</span><span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>0.028 sec elapsed</code></pre>
<div class="sourceCode" id="cb513"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#--- raster ---#</span></span>
<span><span class="va">prism_tmax_0701_KS_lr</span> <span class="op">&lt;-</span> <span class="fu">as</span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr</span>, <span class="st">"Raster"</span><span class="op">)</span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/extract.html">extract</a></span><span class="op">(</span><span class="va">prism_tmax_0701_KS_lr</span>, <span class="va">KS_wells</span><span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>0.11 sec elapsed</code></pre>
<p>As you can see, <code><a href="https://rdrr.io/pkg/terra/man/extract.html">terra::extract()</a></code> is much faster. The time differential between the two packages can be substantial as the raster data becomes larger. Until recently, <code><a href="https://rdrr.io/pkg/terra/man/extract.html">raster::extract()</a></code> was much much slower. However, recent updates to the package made significant improvement in extraction speed.</p>
</div>
<div id="polygons-exact_extract-terraextract-and-rasterextract" class="section level3" number="5.3.2">
<h3>
<span class="header-section-number">5.3.2</span> Polygons: <code>exact_extract()</code>, <code>terra::extract()</code>, and <code>raster::extract()</code><a class="anchor" aria-label="anchor" href="#polygons-exact_extract-terraextract-and-rasterextract"><i class="fas fa-link"></i></a>
</h3>
<p><code><a href="https://rdrr.io/pkg/terra/man/extract.html">terra::extract()</a></code> is faster than <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract()</a></code> for a relatively small raster data. Let’s time them and see the difference.</p>
<div class="sourceCode" id="cb515"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#--- terra::extract ---#</span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">terra_extract_temp</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/extract.html">extract</a></span><span class="op">(</span></span>
<span>    <span class="va">prism_tmax_0701_KS_sr</span>,</span>
<span>    <span class="va">KS_county_sv</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>0.03 sec elapsed</code></pre>
<div class="sourceCode" id="cb517"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#--- exact_extract ---#</span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">exact_extract_temp</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract</a></span><span class="op">(</span></span>
<span>    <span class="va">prism_tmax_0701_KS_sr</span>,</span>
<span>    <span class="va">KS_county_sf</span>,</span>
<span>    progress <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>0.083 sec elapsed</code></pre>
<div class="sourceCode" id="cb519"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#--- raster::extract ---#</span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">raster_extract_temp</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/extract.html">extract</a></span><span class="op">(</span></span>
<span>    <span class="va">prism_tmax_0701_KS_lr</span>,</span>
<span>    <span class="va">KS_county_sf</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>1.032 sec elapsed</code></pre>
<p>As you can see, <code><a href="https://rdrr.io/pkg/terra/man/extract.html">raster::extract()</a></code> is the slowest. <code><a href="https://rdrr.io/pkg/terra/man/extract.html">terra::extract()</a></code> is faster than <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract()</a></code>. However, once the raster data becomes larger (or spatially finer), then <code>exact_extact()</code> starts to shine.</p>
<hr>
<p>Let’s disaggregate the prism data by a factor of 10 to create a much larger raster data.<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;We did not introduce this function as it is very rare that you need this function in research projects.&lt;/p&gt;"><sup>80</sup></a></p>
<div class="sourceCode" id="cb521"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#--- disaggregate ---#</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">prism_tmax_0701_KS_sr_10</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/disaggregate.html">disagg</a></span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr</span>, fact <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code>class       : SpatRaster 
dimensions  : 730, 1790, 1  (nrow, ncol, nlyr)
resolution  : 0.004166667, 0.004166667  (x, y)
extent      : -102.0625, -94.60417, 36.97917, 40.02083  (xmin, xmax, ymin, ymax)
coord. ref. : lon/lat NAD83 
source(s)   : memory
name        : PRISM_tmax_stable_4kmD2_20180701_bil 
min value   :                               27.711 
max value   :                               37.656 </code></pre>
<p>The disaggregated PRISM data now has 10 times more rows and columns.</p>
<div class="sourceCode" id="cb523"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#--- original ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr</span><span class="op">)</span></span></code></pre></div>
<pre><code>[1]  73 179   1</code></pre>
<div class="sourceCode" id="cb525"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#--- disaggregated ---#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr_10</span><span class="op">)</span></span></code></pre></div>
<pre><code>[1]  730 1790    1</code></pre>
<hr>
<p>Now, let’s compare <code>terra::extrct()</code> and <code>exact_extrct()</code> using the disaggregated data.</p>
<div class="sourceCode" id="cb527"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#--- terra extract ---#</span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">terra_extract_temp</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/extract.html">extract</a></span><span class="op">(</span></span>
<span>    <span class="va">prism_tmax_0701_KS_sr_10</span>,</span>
<span>    <span class="va">KS_county_sv</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>2.064 sec elapsed</code></pre>
<div class="sourceCode" id="cb529"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#--- exact extract ---#</span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">exact_extract_temp</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract</a></span><span class="op">(</span></span>
<span>    <span class="va">prism_tmax_0701_KS_sr_10</span>,</span>
<span>    <span class="va">KS_county_sf</span>,</span>
<span>    progress <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>0.164 sec elapsed</code></pre>
<p>As you can see, <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract()</a></code> is considerably faster. The difference in time becomes even more pronounced as the size of the raster data becomes larger and the number of polygons are greater. The time difference of several seconds seem nothing, but imagine processing PRISM files for the entire US over 20 years, then you would appreciate the speed of <code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract()</a></code>.</p>
</div>
<div id="single-layer-vs-multi-layer" class="section level3" number="5.3.3">
<h3>
<span class="header-section-number">5.3.3</span> Single-layer vs multi-layer<a class="anchor" aria-label="anchor" href="#single-layer-vs-multi-layer"><i class="fas fa-link"></i></a>
</h3>
<p>Pretend that you have five dates of PRISM tmax data (here we repeat the same file five times) and would like to extract values from all of them. Extracting values from a multi-layer raster objects (<code>RasterStack</code> for <code>raster</code> package) takes less time than extracting values from the individual layers one at a time. This can be observed below.</p>
<hr>
<p><strong><code><a href="https://rdrr.io/pkg/terra/man/extract.html">terra::extract()</a></code></strong></p>
<div class="sourceCode" id="cb531"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#--- extract from 5 layers one at a time ---#</span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/extract.html">extract</a></span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr_10</span>, <span class="va">KS_county_sv</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/extract.html">extract</a></span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr_10</span>, <span class="va">KS_county_sv</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/extract.html">extract</a></span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr_10</span>, <span class="va">KS_county_sv</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/extract.html">extract</a></span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr_10</span>, <span class="va">KS_county_sv</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/extract.html">extract</a></span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr_10</span>, <span class="va">KS_county_sv</span><span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>11.424 sec elapsed</code></pre>
<div class="sourceCode" id="cb533"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#--- extract from a 5-layer SpatRaster ---#</span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">prism_tmax_ml_5</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="va">prism_tmax_0701_KS_sr_10</span>,</span>
<span>    <span class="va">prism_tmax_0701_KS_sr_10</span>,</span>
<span>    <span class="va">prism_tmax_0701_KS_sr_10</span>,</span>
<span>    <span class="va">prism_tmax_0701_KS_sr_10</span>,</span>
<span>    <span class="va">prism_tmax_0701_KS_sr_10</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/extract.html">extract</a></span><span class="op">(</span><span class="va">prism_tmax_ml_5</span>, <span class="va">KS_county_sv</span><span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>3.082 sec elapsed</code></pre>
<hr>
<p><strong><code><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract()</a></code></strong></p>
<div class="sourceCode" id="cb535"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#--- extract from 5 layers one at a time ---#</span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract</a></span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr_10</span>, <span class="va">KS_county_sf</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract</a></span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr_10</span>, <span class="va">KS_county_sf</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract</a></span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr_10</span>, <span class="va">KS_county_sf</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract</a></span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr_10</span>, <span class="va">KS_county_sf</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract</a></span><span class="op">(</span><span class="va">prism_tmax_0701_KS_sr_10</span>, <span class="va">KS_county_sf</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>0.88 sec elapsed</code></pre>
<div class="sourceCode" id="cb537"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#--- extract from from a 5-layer SpatRaster ---#</span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">prism_tmax_stack_5</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="va">prism_tmax_0701_KS_sr_10</span>,</span>
<span>    <span class="va">prism_tmax_0701_KS_sr_10</span>,</span>
<span>    <span class="va">prism_tmax_0701_KS_sr_10</span>,</span>
<span>    <span class="va">prism_tmax_0701_KS_sr_10</span>,</span>
<span>    <span class="va">prism_tmax_0701_KS_sr_10</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract</a></span><span class="op">(</span></span>
<span>    <span class="va">prism_tmax_stack_5</span>,</span>
<span>    <span class="va">KS_county_sf</span>,</span>
<span>    progress <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>0.269 sec elapsed</code></pre>
<p>The reduction in computation time for both methods makes sense. Since both layers have exactly the same geographic extent and resolution, finding the polygons-cells correspondence is done once and then it can be used repeatedly across the layers for the multi-layer <code>SparRaster</code> and <code>RasterStack</code>. This clearly suggests that when you are processing many layers of the same spatial resolution and extent, you should first stack them and then extract values at the same time instead of processing them one by one as long as your memory allows you to do so.</p>
<!-- There is much more to discuss about the computation speed of raster data extraction for polygons. For those who are interested in this topic, go to Chapter \@ref(EE). -->

</div>
</div>
</div>




  <div class="chapter-nav">
<div class="prev"><a href="raster-basics.html"><span class="header-section-number">4</span> Raster Data Handling</a></div>
<div class="next"><a href="EE.html"><span class="header-section-number">6</span> Extraction Speed Considerations</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#int-RV"><span class="header-section-number">5</span> Spatial Interactions of Vector and Raster Data</a></li>
<li>
<a class="nav-link" href="#before-you-start-4">Before you start</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#direction-for-replication-4">Direction for replication</a></li></ul>
</li>
<li><a class="nav-link" href="#raster-crop"><span class="header-section-number">5.1</span> Cropping to the Area of Interest</a></li>
<li>
<a class="nav-link" href="#extracting-values-from-raster-layers-for-vector-data"><span class="header-section-number">5.2</span> Extracting Values from Raster Layers for Vector Data</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#simple-visual-illustrations-of-raster-data-extraction"><span class="header-section-number">5.2.1</span> Simple visual illustrations of raster data extraction</a></li>
<li><a class="nav-link" href="#extracting-to-points"><span class="header-section-number">5.2.2</span> Extracting to Points</a></li>
<li><a class="nav-link" href="#extracting-to-polygons-terra-way"><span class="header-section-number">5.2.3</span> Extracting to Polygons (terra way)</a></li>
<li><a class="nav-link" href="#extracting-to-polygons-exactextractr-way"><span class="header-section-number">5.2.4</span> Extracting to Polygons (exactextractr way)</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#extract-speed"><span class="header-section-number">5.3</span> Extraction speed comparison</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#points-terraextract-and-rasterextract"><span class="header-section-number">5.3.1</span> Points: terra::extract() and raster::extract()</a></li>
<li><a class="nav-link" href="#polygons-exact_extract-terraextract-and-rasterextract"><span class="header-section-number">5.3.2</span> Polygons: exact_extract(), terra::extract(), and raster::extract()</a></li>
<li><a class="nav-link" href="#single-layer-vs-multi-layer"><span class="header-section-number">5.3.3</span> Single-layer vs multi-layer</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>R as GIS for Economists</strong>" was written by Taro Mieno. It was last built on 2023-09-19.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
