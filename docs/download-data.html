<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 9 Download and process spatial datasets from within R | R as GIS for Economists</title>
<meta name="author" content="Taro Mieno">
<meta name="description" content="Before you start There are many publicly available spatial datasets that can be downloaded using R. Programming data downloading using R instead of manually downloading data from websites can save...">
<meta name="generator" content="bookdown 0.25 with bs4_book()">
<meta property="og:title" content="Chapter 9 Download and process spatial datasets from within R | R as GIS for Economists">
<meta property="og:type" content="book">
<meta property="og:description" content="Before you start There are many publicly available spatial datasets that can be downloaded using R. Programming data downloading using R instead of manually downloading data from websites can save...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 9 Download and process spatial datasets from within R | R as GIS for Economists">
<meta name="twitter:description" content="Before you start There are many publicly available spatial datasets that can be downloaded using R. Programming data downloading using R instead of manually downloading data from websites can save...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><link href="libs/_Lato-0.4.0/font.css" rel="stylesheet">
<link href="libs/_Roboto%20Mono-0.4.0/font.css" rel="stylesheet">
<link href="libs/_Montserrat-0.4.0/font.css" rel="stylesheet">
<script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script><link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet">
<script src="libs/leaflet-1.3.1/leaflet.js"></script><link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet">
<script src="libs/proj4-2.6.2/proj4.min.js"></script><script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script><link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet">
<script src="libs/leaflet-binding-2.1.1/leaflet.js"></script><script src="libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script><script src="libs/leaflet-providers-plugin-2.1.1/leaflet-providers-plugin.js"></script><link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="libs/datatables-binding-0.21/datatables.js"></script><link href="libs/dt-core-1.11.3/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="libs/dt-core-1.11.3/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="libs/dt-core-1.11.3/js/jquery.dataTables.min.js"></script><link href="libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet">
<script src="libs/crosstalk-1.2.0/js/crosstalk.min.js"></script><link href="style.css" rel="stylesheet" type="text/css">
<!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-59758608-3"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-59758608-3');
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
<link rel="stylesheet" href="style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">R as GIS for Economists</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome</a></li>
<li><a class="" href="preface.html">Preface</a></li>
<li class="book-part">Demonstration</li>
<li><a class="" href="demo.html"><span class="header-section-number">1</span> R as GIS: Demonstrations</a></li>
<li class="book-part">Foundations</li>
<li><a class="" href="vector-basics.html"><span class="header-section-number">2</span> Vector Data Handling with sf</a></li>
<li><a class="" href="int-vv.html"><span class="header-section-number">3</span> Spatial Interactions of Vector Data: Subsetting and Joining</a></li>
<li><a class="" href="raster-basics.html"><span class="header-section-number">4</span> Raster Data Handling</a></li>
<li><a class="" href="int-RV.html"><span class="header-section-number">5</span> Spatial Interactions of Vector and Raster Data</a></li>
<li class="book-part">(slightly) Advanced Topics</li>
<li><a class="" href="EE.html"><span class="header-section-number">6</span> Extraction Speed Considerations</a></li>
<li><a class="" href="stars-basics.html"><span class="header-section-number">7</span> Spatiotemporal Raster Data Handling with stars</a></li>
<li class="book-part">Extensions</li>
<li><a class="" href="create-maps.html"><span class="header-section-number">8</span> Creating Maps using ggplot2</a></li>
<li><a class="active" href="download-data.html"><span class="header-section-number">9</span> Download and process spatial datasets from within R</a></li>
<li class="book-part">Appendix</li>
<li><a class="" href="par-comp.html"><span class="header-section-number">A</span> Loop and Parallel Computing</a></li>
<li><a class="" href="ggplot2-minimals.html"><span class="header-section-number">B</span> ggplot2 minimals</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="download-data" class="section level1" number="9">
<h1>
<span class="header-section-number">9</span> Download and process spatial datasets from within R<a class="anchor" aria-label="anchor" href="#download-data"><i class="fas fa-link"></i></a>
</h1>
<div id="before-you-start-8" class="section level2 unnumbered">
<h2>Before you start<a class="anchor" aria-label="anchor" href="#before-you-start-8"><i class="fas fa-link"></i></a>
</h2>
<p>There are many publicly available spatial datasets that can be downloaded using R. Programming data downloading using R instead of manually downloading data from websites can save lots of time and also enhances the reproducibility of your analysis. In this section, we will introduce some of such datasets and show how to download and process those data.</p>
<div id="direction-for-replication-8" class="section level3 unnumbered">
<h3>Direction for replication<a class="anchor" aria-label="anchor" href="#direction-for-replication-8"><i class="fas fa-link"></i></a>
</h3>
<p><strong>Datasets</strong></p>
<p>No datasets to download for this Chapter.</p>
<p><strong>Packages</strong></p>
<ul>
<li>Run the following code to install or load (if already installed) the <code>pacman</code> package, and then install or load (if already installed) the listed package inside the <code><a href="https://rdrr.io/pkg/pacman/man/p_load.html">pacman::p_load()</a></code> function.</li>
</ul>
<div class="sourceCode" id="cb748"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="st"><a href="https://github.com/trinker/pacman">"pacman"</a></span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"pacman"</span><span class="op">)</span>
<span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span>
  <span class="va">stars</span>, <span class="co"># spatiotemporal data handling</span>
  <span class="va">terra</span>, <span class="co"># raster data handling</span>
  <span class="va">raster</span>, <span class="co"># raster data handling</span>
  <span class="va">sf</span>, <span class="co"># vector data handling</span>
  <span class="va">dplyr</span>, <span class="co"># data wrangling</span>
  <span class="va">stringr</span>, <span class="co"># string manipulation</span>
  <span class="va">lubridate</span>, <span class="co"># dates handling</span>
  <span class="va">data.table</span>, <span class="co"># data wrangling</span>
  <span class="va">tidyr</span>, <span class="co"># reshape</span>
  <span class="va">tidyUSDA</span>, <span class="co"># download USDA NASS data</span>
  <span class="va">keyring</span>, <span class="co"># API key management</span>
  <span class="va">FedData</span>, <span class="co"># download Daymet data</span>
  <span class="va">daymetr</span>, <span class="co"># download Daymet data</span>
  <span class="va">ggplot2</span>, <span class="co"># make maps</span>
  <span class="va">tmap</span>, <span class="co"># make maps</span>
  <span class="va">future.apply</span>, <span class="co"># parallel processing</span>
  <span class="va">CropScapeR</span>, <span class="co"># download CDL data</span>
  <span class="va">prism</span>, <span class="co"># download PRISM data</span>
  <span class="va">exactextractr</span> <span class="co"># extract raster values to sf</span>
<span class="op">)</span>  </code></pre></div>
<ul>
<li>Run the following code to define the theme for map:</li>
</ul>
<div class="sourceCode" id="cb749"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/theme_get.html">theme_set</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">theme_for_map</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/theme.html">theme</a></span><span class="op">(</span>
  axis.ticks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
  axis.text<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, 
  axis.line <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
  panel.border <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
  panel.grid.major <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html">element_line</a></span><span class="op">(</span>color<span class="op">=</span><span class="st">'transparent'</span><span class="op">)</span>,
  panel.grid.minor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html">element_line</a></span><span class="op">(</span>color<span class="op">=</span><span class="st">'transparent'</span><span class="op">)</span>,
  panel.background <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
  plot.background <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"transparent"</span>,color<span class="op">=</span><span class="st">'transparent'</span><span class="op">)</span>
<span class="op">)</span>  </code></pre></div>
</div>
</div>
<div id="nass-quick" class="section level2" number="9.1">
<h2>
<span class="header-section-number">9.1</span> USDA NASS QuickStat with <code>tidyUSDA</code><a class="anchor" aria-label="anchor" href="#nass-quick"><i class="fas fa-link"></i></a>
</h2>
<p>There are several packages that lets you download data from the USDA NASS QuickStat. Here we use the <code>tidyUSDA</code> package <span class="citation">(<a href="references.html#ref-tidyUSDA" role="doc-biblioref">Lindblad 2020</a>)</span>. A nice thing about <a href="https://github.com/bradlindblad/tidyUSDA">tidyUSDA</a> is that it gives you an option to download data as an <code>sf</code> object, which means you can immediately visualize the data or spatially interact it with other spatial objects.</p>
<p>First thing you want to do is to get an API key from this <a href="https://quickstats.nass.usda.gov/api">website</a>, which you need to actually download data.</p>
<p>You can download data using <code>getQuickstat()</code>. There are number of options you can use to narrow down the scope of the data you are downloading including <code>data_item</code>, <code>geographic_level</code>, <code>year</code>, <code>commodity</code>, and so on. See its <a href="https://cran.r-project.org/web/packages/tidyUSDA/tidyUSDA.pdf">manual</a> for the full list of parameters you can set. As an example, the code below download corn-related data by county in Illinois for year 2016 as an <code>sf</code> object.</p>
<div class="sourceCode" id="cb750"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="op">(</span>
<span class="va">IL_corn_yield</span> <span class="op">&lt;-</span> 
  <span class="fu">getQuickstat</span><span class="op">(</span>
    <span class="co">#--- put your API key in place of key_get() ---#</span>
    key <span class="op">=</span> <span class="fu">key_get</span><span class="op">(</span><span class="st">"usda_nass_qs_api"</span><span class="op">)</span>,
    program <span class="op">=</span> <span class="st">"SURVEY"</span>,
    commodity <span class="op">=</span> <span class="st">"CORN"</span>,
    geographic_level <span class="op">=</span> <span class="st">"COUNTY"</span>,
    state <span class="op">=</span> <span class="st">"ILLINOIS"</span>,
    year <span class="op">=</span> <span class="st">"2016"</span>,
    geometry <span class="op">=</span> <span class="cn">TRUE</span>
  <span class="op">)</span>  <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
  <span class="co">#--- keep only some of the variables ---#</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/select.html">select</a></span><span class="op">(</span>
    <span class="va">year</span>, <span class="va">county_name</span>, <span class="va">county_code</span>, <span class="va">state_name</span>, 
    <span class="va">state_fips_code</span>, <span class="va">short_desc</span>, <span class="va">Value</span>
  <span class="op">)</span>
<span class="op">)</span></code></pre></div>
<pre><code>Simple feature collection with 384 features and 7 fields (with 16 geometries empty)
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: -91.51308 ymin: 36.9703 xmax: -87.01993 ymax: 42.50848
Geodetic CRS:  NAD83
First 10 features:
   year county_name county_code state_name state_fips_code           short_desc
1  2016      BUREAU         011   ILLINOIS              17 CORN - ACRES PLANTED
2  2016     CARROLL         015   ILLINOIS              17 CORN - ACRES PLANTED
3  2016       HENRY         073   ILLINOIS              17 CORN - ACRES PLANTED
4  2016  JO DAVIESS         085   ILLINOIS              17 CORN - ACRES PLANTED
5  2016         LEE         103   ILLINOIS              17 CORN - ACRES PLANTED
6  2016      MERCER         131   ILLINOIS              17 CORN - ACRES PLANTED
7  2016        OGLE         141   ILLINOIS              17 CORN - ACRES PLANTED
8  2016      PUTNAM         155   ILLINOIS              17 CORN - ACRES PLANTED
9  2016 ROCK ISLAND         161   ILLINOIS              17 CORN - ACRES PLANTED
10 2016  STEPHENSON         177   ILLINOIS              17 CORN - ACRES PLANTED
    Value                       geometry
1  273500 MULTIPOLYGON (((-89.85691 4...
2  147500 MULTIPOLYGON (((-90.16133 4...
3  235000 MULTIPOLYGON (((-90.43247 4...
4  100500 MULTIPOLYGON (((-90.50668 4...
5  258500 MULTIPOLYGON (((-89.63118 4...
6  142500 MULTIPOLYGON (((-90.99255 4...
7  228000 MULTIPOLYGON (((-89.68598 4...
8   37200 MULTIPOLYGON (((-89.33303 4...
9   65000 MULTIPOLYGON (((-90.33573 4...
10 179500 MULTIPOLYGON (((-89.92054 4...</code></pre>
<p>As you can see, it is an <code>sf</code> object with <code>geometry</code> column due to <code>geometry = TRUE</code> option. This means that you can immediately create a map with the data (Figure <a href="download-data.html#fig:corn-yield-IL">9.1</a>):</p>
<div class="sourceCode" id="cb752"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/ggsf.html">geom_sf</a></span><span class="op">(</span>
    data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/filter.html">filter</a></span><span class="op">(</span><span class="va">IL_corn_yield</span>, <span class="va">short_desc</span> <span class="op">==</span> <span class="st">"CORN, GRAIN - YIELD, MEASURED IN BU / ACRE"</span><span class="op">)</span>, 
    <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">Value</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="va">theme_for_map</span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:corn-yield-IL"></span>
<img src="R_GIS_Book_files/figure-html/corn-yield-IL-1.png" alt="Corn Yield (bu/acre) in Illinois in 2016" width="672"><p class="caption">
Figure 9.1: Corn Yield (bu/acre) in Illinois in 2016
</p>
</div>
<p>You can download data for multiple states and years at the same time like below (if you want data for the whole U.S., don’t specify the state parameter).</p>
<div class="sourceCode" id="cb753"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="op">(</span>
<span class="va">IL_CO_NE_corn</span> <span class="op">&lt;-</span> 
  <span class="fu">getQuickstat</span><span class="op">(</span>
    key <span class="op">=</span> <span class="fu">key_get</span><span class="op">(</span><span class="st">"usda_nass_qs_api"</span><span class="op">)</span>,
    program <span class="op">=</span> <span class="st">"SURVEY"</span>,
    commodity <span class="op">=</span> <span class="st">"CORN"</span>,
    geographic_level <span class="op">=</span> <span class="st">"COUNTY"</span>,
    state <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ILLINOIS"</span>, <span class="st">"COLORADO"</span>, <span class="st">"NEBRASKA"</span><span class="op">)</span>,
    year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fl">2014</span><span class="op">:</span><span class="fl">2018</span><span class="op">)</span>,
    geometry <span class="op">=</span> <span class="cn">TRUE</span>
  <span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
  <span class="co">#--- keep only some of the variables ---#</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/select.html">select</a></span><span class="op">(</span>
    <span class="va">year</span>, <span class="va">county_name</span>, <span class="va">county_code</span>, <span class="va">state_name</span>, 
    <span class="va">state_fips_code</span>, <span class="va">short_desc</span>, <span class="va">Value</span>
  <span class="op">)</span>
<span class="op">)</span></code></pre></div>
<pre><code>Simple feature collection with 6384 features and 7 fields (with 588 geometries empty)
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: -109.0459 ymin: 36.9703 xmax: -87.01993 ymax: 43.00171
Geodetic CRS:  NAD83
First 10 features:
   year county_name county_code state_name state_fips_code           short_desc
1  2017     BOULDER         013   COLORADO              08 CORN - ACRES PLANTED
2  2016     BOULDER         013   COLORADO              08 CORN - ACRES PLANTED
3  2016     LARIMER         069   COLORADO              08 CORN - ACRES PLANTED
4  2015     LARIMER         069   COLORADO              08 CORN - ACRES PLANTED
5  2014     LARIMER         069   COLORADO              08 CORN - ACRES PLANTED
6  2015       LOGAN         075   COLORADO              08 CORN - ACRES PLANTED
7  2014       LOGAN         075   COLORADO              08 CORN - ACRES PLANTED
8  2018      MORGAN         087   COLORADO              08 CORN - ACRES PLANTED
9  2017      MORGAN         087   COLORADO              08 CORN - ACRES PLANTED
10 2015      MORGAN         087   COLORADO              08 CORN - ACRES PLANTED
   Value                       geometry
1   3000 MULTIPOLYGON (((-105.6486 4...
2   3300 MULTIPOLYGON (((-105.6486 4...
3  12800 MULTIPOLYGON (((-105.8225 4...
4  14900 MULTIPOLYGON (((-105.8225 4...
5  13600 MULTIPOLYGON (((-105.8225 4...
6  74500 MULTIPOLYGON (((-103.5737 4...
7  86100 MULTIPOLYGON (((-103.5737 4...
8  78300 MULTIPOLYGON (((-103.7148 4...
9  78200 MULTIPOLYGON (((-103.7148 4...
10 60200 MULTIPOLYGON (((-103.7148 4...</code></pre>
<div id="look-for-parameter-values" class="section level3" number="9.1.1">
<h3>
<span class="header-section-number">9.1.1</span> Look for parameter values<a class="anchor" aria-label="anchor" href="#look-for-parameter-values"><i class="fas fa-link"></i></a>
</h3>
<p>This package has a function that lets you see all the possible parameter values you can use for many of these parameters. For example, suppose you know you would like irrigated corn yields in Colorado, but you are not sure what parameter value (string) you should supply to the <code>data_item</code> parameter. Then, you can do this:<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;Of course, you can alternatively go to the QuickStat website and look for the text values.&lt;/p&gt;"><sup>90</sup></a></p>
<div class="sourceCode" id="cb755"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#--- get all the possible values for data_item ---#</span>
<span class="va">all_items</span> <span class="op">&lt;-</span> <span class="fu">tidyUSDA</span><span class="fu">::</span><span class="va"><a href="https://bradlindblad.github.io/tidyusda/reference/allDataItem.html">allDataItem</a></span> 

<span class="co">#--- take a look at the first six ---#</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">all_items</span><span class="op">)</span></code></pre></div>
<pre><code>                                                                           short_desc1 
                                                                     "AG LAND - ACRES" 
                                                                           short_desc2 
                                                      "AG LAND - NUMBER OF OPERATIONS" 
                                                                           short_desc3 
                                                   "AG LAND - OPERATIONS WITH TREATED" 
                                                                           short_desc4 
                                                "AG LAND - TREATED, MEASURED IN ACRES" 
                                                                           short_desc5 
                           "AG LAND, (EXCL CROPLAND &amp; PASTURELAND &amp; WOODLAND) - ACRES" 
                                                                           short_desc6 
"AG LAND, (EXCL CROPLAND &amp; PASTURELAND &amp; WOODLAND) - AREA, MEASURED IN PCT OF AG LAND" </code></pre>
<p>You can use key words like “CORN,” “YIELD,” “IRRIGATED” to narrow the entire list using <code><a href="https://rdrr.io/r/base/grep.html">grep()</a></code><a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;&lt;code&gt;grep()&lt;/code&gt; is part of the base package, and you do not need to install any package to use it.&lt;/p&gt;"><sup>91</sup></a>:</p>
<div class="sourceCode" id="cb757"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">all_items</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"CORN"</span>, <span class="va">.</span>, value <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"YIELD"</span>, <span class="va">.</span>, value <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"IRRIGATED"</span>, <span class="va">.</span>, value <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>  </code></pre></div>
<pre><code>                                                          short_desc9227 
                 "CORN, GRAIN, IRRIGATED - YIELD, MEASURED IN BU / ACRE" 
                                                          short_desc9228 
     "CORN, GRAIN, IRRIGATED - YIELD, MEASURED IN BU / NET PLANTED ACRE" 
                                                          short_desc9233 
    "CORN, GRAIN, IRRIGATED, ENTIRE CROP - YIELD, MEASURED IN BU / ACRE" 
                                                          short_desc9236 
   "CORN, GRAIN, IRRIGATED, NONE OF CROP - YIELD, MEASURED IN BU / ACRE" 
                                                          short_desc9238 
   "CORN, GRAIN, IRRIGATED, PART OF CROP - YIELD, MEASURED IN BU / ACRE" 
                                                          short_desc9249 
             "CORN, GRAIN, NON-IRRIGATED - YIELD, MEASURED IN BU / ACRE" 
                                                          short_desc9250 
 "CORN, GRAIN, NON-IRRIGATED - YIELD, MEASURED IN BU / NET PLANTED ACRE" 
                                                          short_desc9291 
              "CORN, SILAGE, IRRIGATED - YIELD, MEASURED IN TONS / ACRE" 
                                                          short_desc9296 
 "CORN, SILAGE, IRRIGATED, ENTIRE CROP - YIELD, MEASURED IN TONS / ACRE" 
                                                          short_desc9299 
"CORN, SILAGE, IRRIGATED, NONE OF CROP - YIELD, MEASURED IN TONS / ACRE" 
                                                          short_desc9301 
"CORN, SILAGE, IRRIGATED, PART OF CROP - YIELD, MEASURED IN TONS / ACRE" 
                                                          short_desc9307 
          "CORN, SILAGE, NON-IRRIGATED - YIELD, MEASURED IN TONS / ACRE" 
                                                         short_desc28557 
                 "SWEET CORN, IRRIGATED - YIELD, MEASURED IN CWT / ACRE" 
                                                         short_desc28564 
             "SWEET CORN, NON-IRRIGATED - YIELD, MEASURED IN CWT / ACRE" </code></pre>
<p>Looking at the list, we know the exact text value we want, which is the first entry of the vector.</p>
<div class="sourceCode" id="cb759"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="op">(</span>
<span class="va">CO_ir_corn_yield</span> <span class="op">&lt;-</span> 
  <span class="fu">getQuickstat</span><span class="op">(</span>
    key <span class="op">=</span> <span class="fu">key_get</span><span class="op">(</span><span class="st">"usda_nass_qs_api"</span><span class="op">)</span>,
    program <span class="op">=</span> <span class="st">"SURVEY"</span>,
    data_item <span class="op">=</span> <span class="st">"CORN, GRAIN, IRRIGATED - YIELD, MEASURED IN BU / ACRE"</span>,
    geographic_level <span class="op">=</span> <span class="st">"COUNTY"</span>,
    state <span class="op">=</span> <span class="st">"COLORADO"</span>,
    year <span class="op">=</span> <span class="st">"2018"</span>,
    geometry <span class="op">=</span> <span class="cn">TRUE</span>
  <span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
  <span class="co">#--- keep only some of the variables ---#</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/select.html">select</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">NAME</span>, <span class="va">county_code</span>, <span class="va">short_desc</span>, <span class="va">Value</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>Here is the complete list of functions that gives you the possible values of the parameters for <code>getQuickstat()</code>.</p>
<div class="sourceCode" id="cb760"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">tidyUSDA</span><span class="fu">::</span><span class="va"><a href="https://bradlindblad.github.io/tidyusda/reference/allCategory.html">allCategory</a></span> 
<span class="fu">tidyUSDA</span><span class="fu">::</span><span class="va"><a href="https://bradlindblad.github.io/tidyusda/reference/allSector.html">allSector</a></span> 
<span class="fu">tidyUSDA</span><span class="fu">::</span><span class="va"><a href="https://bradlindblad.github.io/tidyusda/reference/allGroup.html">allGroup</a></span> 
<span class="fu">tidyUSDA</span><span class="fu">::</span><span class="va"><a href="https://bradlindblad.github.io/tidyusda/reference/allCommodity.html">allCommodity</a></span> 
<span class="fu">tidyUSDA</span><span class="fu">::</span><span class="va"><a href="https://bradlindblad.github.io/tidyusda/reference/allDomain.html">allDomain</a></span> 
<span class="fu">tidyUSDA</span><span class="fu">::</span><span class="va"><a href="https://bradlindblad.github.io/tidyusda/reference/allCounty.html">allCounty</a></span> 
<span class="fu">tidyUSDA</span><span class="fu">::</span><span class="va"><a href="https://bradlindblad.github.io/tidyusda/reference/allProgram.html">allProgram</a></span> 
<span class="fu">tidyUSDA</span><span class="fu">::</span><span class="va"><a href="https://bradlindblad.github.io/tidyusda/reference/allDataItem.html">allDataItem</a></span> 
<span class="fu">tidyUSDA</span><span class="fu">::</span><span class="va"><a href="https://bradlindblad.github.io/tidyusda/reference/allState.html">allState</a></span> 
<span class="fu">tidyUSDA</span><span class="fu">::</span><span class="va"><a href="https://bradlindblad.github.io/tidyusda/reference/allGeogLevel.html">allGeogLevel</a></span> </code></pre></div>
</div>
<div id="caveats" class="section level3" number="9.1.2">
<h3>
<span class="header-section-number">9.1.2</span> Caveats<a class="anchor" aria-label="anchor" href="#caveats"><i class="fas fa-link"></i></a>
</h3>
<p>You cannot retrieve more than <span class="math inline">\(50,000\)</span> (the limit is set by QuickStat) rows of data. The query below requests much more than <span class="math inline">\(50,000\)</span> observations, and fail. In this case, you need to narrow the search and chop the task into smaller tasks.</p>
<div class="sourceCode" id="cb761"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">many_states_corn</span> <span class="op">&lt;-</span> <span class="fu">getQuickstat</span><span class="op">(</span>
    key <span class="op">=</span> <span class="fu">key_get</span><span class="op">(</span><span class="st">"usda_nass_qs_api"</span><span class="op">)</span>,
    program <span class="op">=</span> <span class="st">"SURVEY"</span>,
    commodity <span class="op">=</span> <span class="st">"CORN"</span>,
    geographic_level <span class="op">=</span> <span class="st">"COUNTY"</span>,
    state <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ILLINOIS"</span>, <span class="st">"COLORADO"</span>, <span class="st">"NEBRASKA"</span>, <span class="st">"IOWA"</span>, <span class="st">"KANSAS"</span><span class="op">)</span>,
    year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fl">1995</span><span class="op">:</span><span class="fl">2018</span><span class="op">)</span>,
    geometry <span class="op">=</span> <span class="cn">TRUE</span>
  <span class="op">)</span> </code></pre></div>
<pre><code>Error in UseMethod("left_join"): no applicable method for 'left_join' applied to an object of class "list"</code></pre>
<p>Another caveat is that the query returns an error when there is no observation that satisfy your query criteria. For example, even though “CORN, GRAIN, IRRIGATED - YIELD, MEASURED IN BU / ACRE” is one of the values you can use for <code>data_item</code>, there is no entry for the statistic in Illinois in 2018. Therefore, the following query fails.</p>
<div class="sourceCode" id="cb763"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">many_states_corn</span> <span class="op">&lt;-</span> 
  <span class="fu">getQuickstat</span><span class="op">(</span>
    key <span class="op">=</span> <span class="fu">key_get</span><span class="op">(</span><span class="st">"usda_nass_qs_api"</span><span class="op">)</span>,
    program <span class="op">=</span> <span class="st">"SURVEY"</span>,
    data_item <span class="op">=</span> <span class="st">"CORN, GRAIN, IRRIGATED - YIELD, MEASURED IN BU / ACRE"</span>,
    geographic_level <span class="op">=</span> <span class="st">"COUNTY"</span>,
    state <span class="op">=</span> <span class="st">"ILLINOIS"</span>,
    year <span class="op">=</span> <span class="st">"2018"</span>,
    geometry <span class="op">=</span> <span class="cn">TRUE</span>
  <span class="op">)</span> </code></pre></div>
<pre><code>Error in UseMethod("left_join"): no applicable method for 'left_join' applied to an object of class "list"</code></pre>
<!-- 
#/*=================================================*/
#' # CDL
#/*=================================================*/
-->
</div>
</div>
<div id="CropScapeR" class="section level2" number="9.2">
<h2>
<span class="header-section-number">9.2</span> CDL with <code>CropScapeR</code><a class="anchor" aria-label="anchor" href="#CropScapeR"><i class="fas fa-link"></i></a>
</h2>
<p>The Cropland Data Layer (CDL) is a data product produced by the National Agricultural Statistics Service of U.S. Department of Agriculture. CDL provides geo-referenced, high accuracy, 30 (after 2007) or 56 (in 2006 and 2007) meter resolution, crop-specific cropland land cover information for up to 48 contiguous states in the U.S. from 1997 to the present. This data product has been extensively used in agricultural research. CropScape is an interactive Web CDL exploring system (<a href="https://nassgeodata.gmu.edu/CropScape/" class="uri">https://nassgeodata.gmu.edu/CropScape/</a>), and it was developed to query, visualize, disseminate, and analyze CDL data geospatially through standard geospatial web services in a publicly accessible on-line environment (Han et al., 2012).</p>
<p>This section shows how to use the <code>CropScapeR</code> package <span class="citation">(<a href="references.html#ref-cropscaper" role="doc-biblioref">Chen 2020</a>)</span> to download and explore the CDL data. The package implements some of the most useful geospatial processing services provided by the CropScape, and it allows users to efficiently process the CDL data within the <code>R</code> environment. Specifically, the <code>CropScapeR</code> package provides four functions that implement different kinds of geospatial processing services provided by the CropScape. This section introduces these functions while providing some examples. <code><a href="https://rdrr.io/pkg/CropScapeR/man/GetCDLData.html">GetCDLData()</a></code> in particular is the most important function as it lets you download the raw CDL data. The other functions provide the users with the CDL data summarized or transformed in particular manners that may suit the need of some users.</p>
<p><strong>Note</strong>: There is a known problem with Mac users requesting CDL data services using the CropScape API, which causes errors when using the functions provided by the package. Please see section <a href="download-data.html#mac-problem">9.2.4</a> for a workaround.</p>
<hr>
<p>The <code>CropScapeR</code> package can be installed directly from ‘CRAN’:</p>
<div class="sourceCode" id="cb765"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"CropScapeR"</span><span class="op">)</span></code></pre></div>
<p>The development version of the package can be downloaded from <a href="https://github.com/cbw1243/CropScapeR">its GitHub website</a> using the following codes:</p>
<div class="sourceCode" id="cb766"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://devtools.r-lib.org/">devtools</a></span><span class="op">)</span>
<span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/devtools/man/remote-reexports.html">install_github</a></span><span class="op">(</span><span class="st">"cbw1243/CropScapeR"</span><span class="op">)</span>  </code></pre></div>
<p>Let’s load the package.</p>
<div class="sourceCode" id="cb767"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">CropScapeR</span><span class="op">)</span>  </code></pre></div>
<hr>
<p>Acknowledgment: The development of the <code>CropScapeR</code> package was supported by USDA-NRCS Agreement No. NR193A750016C001 through the Cooperative Ecosystem Studies Units network. Any opinions, findings, conclusions, or recommendations expressed are those of the author(s) and do not necessarily reflect the view of the U.S. Department of Agriculture.</p>
<div id="getcdldata-download-the-cdl-data-as-raster-data" class="section level3" number="9.2.1">
<h3>
<span class="header-section-number">9.2.1</span> <code>GetCDLData</code>: Download the CDL data as raster data<a class="anchor" aria-label="anchor" href="#getcdldata-download-the-cdl-data-as-raster-data"><i class="fas fa-link"></i></a>
</h3>
<!-- The `GetCDLData` function fetches the cropland land cover data directly from the CDL. This is done in two steps: use the GET function from the httr package to send data requests; then use the `raster` function from the `raster` package to read the requested CDL data (a raster TIF file). 
 -->
<p><code><a href="https://rdrr.io/pkg/CropScapeR/man/GetCDLData.html">GetCDLData()</a></code> allows us to obtain CDL data for any Area of Interest (AOI) in a given year. It requires three parameters to make a valid data request:</p>
<ul>
<li>
<code>aoi</code>: Area of Interest (AOI).<br>
</li>
<li>
<code>year</code>: Year of the data to request.<br>
</li>
<li>
<code>type</code>: Type of AOI.</li>
</ul>
<p>The following AOI-type combinations are accepted:</p>
<ul>
<li>any spatial object as an <code>sf</code> or <code>sfc</code> object - <code>type = "b"</code>
</li>
<li>county (defined by a 5-digit county FIPS code) - <code>type = "f"</code>
</li>
<li>state (defined by a 2-digit state FIPS code) - <code>type = "f"</code>
</li>
<li>bounding box (defined by four corner points) - <code>type = "b"</code>
</li>
<li>polygon area (defined by at least three coordinates) - <code>type = "ps"</code>
</li>
<li>single point (defined by a coordinate) - <code>type = "p"</code>
</li>
</ul>
<p>This section discusses how to download data for an <code>sf</code> object, county, and state as they are likely to be the most common AOI. See the package github site (<a href="https://github.com/cbw1243/CropScapeR" class="uri">https://github.com/cbw1243/CropScapeR</a>) to see how the other options work.</p>
<div id="downloading-cdl-data-for-sf-county-and-state" class="section level4" number="9.2.1.1">
<h4>
<span class="header-section-number">9.2.1.1</span> Downloading CDL data for <code>sf</code>, county, and state<a class="anchor" aria-label="anchor" href="#downloading-cdl-data-for-sf-county-and-state"><i class="fas fa-link"></i></a>
</h4>
<p><strong>Downloading CDL data for <code>sf</code></strong></p>
<p>Let’s download the 2018 CDL data for the area that covers Champaign, Vermilion, Ford, and Iroquois Counties in Illinois (a map below).</p>
<div class="sourceCode" id="cb768"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#--- get the sf for the four counties  ---# </span>
<span class="va">IL_4_county</span> <span class="op">&lt;-</span> <span class="fu">tigris</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tigris/man/counties.html">counties</a></span><span class="op">(</span>state <span class="op">=</span> <span class="st">"IL"</span>, cb <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
  <span class="fu">st_as_sf</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/filter.html">filter</a></span><span class="op">(</span><span class="va">NAME</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Champaign"</span>, <span class="st">"Vermilion"</span>, <span class="st">"Ford"</span>, <span class="st">"Iroquois"</span><span class="op">)</span><span class="op">)</span> </code></pre></div>
<div class="sourceCode" id="cb769"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">IL_county</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">IL_county_4</span>, fill <span class="op">=</span> <span class="st">"lightblue"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="R_GIS_Book_files/figure-html/IL4-map-1.png" width="672"></div>
<p>When you use an <code>sf</code> object for <code>aoi</code>, CDL data will be downloaded for the bounding box (this is why <code>type = "b"</code>) that encompasses the entire geographic area of the <code>sf</code> object irrespective of the type of objects in the <code>sf</code> object (whether they are points, polygons, lines). In this case, CDL data is downloaded for the red area in the map below.</p>
<div class="sourceCode" id="cb770"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">IL_county</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu">st_as_sfc</span><span class="op">(</span><span class="fu">st_bbox</span><span class="op">(</span><span class="va">IL_county_4</span><span class="op">)</span><span class="op">)</span>, fill <span class="op">=</span> <span class="st">"red"</span>, alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span> </code></pre></div>
<div class="inline-figure"><img src="R_GIS_Book_files/figure-html/IL4-aoi-map-1.png" width="672"></div>
<p>Let’s download CDL data for the four counties:</p>
<div class="sourceCode" id="cb771"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="op">(</span>
<span class="va">cdl_IL_4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/CropScapeR/man/GetCDLData.html">GetCDLData</a></span><span class="op">(</span>
  aoi <span class="op">=</span> <span class="va">IL_county_4</span>, 
  year <span class="op">=</span> <span class="st">"2018"</span>, 
  type <span class="op">=</span> <span class="st">"b"</span> 
  <span class="op">)</span>
<span class="op">)</span></code></pre></div>
<pre><code>class      : RasterLayer 
dimensions : 4431, 2826, 12522006  (nrow, ncol, ncell)
resolution : 30, 30  (x, y)
extent     : 631935, 716715, 1898745, 2031675  (xmin, xmax, ymin, ymax)
crs        : +proj=aea +lat_0=23 +lon_0=-96 +lat_1=29.5 +lat_2=45.5 +x_0=0 +y_0=0 +datum=NAD83 +units=m +no_defs 
source     : IL4.tif 
names      : IL4 
values     : 0, 255  (min, max)</code></pre>
<p>As you can see, the downloaded data is a <code>RasterLayer</code> object<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;an object class defined by the &lt;code&gt;raster&lt;/code&gt; package. See &lt;a href="raster-basics.html#raster-basics"&gt;4&lt;/a&gt;.&lt;/p&gt;'><sup>92</sup></a>. Note that the CDL data uses the Albers equal-area conic projection.</p>
<div class="sourceCode" id="cb773"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/crs.html">crs</a></span><span class="op">(</span><span class="va">cdl_IL_4</span><span class="op">)</span> </code></pre></div>
<pre><code>Coordinate Reference System:
Deprecated Proj.4 representation:
 +proj=aea +lat_0=23 +lon_0=-96 +lat_1=29.5 +lat_2=45.5 +x_0=0 +y_0=0
+datum=NAD83 +units=m +no_defs 
WKT2 2019 representation:
PROJCRS["Albers Conical Equal Area",
    BASEGEOGCRS["NAD83",
        DATUM["North American Datum 1983",
            ELLIPSOID["GRS 1980",6378137,298.257222101004,
                LENGTHUNIT["metre",1]]],
        PRIMEM["Greenwich",0,
            ANGLEUNIT["degree",0.0174532925199433]],
        ID["EPSG",4269]],
    CONVERSION["Albers Equal Area",
        METHOD["Albers Equal Area",
            ID["EPSG",9822]],
        PARAMETER["Latitude of false origin",23,
            ANGLEUNIT["degree",0.0174532925199433],
            ID["EPSG",8821]],
        PARAMETER["Longitude of false origin",-96,
            ANGLEUNIT["degree",0.0174532925199433],
            ID["EPSG",8822]],
        PARAMETER["Latitude of 1st standard parallel",29.5,
            ANGLEUNIT["degree",0.0174532925199433],
            ID["EPSG",8823]],
        PARAMETER["Latitude of 2nd standard parallel",45.5,
            ANGLEUNIT["degree",0.0174532925199433],
            ID["EPSG",8824]],
        PARAMETER["Easting at false origin",0,
            LENGTHUNIT["metre",1],
            ID["EPSG",8826]],
        PARAMETER["Northing at false origin",0,
            LENGTHUNIT["metre",1],
            ID["EPSG",8827]]],
    CS[Cartesian,2],
        AXIS["easting",east,
            ORDER[1],
            LENGTHUNIT["metre",1,
                ID["EPSG",9001]]],
        AXIS["northing",north,
            ORDER[2],
            LENGTHUNIT["metre",1,
                ID["EPSG",9001]]]] </code></pre>
<p>Take a look at the downloaded CDL data.</p>
<div class="sourceCode" id="cb775"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">cdl_IL_4</span><span class="op">)</span></code></pre></div>
<p><img src="R_GIS_Book_files/figure-html/plot-IL4-1.png" width="672"><img src="R_GIS_Book_files/figure-html/plot-IL4-2.png" width="672"></p>
<p>If you do not want to have values outside of the <code>sf</code> object, you can use <code><a href="https://rdrr.io/pkg/raster/man/mask.html">raster::mask()</a></code> to turn them into NA as follows:</p>
<div class="sourceCode" id="cb776"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cdl_IL_4_masked</span> <span class="op">&lt;-</span> <span class="va">IL_county_4</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
  <span class="co">#--- change the CRS first to that of the raster data ---#</span>
  <span class="fu">st_transform</span><span class="op">(</span><span class="va">.</span>, <span class="fu">projection</span><span class="op">(</span><span class="va">cdl_IL_4</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
  <span class="co">#--- mask the values outside the sf (turn them into NA) ---#</span>
  <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/mask.html">mask</a></span><span class="op">(</span><span class="va">cdl_IL_4</span>, <span class="va">.</span><span class="op">)</span>  </code></pre></div>
<p>As you can see below, values outside the four counties are now <code>NA</code> (black area):</p>
<div class="sourceCode" id="cb777"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">cdl_IL_4_masked</span><span class="op">)</span></code></pre></div>
<p><img src="R_GIS_Book_files/figure-html/plot-IL4-mask-1.png" width="672"><img src="R_GIS_Book_files/figure-html/plot-IL4-mask-2.png" width="672"></p>
<hr>
<p><strong>Downloading CDL data for county</strong></p>
<p>The following code makes a request to download the CDL data for Champaign county in Illinois in 2018.</p>
<div class="sourceCode" id="cb778"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="op">(</span>
<span class="va">cdl_Champaign</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/CropScapeR/man/GetCDLData.html">GetCDLData</a></span><span class="op">(</span>aoi <span class="op">=</span> <span class="fl">17019</span>, year <span class="op">=</span> <span class="fl">2018</span>, type <span class="op">=</span> <span class="st">'f'</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<pre><code>class      : RasterLayer 
dimensions : 2060, 1626, 3349560  (nrow, ncol, ncell)
resolution : 30, 30  (x, y)
extent     : 633825, 682605, 1898745, 1960545  (xmin, xmax, ymin, ymax)
crs        : +proj=aea +lat_0=23 +lon_0=-96 +lat_1=29.5 +lat_2=45.5 +x_0=0 +y_0=0 +datum=NAD83 +units=m +no_defs 
source     : ch.tif 
names      : ch 
values     : 0, 255  (min, max)</code></pre>
<p>In the above code, the FIPS code for Champaign County (17019) was supplied to the <code>aoi</code> option. Because a county is used here, the <code>type</code> argument is specified as ‘f.’</p>
<div class="sourceCode" id="cb780"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">cdl_Champaign</span><span class="op">)</span> </code></pre></div>
<p><img src="R_GIS_Book_files/figure-html/unnamed-chunk-68-1.png" width="288" style="display: block; margin: auto;"><img src="R_GIS_Book_files/figure-html/unnamed-chunk-68-2.png" width="288" style="display: block; margin: auto;"></p>
<hr>
<p><strong>Downloading CDL data for state</strong></p>
<p>The following code makes a request to download the CDL data for the state of Illinois in 2018.</p>
<div class="sourceCode" id="cb781"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="op">(</span>
<span class="va">cdl_IL</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/CropScapeR/man/GetCDLData.html">GetCDLData</a></span><span class="op">(</span>aoi <span class="op">=</span> <span class="fl">17</span>, year <span class="op">=</span> <span class="fl">2018</span>, type <span class="op">=</span> <span class="st">'f'</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>In the above code, the state FIPS code for Illinois (<span class="math inline">\(17\)</span>) was supplied to the <code>aoi</code> option. Because a county is used here, the <code>type</code> argument is specified as ‘f.’</p>
<div class="sourceCode" id="cb782"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">cdl_IL</span><span class="op">)</span> </code></pre></div>
<p><img src="R_GIS_Book_files/figure-html/unnamed-chunk-71-1.png" width="288" style="display: block; margin: auto;"><img src="R_GIS_Book_files/figure-html/unnamed-chunk-71-2.png" width="288" style="display: block; margin: auto;"></p>
</div>
<div id="other-format-options" class="section level4" number="9.2.1.2">
<h4>
<span class="header-section-number">9.2.1.2</span> Other format options<a class="anchor" aria-label="anchor" href="#other-format-options"><i class="fas fa-link"></i></a>
</h4>
<hr>
<p><strong>GeoTiff</strong></p>
<p>You could save the downloaded CDL data as a tif file by adding <code>save_path =</code> option to <code><a href="https://rdrr.io/pkg/CropScapeR/man/GetCDLData.html">GetCDLData()</a></code> as follows:</p>
<div class="sourceCode" id="cb783"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="op">(</span>
<span class="va">cdl_IL_4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/CropScapeR/man/GetCDLData.html">GetCDLData</a></span><span class="op">(</span>
  aoi <span class="op">=</span> <span class="va">IL_county_4</span>, 
  year <span class="op">=</span> <span class="st">"2018"</span>, 
  type <span class="op">=</span> <span class="st">"b"</span>,
  save_path <span class="op">=</span> <span class="st">"/Data/IL_4.tif"</span>
  <span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>With this code, the downloaded data will be saved as “IL_4.tif” in the “Data” folder residing in the current working directory.</p>
<hr>
<p><strong>sf</strong></p>
<p>The <code>GetCDLData</code> function lets you download CDL data as an <code>sf</code> of points, where the coordinates of the points are the coordinates of the centroid of the raster cells. This can be done by adding <code>format = sf</code> as an option.</p>
<div class="sourceCode" id="cb784"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="op">(</span>
<span class="va">cdl_sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/CropScapeR/man/GetCDLData.html">GetCDLData</a></span><span class="op">(</span>aoi <span class="op">=</span> <span class="fl">17019</span>, year <span class="op">=</span> <span class="fl">2018</span>, type <span class="op">=</span> <span class="st">'f'</span>, format <span class="op">=</span> <span class="st">"sf"</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>The first column (<code>value</code>) is the crop code. Of course, you can manually convert a RasterLayer to an <code>sf</code> of points as follows:</p>
<div class="sourceCode" id="cb785"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">cdl_Champaign</span>, xy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
  <span class="co">#--- to sf consisting of points ---#</span>
  <span class="fu">st_as_sf</span><span class="op">(</span>coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
  <span class="co">#--- Albert conic projection ---#</span>
  <span class="fu">st_set_crs</span><span class="op">(</span><span class="st">"+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"</span><span class="op">)</span>  </code></pre></div>
<pre><code>Simple feature collection with 3349560 features and 1 field
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 633840 ymin: 1898760 xmax: 682590 ymax: 1960530
Projected CRS: SOURCECRS
First 10 features:
   ch               geometry
1   0 POINT (633840 1960530)
2   0 POINT (633870 1960530)
3   0 POINT (633900 1960530)
4   0 POINT (633930 1960530)
5   0 POINT (633960 1960530)
6   0 POINT (633990 1960530)
7   0 POINT (634020 1960530)
8   0 POINT (634050 1960530)
9   0 POINT (634080 1960530)
10  0 POINT (634110 1960530)</code></pre>
<p>The <code>format = sf</code> option makes <code><a href="https://rdrr.io/pkg/CropScapeR/man/GetCDLData.html">GetCDLData()</a></code> do this conversion internally for those who want CDL data as an <code>sf</code> consisting of points instead of a <code>RasterLayer</code>.</p>
</div>
</div>
<div id="data-processing-after-downloading-data" class="section level3" number="9.2.2">
<h3>
<span class="header-section-number">9.2.2</span> Data processing after downloading data<a class="anchor" aria-label="anchor" href="#data-processing-after-downloading-data"><i class="fas fa-link"></i></a>
</h3>
<p>The downloaded raster data itself is not readily usable immediately for your economic analysis. Typically the variable of interest is the frequency of land use types or their shares. You can use <code><a href="https://rdrr.io/pkg/raster/man/freq.html">raster::freq()</a></code> to get the frequency (the number of raster cells) of each land use type.</p>
<div class="sourceCode" id="cb787"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="op">(</span>
<span class="va">crop_freq</span> <span class="op">&lt;-</span> <span class="fu">freq</span><span class="op">(</span><span class="va">cdl_Champaign</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<pre><code>      value   count
 [1,]     0  476477
 [2,]     1 1211343
 [3,]     4      15
 [4,]     5 1173150
 [5,]    23       8
 [6,]    24    8869
 [7,]    26    1168
 [8,]    27      34
 [9,]    28      52
[10,]    36    4418
[11,]    37    6804
[12,]    43       2
[13,]    59    1064
[14,]    60      79
[15,]    61      54
[16,]   111    6112
[17,]   121  111191
[18,]   122  155744
[19,]   123   38898
[20,]   124   12232
[21,]   131    1333
[22,]   141   49012
[23,]   142      15
[24,]   143       7
[25,]   152      77
[26,]   176   84463
[27,]   190    6545
[28,]   195     339
[29,]   222       1
[30,]   229      16
[31,]   241      38</code></pre>
<p>Clearly, once frequencies are found, you can easily get shares as well:</p>
<div class="sourceCode" id="cb789"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="op">(</span>
<span class="va">crop_data</span> <span class="op">&lt;-</span><span class="va">crop_freq</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
  <span class="co">#--- matrix to data.frame ---#</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
  <span class="co">#--- find share ---#</span>
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/mutate.html">mutate</a></span><span class="op">(</span>share <span class="op">=</span> <span class="va">count</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">count</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<pre><code>   value   count        share
1      0  476477 1.422506e-01
2      1 1211343 3.616424e-01
3      4      15 4.478200e-06
4      5 1173150 3.502400e-01
5     23       8 2.388373e-06
6     24    8869 2.647810e-03
7     26    1168 3.487025e-04
8     27      34 1.015059e-05
9     28      52 1.552443e-05
10    36    4418 1.318979e-03
11    37    6804 2.031312e-03
12    43       2 5.970933e-07
13    59    1064 3.176537e-04
14    60      79 2.358519e-05
15    61      54 1.612152e-05
16   111    6112 1.824717e-03
17   121  111191 3.319570e-02
18   122  155744 4.649685e-02
19   123   38898 1.161287e-02
20   124   12232 3.651823e-03
21   131    1333 3.979627e-04
22   141   49012 1.463237e-02
23   142      15 4.478200e-06
24   143       7 2.089827e-06
25   152      77 2.298809e-05
26   176   84463 2.521615e-02
27   190    6545 1.953988e-03
28   195     339 1.012073e-04
29   222       1 2.985467e-07
30   229      16 4.776747e-06
31   241      38 1.134477e-05</code></pre>
<p>At this point, the data does not tell you which value corresponds to which crop. To find the crop names associated with the crop codes (<code>value</code>), you can get the reference table using <code>data(linkdata)</code> from the <code>CropScapeR</code> package.<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;Alternatively, you can download the reference table (a EXCEL file) at &lt;a href="https://www.nass.usda.gov/Research_and_Science/Cropland/docs/cdl_codes_names.xlsx" class="uri"&gt;https://www.nass.usda.gov/Research_and_Science/Cropland/docs/cdl_codes_names.xlsx&lt;/a&gt;.&lt;/p&gt;'><sup>93</sup></a></p>
<div class="sourceCode" id="cb791"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#--- load the crop code reference data ---#</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"linkdata"</span><span class="op">)</span></code></pre></div>
<div id="htmlwidget-0d98b3a7dfd8c0043610" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-0d98b3a7dfd8c0043610">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56","57","58","59","60","61","62","63","64","65","66","67","68","69","70","71","72","73","74","75","76","77","78","79","80","81","82","83","84","85","86","87","88","89","90","91","92","93","94","95","96","97","98","99","100","101","102","103","104","105","106","107","108","109","110","111","112","113","114","115","116","117","118","119","120","121","122","123","124","125","126","127","128","129","130","131","132","133","134","135","136","137","138","139","140","141","142","143","144","145","146","147","148","149","150","151","152","153","154","155","156","157","158","159","160","161","162","163","164","165","166","167","168","169","170","171","172","173","174","175","176","177","178","179","180","181","182","183","184","185","186","187","188","189","190","191","192","193","194","195","196","197","198","199","200","201","202","203","204","205","206","207","208","209","210","211","212","213","214","215","216","217","218","219","220","221","222","223","224","225","226","227","228","229","230","231","232","233","234","235","236","237","238","239","240","241","242","243","244","245","246","247","248","249","250","251","252","253","254","255","256"],[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255],["NoData","Corn","Cotton","Rice","Sorghum","Soybeans","Sunflower","","","","Peanuts","Tobacco","Sweet_Corn","Pop_or_Orn_Corn","Mint","","","","","","","Barley","Durum_Wheat","Spring_Wheat","Winter_Wheat","Other_Small_Grains","Dbl_Crop_WinWht/Soybeans","Rye","Oats","Millet","Speltz","Canola","Flaxseed","Safflower","Rape_Seed","Mustard","Alfalfa","Other_Hay/Non_Alfalfa","Camelina","Buckwheat","","Sugarbeets","Dry_Beans","Potatoes","Other_Crops","Sugarcane","Sweet_Potatoes","Misc_Vegs_&amp;_Fruits","Watermelons","Onions","Cucumbers","Chick_Peas","Lentils","Peas","Tomatoes","Caneberries","Hops","Herbs","Clover/Wildflowers","Sod/Grass_Seed","Switchgrass","Fallow/Idle_Cropland","","Forest","Shrubland","Barren","Cherries","Peaches","Apples","Grapes","Christmas_Trees","Other_Tree_Crops","Citrus","","Pecans","Almonds","Walnuts","Pears","","","","Clouds/No_Data","Developed","Water","","","","Wetlands","Nonag/Undefined","","","","Aquaculture","","","","","","","","","","","","","","","","","","","Open_Water","Perennial_Ice/Snow_","","","","","","","","","Developed/Open_Space","Developed/Low_Intensity","Developed/Med_Intensity","Developed/High_Intensity","","","","","","","Barren","","","","","","","","","","Deciduous_Forest","Evergreen_Forest","Mixed_Forest","","","","","","","","","Shrubland","","","","","","","","","","","","","","","","","","","","","","","","Grassland/Pasture","","","","","","","","","","","","","","Woody_Wetlands","","","","","Herbaceous_Wetlands","","","","","","","","","Pistachios","Triticale","Carrots","Asparagus","Garlic","Cantaloupes","Prunes","Olives","Oranges","Honeydew_Melons","Broccoli","","Peppers","Pomegranates","Nectarines","Greens","Plums","Strawberries","Squash","Apricots","Vetch","Dbl_Crop_WinWht/Corn","Dbl_Crop_Oats/Corn","Lettuce","","Pumpkins","Dbl_Crop_Lettuce/Durum_Wht","Dbl_Crop_Lettuce/Cantaloupe","Dbl_Crop_Lettuce/Cotton","Dbl_Crop_Lettuce/Barley","Dbl_Crop_Durum_Wht/Sorghum","Dbl_Crop_Barley/Sorghum","Dbl_Crop_WinWht/Sorghum","Dbl_Crop_Barley/Corn","Dbl_Crop_WinWht/Cotton","Dbl_Crop_Soybeans/Cotton","Dbl_Crop_Soybeans/Oats","Dbl_Crop_Corn/Soybeans","Blueberries","Cabbage","Cauliflower","Celery","Radishes","Turnips","Eggplants","Gourds","Cranberries","","","","Dbl_Crop_Barley/Soybeans",""]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>MasterCat<\/th>\n      <th>Crop<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":1},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script><p>You can merge the two data sets using <code>value</code> from the CDL data and <code>MasterCat</code> from <code>linkdata</code> as the merging keys:</p>
<div class="sourceCode" id="cb792"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="op">(</span>
<span class="va">crop_data</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">crop_data</span>, <span class="va">linkdata</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'value'</span> <span class="op">=</span> <span class="st">'MasterCat'</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<pre><code>   value   count        share                     Crop
1      0  476477 1.422506e-01                   NoData
2      1 1211343 3.616424e-01                     Corn
3      4      15 4.478200e-06                  Sorghum
4      5 1173150 3.502400e-01                 Soybeans
5     23       8 2.388373e-06             Spring_Wheat
6     24    8869 2.647810e-03             Winter_Wheat
7     26    1168 3.487025e-04 Dbl_Crop_WinWht/Soybeans
8     27      34 1.015059e-05                      Rye
9     28      52 1.552443e-05                     Oats
10    36    4418 1.318979e-03                  Alfalfa
11    37    6804 2.031312e-03    Other_Hay/Non_Alfalfa
12    43       2 5.970933e-07                 Potatoes
13    59    1064 3.176537e-04           Sod/Grass_Seed
14    60      79 2.358519e-05              Switchgrass
15    61      54 1.612152e-05     Fallow/Idle_Cropland
16   111    6112 1.824717e-03               Open_Water
17   121  111191 3.319570e-02     Developed/Open_Space
18   122  155744 4.649685e-02  Developed/Low_Intensity
19   123   38898 1.161287e-02  Developed/Med_Intensity
20   124   12232 3.651823e-03 Developed/High_Intensity
21   131    1333 3.979627e-04                   Barren
22   141   49012 1.463237e-02         Deciduous_Forest
23   142      15 4.478200e-06         Evergreen_Forest
24   143       7 2.089827e-06             Mixed_Forest
25   152      77 2.298809e-05                Shrubland
26   176   84463 2.521615e-02        Grassland/Pasture
27   190    6545 1.953988e-03           Woody_Wetlands
28   195     339 1.012073e-04      Herbaceous_Wetlands
29   222       1 2.985467e-07                   Squash
30   229      16 4.776747e-06                 Pumpkins
31   241      38 1.134477e-05   Dbl_Crop_Corn/Soybeans</code></pre>
<p><code>NoData</code> in <code>Crop</code> corresponds to the black area in the above figure, which is the portion of the raster data that does not overlap with the boundary of Champaign County. These points with <code>NoData</code> can be removed by using the <code>filter</code> function.</p>
</div>
<div id="other-forms-of-cdl-data" class="section level3" number="9.2.3">
<h3>
<span class="header-section-number">9.2.3</span> Other forms of CDL data<a class="anchor" aria-label="anchor" href="#other-forms-of-cdl-data"><i class="fas fa-link"></i></a>
</h3>
<p>Instead of downloading the raw CDL data, CropScape provides an option to download summarized CDL data.</p>
<ul>
<li>
<code>GetCDLComp</code>: request data on land use changes</li>
<li>
<code>GetCDLStat</code>: get acreage estimates from the CDL</li>
<li>
<code>GetCDLImage</code>: download the image files of the CDL data</li>
</ul>
<p>These may come handy if they satisfy your needs because you can skip post-downloading processing steps.</p>
<hr>
<p><strong><code><a href="https://rdrr.io/pkg/CropScapeR/man/GetCDLComp.html">GetCDLComp()</a></code></strong>: request data on land use changes</p>
<p>The <code>GetCDLComp</code> function allows users to request data on changes in land cover over time from the CDL. Specifically, this function returns acres changed from one crop category to another crop category between two years for a user-defined AOI.</p>
<p>Let’s see an example. The following codes request data on acreage changes in land cover for Champaign County (FIPS = 17019) from 2017 (<code>year1 = 2017</code>) to 2018 (<code>year2 = 2018</code>).</p>
<div class="sourceCode" id="cb794"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="op">(</span>
<span class="va">data_change</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/CropScapeR/man/GetCDLComp.html">GetCDLComp</a></span><span class="op">(</span>aoi <span class="op">=</span> <span class="st">'17019'</span>, year1 <span class="op">=</span> <span class="fl">2017</span>, year2 <span class="op">=</span> <span class="fl">2018</span>, type <span class="op">=</span> <span class="st">'f'</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<pre><code>                     From                       To   Count  Acreage   aoi
  1:                 Corn                     Corn  181490  40362.4 17019
  2:                 Corn                  Sorghum       1      0.2 17019
  3:                 Corn                 Soybeans 1081442 240506.9 17019
  4:                 Corn             Winter Wheat    1950    433.7 17019
  5:                 Corn Dbl Crop WinWht/Soybeans     110     24.5 17019
 ---                                                                     
241:  Herbaceous Wetlands      Herbaceous Wetlands      18      4.0 17019
242: Dbl Crop WinWht/Corn                     Corn       1      0.2 17019
243:             Pumpkins                     Corn      69     15.3 17019
244:             Pumpkins                  Sorghum       2      0.4 17019
245:             Pumpkins                 Soybeans      62     13.8 17019</code></pre>
<p>What is returned is a <code>data.frame</code> (<code>data.table</code>) that has 5 columns. The columns “From” and “To” are crop names. The column “Count” is the pixel count, and “Acreage” is the acres corresponding to the pixel counts. The last column “aoi” is the selected AOI. The first row of the returned data table shows the acreage (i.e., 40,362 acres) of continuous corn during 2017 and 2018. The third row shows the acreage (i.e., 240,506 acres) rotated from corn to soybeans during 2017 and 2018.</p>
<p>Remember that the spatial resolution changes from 56 meters to 30 meters starting 2008. This means that when data is requested for land use changes from 2007 to 2008, two CDL raster layers have different spatial resolutions. Consequently, CropScape API fails to resolve the issue and return an error message saying “Mismatch size of file 1 and file 2.” The <code><a href="https://rdrr.io/pkg/CropScapeR/man/GetCDLComp.html">GetCDLComp()</a></code> function manually resolves this problem by resampling two CDL raster files using the nearest neighbor resampling technique such that both rasters have the same spatial resolutions. The finer resolution raster is downscaled to the lower resolution. Then, the resampled raster layers are merged together to calculate cropland changes. Users can turn off this default behavior by adding <code>manual_try = FALSE</code> option. In this case, an error message from CropScape API will be returned with no land use changes results.</p>
<div class="sourceCode" id="cb796"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data_change</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/CropScapeR/man/GetCDLComp.html">GetCDLComp</a></span><span class="op">(</span>aoi <span class="op">=</span> <span class="st">'17019'</span>, year1 <span class="op">=</span> <span class="fl">2007</span>, year2 <span class="op">=</span> <span class="fl">2008</span>, type <span class="op">=</span> <span class="st">'f'</span>, `manual_try` <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> </code></pre></div>
<pre><code>Error in GetCDLCompF(fips = aoi, year1 = year1, year2 = year2, mat = mat, : Error: The requested data might not exist in the CDL database. 
Error message from CropScape is :&lt;faultstring&gt;Error: Mismatch size of file 1 and file 2.
&lt;/faultstring&gt;</code></pre>
<hr>
<p><strong><code><a href="https://rdrr.io/pkg/CropScapeR/man/GetCDLStat.html">GetCDLStat()</a></code></strong>: get acreage estimates from the CDL</p>
<p>The <code>GetCDLStat</code> function allows users to get acreage by land cover category for a user defined AOI in a year. For example, the following codes request data on acreage by land cover categories for Champaign County in Illinois in 2018. You can see that the pixel counts are already converted to acres and category names are attached.</p>
<div class="sourceCode" id="cb798"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="op">(</span>
<span class="va">data_stat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/CropScapeR/man/GetCDLStat.html">GetCDLStat</a></span><span class="op">(</span>aoi <span class="op">=</span> <span class="fl">17019</span>, year <span class="op">=</span> <span class="fl">2018</span>, type <span class="op">=</span> <span class="st">'f'</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<pre><code>    Value                   Category  Acreage
 1:     1                       Corn 269396.2
 2:     4                    Sorghum      3.3
 3:     5                   Soybeans 260902.3
 4:    23               Spring Wheat      1.8
 5:    24               Winter Wheat   1972.4
 6:    26   Dbl Crop WinWht/Soybeans    259.8
 7:    27                        Rye      7.6
 8:    28                       Oats     11.6
 9:    36                    Alfalfa    982.5
10:    37      Other Hay/Non Alfalfa   1513.2
11:    43                   Potatoes      0.4
12:    59             Sod/Grass Seed    236.6
13:    60                Switchgrass     17.6
14:    61       Fallow/Idle Cropland     12.0
15:   111                 Open Water   1359.3
16:   121       Developed/Open Space  24728.3
17:   122    Developed/Low Intensity  34636.6
18:   123 Developed/Medium Intensity   8650.7
19:   124   Developed/High Intensity   2720.3
20:   131                     Barren    296.5
21:   141           Deciduous Forest  10900.0
22:   142           Evergreen Forest      3.3
23:   143               Mixed Forest      1.6
24:   152                  Shrubland     17.1
25:   176              Grass/Pasture  18784.1
26:   190             Woody Wetlands   1455.6
27:   195        Herbaceous Wetlands     75.4
28:   222                     Squash      0.2
29:   229                   Pumpkins      3.6
30:   241     Dbl Crop Corn/Soybeans      8.5
    Value                   Category  Acreage</code></pre>
<hr>
<p><strong><code><a href="https://rdrr.io/pkg/CropScapeR/man/GetCDLImage.html">GetCDLImage()</a></code></strong>: Download the image files of the CDL data
The <code>GetCDLImage</code> function allows users to download the image files of the CDL data. This function is very similar to the <code>GetCDLData</code> function, except that image files are returned. This function can be helpful if you only want to look at the picture of the CDL data. By default, the picture is saved as the ‘png’ format. You can also save it in the ‘kml’ format.</p>
<div class="sourceCode" id="cb800"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/CropScapeR/man/GetCDLImage.html">GetCDLImage</a></span><span class="op">(</span>aoi <span class="op">=</span> <span class="fl">17019</span>, year <span class="op">=</span> <span class="fl">2018</span>, type <span class="op">=</span> <span class="st">'f'</span>, verbose <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></code></pre></div>
</div>
<div id="mac-problem" class="section level3" number="9.2.4">
<h3>
<span class="header-section-number">9.2.4</span> SSL certificate problem on Mac<a class="anchor" aria-label="anchor" href="#mac-problem"><i class="fas fa-link"></i></a>
</h3>
<p>SSL refers to the Secure Sockets Layer, and SSL certificate displays important information for verifying the owner of a website and encrypting web traffic with SSL/TLS for securing connection. It is a known problem that Mac users encounter the following error when <code><a href="https://rdrr.io/pkg/CropScapeR/man/GetCDLData.html">GetCDLData()</a></code> is used: ‘SSL certificate problem: SSL certificate expired.’ As the name suggests, this is because the CropScape server has an expired certificate. While this affects the Mac users, Windows users should not expect this issue.</p>
<p>To avoid the problem for Mac users, the <code>CropScapeR</code> has a workaround that involves downloading the GeoTiff file for the requested AOI first, and then read the file using the <code>raster()</code> function as a <code>RasterLayer</code>.<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;Specifically, at step 1, specify in &lt;code&gt;R&lt;/code&gt; that you want to skip the certificate validation when making the httr GET request. At step 2, download the raster TIF data into your local drive using the &lt;code&gt;download.file&lt;/code&gt; function with &lt;code&gt;wget&lt;/code&gt;, and then read the downloaded raster file using the &lt;code&gt;raster&lt;/code&gt; function.&lt;/p&gt;"><sup>94</sup></a></p>
<p>You first need to run the following code before requesting data from CDL.</p>
<div class="sourceCode" id="cb801"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#--- Skip the SSL check ---#</span>
<span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/httr/man/set_config.html">set_config</a></span><span class="op">(</span><span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/httr/man/config.html">config</a></span><span class="op">(</span>ssl_verifypeer <span class="op">=</span> <span class="fl">0L</span><span class="op">)</span><span class="op">)</span> </code></pre></div>
<p>Now, you can download CDL data by specifying the file path with the <code>save_path</code> option like below:</p>
<div class="sourceCode" id="cb802"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#--- Download the raster TIF file into specified path, also read into R ---#</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/CropScapeR/man/GetCDLData.html">GetCDLData</a></span><span class="op">(</span>aoi <span class="op">=</span> <span class="fl">17019</span>, year <span class="op">=</span> <span class="fl">2018</span>, type <span class="op">=</span> <span class="st">'f'</span>, save_path <span class="op">=</span> <span class="st">"ch.tif"</span><span class="op">)</span></code></pre></div>
<p>Hopefully, this problem is fixed by the maintainer of CropScape so that this workaround is not necessary for Mac users.</p>
<!-- ### An example: parallelized processing of CDL data -->
<!-- 
#/*=================================================*/
#' # PRISM
#/*=================================================*/
-->
</div>
</div>
<div id="download-prism" class="section level2" number="9.3">
<h2>
<span class="header-section-number">9.3</span> PRISM with <code>prism</code><a class="anchor" aria-label="anchor" href="#download-prism"><i class="fas fa-link"></i></a>
</h2>
<div id="basics" class="section level3" number="9.3.1">
<h3>
<span class="header-section-number">9.3.1</span> Basics<a class="anchor" aria-label="anchor" href="#basics"><i class="fas fa-link"></i></a>
</h3>
<p><a href="https://prism.oregonstate.edu/">PRISM dataset</a> provide model-based estimates of precipitation, tmax, and tmin for the U.S. at the 4km by 4km spatial resolution. Here, we use <code>get_prism_dailys()</code> from the <code>prism</code> package <span class="citation">(<a href="references.html#ref-prism" role="doc-biblioref">Hart and Bell 2015</a>)</span> to download daily data. Here is its general syntax:</p>
<div class="sourceCode" id="cb803"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb803-1"><a href="download-data.html#cb803-1" aria-hidden="true" tabindex="-1"></a><span class="co">#--- NOT RUN ---#</span></span>
<span id="cb803-2"><a href="download-data.html#cb803-2" aria-hidden="true" tabindex="-1"></a><span class="fu">get_prism_dailys</span>(</span>
<span id="cb803-3"><a href="download-data.html#cb803-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> variable type,</span>
<span id="cb803-4"><a href="download-data.html#cb803-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">minDate =</span> starting date as character,</span>
<span id="cb803-5"><a href="download-data.html#cb803-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">maxDate =</span> ending date as character,</span>
<span id="cb803-6"><a href="download-data.html#cb803-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">keepZip =</span> <span class="cn">TRUE</span> or <span class="cn">FALSE</span></span>
<span id="cb803-7"><a href="download-data.html#cb803-7" aria-hidden="true" tabindex="-1"></a>) </span></code></pre></div>
<p>The variables types you can select from is “ppt” (precipitation), “tmean” (mean temperature), “tmin” (minimum temperature), and “tmax” (maximum temperature). For <code>minDate</code> and <code>maxDate</code>, the dates must be specified in a specific format of “YYYY-MM-DD.” <code>keepZip = FALSE</code> does not keep the zipped folders of the downloaded files as the name suggests.</p>
<p>Before you download PRISM data using the function, it is recommended that you set the path to folder in which the downloaded PRISM will be stored using <code>options(prism.path = "path")</code>. For example, the following set the path to “Data/PRISM/” relative to the current working directory.</p>
<div class="sourceCode" id="cb804"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>prism.path <span class="op">=</span> <span class="st">"Data/PRISM/"</span><span class="op">)</span></code></pre></div>
<p>The following code downloads daily precipitation data from January 1, 2000 to Jan 10, 2000.</p>
<div class="sourceCode" id="cb805"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#--- NOT RUN ---#</span>
<span class="fu">get_prism_dailys</span><span class="op">(</span>
  type <span class="op">=</span> <span class="st">"ppt"</span>,
  minDate <span class="op">=</span> <span class="st">"2000-01-01"</span>,
  maxDate <span class="op">=</span> <span class="st">"2000-01-10"</span>,
  keepZip <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">)</span> </code></pre></div>
<p>When you download data using the above code, you will notice that it creates one folder for one day. For example, for precipitation data for “2000-01-01,” you can get the path to the downloaded file as follows:</p>
<div class="sourceCode" id="cb806"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">var_type</span> <span class="op">&lt;-</span> <span class="st">"ppt"</span> <span class="co"># variable type</span>
<span class="va">dates_prism_txt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/stringr/man/str_remove.html">str_remove_all</a></span><span class="op">(</span><span class="st">"2000-01-01"</span>, <span class="st">"-"</span><span class="op">)</span> <span class="co"># date without dashes</span>

<span class="co">#--- folder name ---#</span>
<span class="va">folder_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"PRISM_"</span>, <span class="va">var_type</span>, <span class="st">"_stable_4kmD2_"</span>, <span class="va">dates_prism_txt</span>, <span class="st">"_bil"</span><span class="op">)</span> 

<span class="co">#--- file name of the downloaded data inside the above folder ---#</span>
<span class="va">file_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"PRISM_"</span>, <span class="va">var_type</span>, <span class="st">"_stable_4kmD2_"</span>, <span class="va">dates_prism_txt</span>, <span class="st">"_bil.bil"</span><span class="op">)</span> 

<span class="co">#--- path to the file relative to the designated data folder (here, it's "Data/PRISM/") ---#</span>
<span class="op">(</span>
<span class="va">file_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Data/PRISM/"</span>, <span class="va">folder_name</span>, <span class="st">"/"</span>, <span class="va">file_name</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<pre><code>[1] "Data/PRISM/PRISM_ppt_stable_4kmD2_20000101_bil/PRISM_ppt_stable_4kmD2_20000101_bil.bil"</code></pre>
<p>We can then easily read the data using <code><a href="https://rdrr.io/pkg/terra/man/rast.html">terra::rast()</a></code> or <code><a href="https://r-spatial.github.io/stars/reference/read_stars.html">stars::read_stars()</a></code> if you prefer the <code>stars</code> way.</p>
<div class="sourceCode" id="cb808"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#--- as SpatRaster ---#</span>
<span class="op">(</span>
<span class="va">prism_2000_01_01_sr</span> <span class="op">&lt;-</span> <span class="fu">rast</span><span class="op">(</span><span class="va">file_path</span><span class="op">)</span> 
<span class="op">)</span></code></pre></div>
<pre><code>class       : SpatRaster 
dimensions  : 621, 1405, 1  (nrow, ncol, nlyr)
resolution  : 0.04166667, 0.04166667  (x, y)
extent      : -125.0208, -66.47917, 24.0625, 49.9375  (xmin, xmax, ymin, ymax)
coord. ref. : lon/lat NAD83 
source      : PRISM_ppt_stable_4kmD2_20000101_bil.bil 
name        : PRISM_ppt_stable_4kmD2_20000101_bil 
min value   :                                   0 
max value   :                              49.848 </code></pre>
<div class="sourceCode" id="cb810"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#--- as stars ---#</span>
<span class="op">(</span>
<span class="va">prism_2000_01_01_stars</span> <span class="op">&lt;-</span> <span class="fu">read_stars</span><span class="op">(</span><span class="va">file_path</span><span class="op">)</span> 
<span class="op">)</span></code></pre></div>
<pre><code>stars object with 2 dimensions and 1 attribute
attribute(s):
                                   Min. 1st Qu. Median      Mean 3rd Qu.   Max.
PRISM_ppt_stable_4kmD2_2000010...     0       0      0 0.4952114       0 49.848
                                     NA's
PRISM_ppt_stable_4kmD2_2000010...  390874
dimension(s):
  from   to   offset      delta refsys point values x/y
x    1 1405 -125.021  0.0416667  NAD83    NA   NULL [x]
y    1  621  49.9375 -0.0416667  NAD83    NA   NULL [y]</code></pre>
<p>Here is a quick visualization of the data (Figure <a href="download-data.html#fig:quick-viz">9.2</a>):</p>
<div class="sourceCode" id="cb812"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">prism_2000_01_01_stars</span><span class="op">)</span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:quick-viz"></span>
<img src="R_GIS_Book_files/figure-html/quick-viz-1.png" alt="PRISM precipitation data for January 1, 2000" width="672"><p class="caption">
Figure 9.2: PRISM precipitation data for January 1, 2000
</p>
</div>
<p>As you can see, the data covers the entire contiguous U.S.</p>
</div>
<div id="download-daily-prism-data-for-many-years-and-build-your-own-datasets" class="section level3" number="9.3.2">
<h3>
<span class="header-section-number">9.3.2</span> Download daily PRISM data for many years and build your own datasets<a class="anchor" aria-label="anchor" href="#download-daily-prism-data-for-many-years-and-build-your-own-datasets"><i class="fas fa-link"></i></a>
</h3>
<p>Here, an example of how to create your own sets of PRISM datasets is presented. Creating such datasets and have them locally can be useful if you expect to use the data for many different projects in the future.</p>
<p>Suppose we are interested in saving daily PRISM precipitation data by year-month from 1980 to 2018. We will write a loop that loops over all the year-month combinations. Before writing a loop, let’s work on the code for a particular year-month combination: 1990-December. However, we will write codes in a way that can be easily translated into a looped operations later. Specifically, we will define the following variables and use them as if they are variables to be looped over in a loop.</p>
<div class="sourceCode" id="cb813"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#--- month to work on ---#  </span>
<span class="va">temp_month</span> <span class="op">&lt;-</span> <span class="fl">12</span>

<span class="co">#--- year to work on ---#  </span>
<span class="va">temp_year</span> <span class="op">&lt;-</span> <span class="fl">1990</span></code></pre></div>
<p>We first need to set the path to the folder in which daily PRISM files will be downloaded.</p>
<div class="sourceCode" id="cb814"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#--- set your own path ---#</span>
<span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>prism.path <span class="op">=</span> <span class="st">"Data/PRISM/"</span><span class="op">)</span> </code></pre></div>
<p>We then set the start and end dates for <code>get_prism_dailys()</code>.</p>
<div class="sourceCode" id="cb815"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#--- starting date of the working month-year ---#</span>
<span class="op">(</span>
<span class="va">start_date</span> <span class="op">&lt;-</span> <span class="fu">dmy</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"1/"</span>, <span class="va">temp_month</span>, <span class="st">"/"</span>, <span class="va">temp_year</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<pre><code>[1] "1990-12-01"</code></pre>
<div class="sourceCode" id="cb817"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#--- ending date: add a month and then go back 1 day ---#</span>
<span class="op">(</span>
<span class="va">end_date</span> <span class="op">&lt;-</span> <span class="va">start_date</span> <span class="op">%m+%</span> <span class="fu"><a href="https://rdrr.io/r/base/weekday.POSIXt.html">months</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>
<span class="op">)</span></code></pre></div>
<pre><code>[1] "1990-12-31"</code></pre>
<p>We now download PRISM data for the year-month we are working on.</p>
<div class="sourceCode" id="cb819"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#--- download daily PRISM data for the working month-year ---#</span>
<span class="fu">get_prism_dailys</span><span class="op">(</span>
  type <span class="op">=</span> <span class="st">"ppt"</span>,
  minDate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">start_date</span><span class="op">)</span>,
  maxDate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">end_date</span><span class="op">)</span>,
  keepZip <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">)</span> </code></pre></div>
<p>Once all the data are downloaded, we will read and import them onto R. To do so, we will need the path to all the downloaded files.</p>
<div class="sourceCode" id="cb820"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#--- list of dates of the working month-year ---#</span>
<span class="va">dates_ls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="va">start_date</span>, <span class="va">end_date</span>, <span class="st">"days"</span><span class="op">)</span> 

<span class="co">#--- remove dashes ---#</span>
<span class="va">dates_prism_txt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/stringr/man/str_remove.html">str_remove_all</a></span><span class="op">(</span><span class="va">dates_ls</span>, <span class="st">"-"</span><span class="op">)</span>

<span class="co">#--- folder names ---#</span>
<span class="va">folder_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"PRISM_"</span>, <span class="va">var_type</span>, <span class="st">"_stable_4kmD2_"</span>, <span class="va">dates_prism_txt</span>, <span class="st">"_bil"</span><span class="op">)</span> 
<span class="co">#--- the file name of the downloaded data ---#</span>
<span class="va">file_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"PRISM_"</span>, <span class="va">var_type</span>, <span class="st">"_stable_4kmD2_"</span>, <span class="va">dates_prism_txt</span>, <span class="st">"_bil.bil"</span><span class="op">)</span> 
<span class="co">#--- complete path to the downloaded files ---#</span>
<span class="op">(</span>
<span class="va">file_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Data/PRISM/"</span>, <span class="va">folder_name</span>, <span class="st">"/"</span>, <span class="va">file_name</span><span class="op">)</span> 
<span class="op">)</span></code></pre></div>
<pre><code> [1] "Data/PRISM/PRISM_ppt_stable_4kmD2_19901201_bil/PRISM_ppt_stable_4kmD2_19901201_bil.bil"
 [2] "Data/PRISM/PRISM_ppt_stable_4kmD2_19901202_bil/PRISM_ppt_stable_4kmD2_19901202_bil.bil"
 [3] "Data/PRISM/PRISM_ppt_stable_4kmD2_19901203_bil/PRISM_ppt_stable_4kmD2_19901203_bil.bil"
 [4] "Data/PRISM/PRISM_ppt_stable_4kmD2_19901204_bil/PRISM_ppt_stable_4kmD2_19901204_bil.bil"
 [5] "Data/PRISM/PRISM_ppt_stable_4kmD2_19901205_bil/PRISM_ppt_stable_4kmD2_19901205_bil.bil"
 [6] "Data/PRISM/PRISM_ppt_stable_4kmD2_19901206_bil/PRISM_ppt_stable_4kmD2_19901206_bil.bil"
 [7] "Data/PRISM/PRISM_ppt_stable_4kmD2_19901207_bil/PRISM_ppt_stable_4kmD2_19901207_bil.bil"
 [8] "Data/PRISM/PRISM_ppt_stable_4kmD2_19901208_bil/PRISM_ppt_stable_4kmD2_19901208_bil.bil"
 [9] "Data/PRISM/PRISM_ppt_stable_4kmD2_19901209_bil/PRISM_ppt_stable_4kmD2_19901209_bil.bil"
[10] "Data/PRISM/PRISM_ppt_stable_4kmD2_19901210_bil/PRISM_ppt_stable_4kmD2_19901210_bil.bil"
[11] "Data/PRISM/PRISM_ppt_stable_4kmD2_19901211_bil/PRISM_ppt_stable_4kmD2_19901211_bil.bil"
[12] "Data/PRISM/PRISM_ppt_stable_4kmD2_19901212_bil/PRISM_ppt_stable_4kmD2_19901212_bil.bil"
[13] "Data/PRISM/PRISM_ppt_stable_4kmD2_19901213_bil/PRISM_ppt_stable_4kmD2_19901213_bil.bil"
[14] "Data/PRISM/PRISM_ppt_stable_4kmD2_19901214_bil/PRISM_ppt_stable_4kmD2_19901214_bil.bil"
[15] "Data/PRISM/PRISM_ppt_stable_4kmD2_19901215_bil/PRISM_ppt_stable_4kmD2_19901215_bil.bil"
[16] "Data/PRISM/PRISM_ppt_stable_4kmD2_19901216_bil/PRISM_ppt_stable_4kmD2_19901216_bil.bil"
[17] "Data/PRISM/PRISM_ppt_stable_4kmD2_19901217_bil/PRISM_ppt_stable_4kmD2_19901217_bil.bil"
[18] "Data/PRISM/PRISM_ppt_stable_4kmD2_19901218_bil/PRISM_ppt_stable_4kmD2_19901218_bil.bil"
[19] "Data/PRISM/PRISM_ppt_stable_4kmD2_19901219_bil/PRISM_ppt_stable_4kmD2_19901219_bil.bil"
[20] "Data/PRISM/PRISM_ppt_stable_4kmD2_19901220_bil/PRISM_ppt_stable_4kmD2_19901220_bil.bil"
[21] "Data/PRISM/PRISM_ppt_stable_4kmD2_19901221_bil/PRISM_ppt_stable_4kmD2_19901221_bil.bil"
[22] "Data/PRISM/PRISM_ppt_stable_4kmD2_19901222_bil/PRISM_ppt_stable_4kmD2_19901222_bil.bil"
[23] "Data/PRISM/PRISM_ppt_stable_4kmD2_19901223_bil/PRISM_ppt_stable_4kmD2_19901223_bil.bil"
[24] "Data/PRISM/PRISM_ppt_stable_4kmD2_19901224_bil/PRISM_ppt_stable_4kmD2_19901224_bil.bil"
[25] "Data/PRISM/PRISM_ppt_stable_4kmD2_19901225_bil/PRISM_ppt_stable_4kmD2_19901225_bil.bil"
[26] "Data/PRISM/PRISM_ppt_stable_4kmD2_19901226_bil/PRISM_ppt_stable_4kmD2_19901226_bil.bil"
[27] "Data/PRISM/PRISM_ppt_stable_4kmD2_19901227_bil/PRISM_ppt_stable_4kmD2_19901227_bil.bil"
[28] "Data/PRISM/PRISM_ppt_stable_4kmD2_19901228_bil/PRISM_ppt_stable_4kmD2_19901228_bil.bil"
[29] "Data/PRISM/PRISM_ppt_stable_4kmD2_19901229_bil/PRISM_ppt_stable_4kmD2_19901229_bil.bil"
[30] "Data/PRISM/PRISM_ppt_stable_4kmD2_19901230_bil/PRISM_ppt_stable_4kmD2_19901230_bil.bil"
[31] "Data/PRISM/PRISM_ppt_stable_4kmD2_19901231_bil/PRISM_ppt_stable_4kmD2_19901231_bil.bil"</code></pre>
<p>We now read them as a <code>stars</code> object, set the third dimension as date using <code>Dates</code> object class, and then save it as an R dataset (This will ensure that date dimensions is kept. See Chapter <a href="stars-basics.html#read-write-stars">7.4</a>).</p>
<div class="sourceCode" id="cb822"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb822-1"><a href="download-data.html#cb822-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb822-2"><a href="download-data.html#cb822-2" aria-hidden="true" tabindex="-1"></a><span class="co">#--- combine all the PRISM files as stars ---#</span></span>
<span id="cb822-3"><a href="download-data.html#cb822-3" aria-hidden="true" tabindex="-1"></a>temp_stars <span class="ot">&lt;-</span> <span class="fu">read_stars</span>(file_path, <span class="at">along =</span> <span class="dv">3</span>)</span>
<span id="cb822-4"><a href="download-data.html#cb822-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">#--- set the third dimension as data ---# </span></span>
<span id="cb822-5"><a href="download-data.html#cb822-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_set_dimensions</span>(<span class="st">"band"</span>, <span class="at">values =</span> dates_ls, <span class="at">name =</span> <span class="st">"date"</span>)</span>
<span id="cb822-6"><a href="download-data.html#cb822-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb822-7"><a href="download-data.html#cb822-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb822-8"><a href="download-data.html#cb822-8" aria-hidden="true" tabindex="-1"></a><span class="co">#--- save the stars as an rds file ---#</span></span>
<span id="cb822-9"><a href="download-data.html#cb822-9" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb822-10"><a href="download-data.html#cb822-10" aria-hidden="true" tabindex="-1"></a>  temp_stars, </span>
<span id="cb822-11"><a href="download-data.html#cb822-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste0</span>(<span class="st">"Data/PRISM/PRISM_"</span>, var_type, <span class="st">"_y"</span>, temp_year, <span class="st">"_m"</span>, temp_month, <span class="st">".rds"</span>)</span>
<span id="cb822-12"><a href="download-data.html#cb822-12" aria-hidden="true" tabindex="-1"></a>)  </span></code></pre></div>
<p>You could alternatively read the files into a <code>SpatRaster</code> object and save it data as a GeoTIFF file.</p>
<div class="sourceCode" id="cb823"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="op">(</span>
<span class="co">#--- combine all the PRISM files as a RasterStack ---#</span>
<span class="va">temp_stars</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html">rast</a></span><span class="op">(</span><span class="va">file_path</span><span class="op">)</span> 
<span class="op">)</span>

<span class="co">#--- save as a multi-band GeoTIFF file ---#</span>
<span class="fu">writeRaster</span><span class="op">(</span><span class="va">temp_stars</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Data/PRISM/PRISM_"</span>, <span class="va">var_type</span>, <span class="st">"_y"</span>, <span class="va">temp_year</span>, <span class="st">"_m"</span>, <span class="va">temp_month</span>, <span class="st">".tif"</span><span class="op">)</span>, overwrite <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> </code></pre></div>
<p>Note that this option of course does not have date as the third dimension. Moreover, the RDS file above takes up only 14 Mb, while the tif file occupies 108 Mb.</p>
<p>Finally, if you would like, you can delete all the individual PRISM files:</p>
<div class="sourceCode" id="cb824"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#--- delete all the downloaded files ---#</span>
<span class="fu"><a href="https://rdrr.io/r/base/unlink.html">unlink</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Data/PRISM/"</span>, <span class="va">folder_name</span><span class="op">)</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> </code></pre></div>
<hr>
<p>Okay, now that we know what to do with a particular year-month combination, we can easily write a loop to go over all the year-month combinations for the period of interest. Since all the processes we observed above for a single year-month combination is embarrassingly parallel, it is easy to parallelize using <code><a href="https://rdrr.io/pkg/future.apply/man/future_lapply.html">future.apply::future_lapply()</a></code> or <code><a href="https://rdrr.io/r/parallel/mclapply.html">parallel::mclapply()</a></code> (Linux/Mac users only). Here we use <code><a href="https://rdrr.io/pkg/future.apply/man/future_lapply.html">future_lapply()</a></code>. Let’s first get the number of logical cores.</p>
<div class="sourceCode" id="cb825"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span>
<span class="va">num_cores</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span><span class="op">(</span><span class="op">)</span> 

<span class="fu">plan</span><span class="op">(</span><span class="va">multiprocess</span>, workers <span class="op">=</span> <span class="va">num_cores</span><span class="op">)</span></code></pre></div>
<p>The following function goes through all the steps we saw above for a single year-month combination.</p>
<div class="sourceCode" id="cb826"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#--- define a function to download and save PRISM data stacked by month ---#</span>
<span class="va">get_save_prism</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span>, <span class="va">var_type</span><span class="op">)</span> <span class="op">{</span>

  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"working on "</span>, <span class="va">i</span><span class="op">)</span><span class="op">)</span>

  <span class="va">temp_month</span> <span class="op">&lt;-</span> <span class="va">month_year_data</span><span class="op">[</span><span class="va">i</span>, <span class="va">month</span><span class="op">]</span> <span class="co"># working month</span>
  <span class="va">temp_year</span> <span class="op">&lt;-</span> <span class="va">month_year_data</span><span class="op">[</span><span class="va">i</span>, <span class="va">year</span><span class="op">]</span> <span class="co"># working year</span>
  
  <span class="co">#--- starting date of the working month-year ---#</span>
  <span class="va">start_date</span> <span class="op">&lt;-</span> <span class="fu">dmy</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"1/"</span>, <span class="va">temp_month</span>, <span class="st">"/"</span>, <span class="va">temp_year</span><span class="op">)</span><span class="op">)</span>
  <span class="co">#--- end date ---#</span>
  <span class="va">end_date</span> <span class="op">&lt;-</span> <span class="va">start_date</span> <span class="op">%m+%</span> <span class="fu"><a href="https://rdrr.io/r/base/weekday.POSIXt.html">months</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>

  
  <span class="co">#--- download daily PRISM data for the working month-year ---#</span>
  <span class="fu">get_prism_dailys</span><span class="op">(</span>
    type <span class="op">=</span> <span class="va">var_type</span>,
    minDate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">start_date</span><span class="op">)</span>,
    maxDate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">end_date</span><span class="op">)</span>,
    keepZip <span class="op">=</span> <span class="cn">FALSE</span>
  <span class="op">)</span> 

  <span class="co">#--- list of dates of the working month-year ---#</span>
  <span class="va">dates_ls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="va">start_date</span>, <span class="va">end_date</span>, <span class="st">"days"</span><span class="op">)</span> 

  <span class="co">#--- remove dashes ---#</span>
  <span class="va">dates_prism_txt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/stringr/man/str_remove.html">str_remove_all</a></span><span class="op">(</span><span class="va">dates_ls</span>, <span class="st">"-"</span><span class="op">)</span>

  <span class="co">#--- folder names ---#</span>
  <span class="va">folder_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"PRISM_"</span>, <span class="va">var_type</span>, <span class="st">"_stable_4kmD2_"</span>, <span class="va">dates_prism_txt</span>, <span class="st">"_bil"</span><span class="op">)</span> 
  <span class="co">#--- the file name of the downloaded data ---#</span>
  <span class="va">file_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"PRISM_"</span>, <span class="va">var_type</span>, <span class="st">"_stable_4kmD2_"</span>, <span class="va">dates_prism_txt</span>, <span class="st">"_bil.bil"</span><span class="op">)</span> 
  <span class="co">#--- complete path to the downloaded files ---#</span>
  <span class="va">file_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Data/PRISM/"</span>, <span class="va">folder_name</span>, <span class="st">"/"</span>, <span class="va">file_name</span><span class="op">)</span>

  <span class="co">#--- combine all the PRISM files as a RasterStack ---#</span>
  <span class="va">temp_stars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/stack.html">stack</a></span><span class="op">(</span><span class="va">file_path</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
    <span class="co">#--- convert to stars ---#</span>
    <span class="fu">st_as_stars</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
    <span class="co">#--- set the third dimension as data ---# </span>
    <span class="fu">st_set_dimensions</span><span class="op">(</span><span class="st">"band"</span>, values <span class="op">=</span> <span class="va">dates_ls</span>, name <span class="op">=</span> <span class="st">"date"</span><span class="op">)</span>

  <span class="co">#--- save the stars as an rds file ---#</span>
  <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span>
    <span class="va">temp_stars</span>, 
    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Data/PRISM/PRISM_"</span>, <span class="va">var_type</span>, <span class="st">"_y"</span>, <span class="va">temp_year</span>, <span class="st">"_m"</span>, <span class="va">temp_month</span>, <span class="st">".rds"</span><span class="op">)</span>
  <span class="op">)</span>

  <span class="co">#--- delete all the downloaded files ---#</span>
  <span class="fu"><a href="https://rdrr.io/r/base/unlink.html">unlink</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Data/PRISM/"</span>, <span class="va">folder_name</span><span class="op">)</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="op">}</span> </code></pre></div>
<p>We then create a <code>data.frame</code> of all the year-month combinations:</p>
<div class="sourceCode" id="cb827"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="op">(</span>
<span class="co">#--- create a set of year-month combinations to loop over ---#</span>
<span class="va">month_year_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span>month  <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">12</span>, year <span class="op">=</span> <span class="fl">1990</span><span class="op">:</span><span class="fl">2018</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
  <span class="fu">data.table</span><span class="op">(</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<pre><code>     month year
  1:     1 1990
  2:     2 1990
  3:     3 1990
  4:     4 1990
  5:     5 1990
 ---           
344:     8 2018
345:     9 2018
346:    10 2018
347:    11 2018
348:    12 2018</code></pre>
<p>We now do parallelized loop over all the year-month combinations (by looping over the rows of the <code>month_year_data</code>):</p>
<div class="sourceCode" id="cb829"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#--- run the above code in parallel ---#</span>
<span class="fu">future_lapply</span><span class="op">(</span>
  <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">month_year_data</span><span class="op">)</span>, 
  <span class="kw">function</span> <span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">get_save_prism</span><span class="op">(</span><span class="va">x</span>, <span class="st">"ppt"</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>That’s it. Of course, you can do the same thing for tmax by this:</p>
<div class="sourceCode" id="cb830"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#--- run the above code in parallel ---#</span>
<span class="fu">future_lapply</span><span class="op">(</span>
  <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">month_year_data</span><span class="op">)</span>, 
  <span class="kw">function</span> <span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">get_save_prism</span><span class="op">(</span><span class="va">x</span>, <span class="st">"tmax"</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>Now that you have PRISM datasets, you can extract values from the raster layers for vector data for your analysis, which is covered extensively in Chapters <a href="int-RV.html#int-RV">5</a> and <a href="stars-basics.html#stars-basics">7</a> (for <code>stars</code> objects).</p>
<hr>
<p>If you want to save the data by year (each file would be about 168 Mb). You could do this.</p>
<div class="sourceCode" id="cb831"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#--- define a function to download and save PRISM data stacked by year ---#</span>
<span class="va">get_save_prism_y</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">temp_year</span>, <span class="va">var_type</span><span class="op">)</span> <span class="op">{</span>

  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"working on "</span>, <span class="va">temp_year</span><span class="op">)</span><span class="op">)</span>
  
  <span class="co">#--- starting date of the working month-year ---#</span>
  <span class="va">start_date</span> <span class="op">&lt;-</span> <span class="fu">dmy</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"1/1/"</span>, <span class="va">temp_year</span><span class="op">)</span><span class="op">)</span>
  <span class="co">#--- end date ---#</span>
  <span class="va">end_date</span> <span class="op">&lt;-</span> <span class="fu">dmy</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"1/1/"</span>, <span class="va">temp_year</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>

  <span class="co">#--- download daily PRISM data for the working month-year ---#</span>
  <span class="fu">get_prism_dailys</span><span class="op">(</span>
    type <span class="op">=</span> <span class="va">var_type</span>,
    minDate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">start_date</span><span class="op">)</span>,
    maxDate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">end_date</span><span class="op">)</span>,
    keepZip <span class="op">=</span> <span class="cn">FALSE</span>
  <span class="op">)</span> 

  <span class="co">#--- list of dates of the working month-year ---#</span>
  <span class="va">dates_ls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="va">start_date</span>, <span class="va">end_date</span>, <span class="st">"days"</span><span class="op">)</span> 

  <span class="co">#--- remove dashes ---#</span>
  <span class="va">dates_prism_txt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/stringr/man/str_remove.html">str_remove_all</a></span><span class="op">(</span><span class="va">dates_ls</span>, <span class="st">"-"</span><span class="op">)</span>

  <span class="co">#--- folder names ---#</span>
  <span class="va">folder_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"PRISM_"</span>, <span class="va">var_type</span>, <span class="st">"_stable_4kmD2_"</span>, <span class="va">dates_prism_txt</span>, <span class="st">"_bil"</span><span class="op">)</span> 
  <span class="co">#--- the file name of the downloaded data ---#</span>
  <span class="va">file_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"PRISM_"</span>, <span class="va">var_type</span>, <span class="st">"_stable_4kmD2_"</span>, <span class="va">dates_prism_txt</span>, <span class="st">"_bil.bil"</span><span class="op">)</span> 
  <span class="co">#--- complete path to the downloaded files ---#</span>
  <span class="va">file_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Data/PRISM/"</span>, <span class="va">folder_name</span>, <span class="st">"/"</span>, <span class="va">file_name</span><span class="op">)</span>

  <span class="co">#--- combine all the PRISM files as a RasterStack ---#</span>
  <span class="va">temp_stars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/stack.html">stack</a></span><span class="op">(</span><span class="va">file_path</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
    <span class="co">#--- convert to stars ---#</span>
    <span class="fu">st_as_stars</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
    <span class="co">#--- set the third dimension as data ---# </span>
    <span class="fu">st_set_dimensions</span><span class="op">(</span><span class="st">"band"</span>, values <span class="op">=</span> <span class="va">dates_ls</span>, name <span class="op">=</span> <span class="st">"date"</span><span class="op">)</span>

  <span class="co">#--- save the stars as an rds file ---#</span>
  <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span>
    <span class="va">temp_stars</span>, 
    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Data/PRISM/PRISM_"</span>, <span class="va">var_type</span>, <span class="st">"_y"</span>, <span class="va">temp_year</span>, <span class="st">".rds"</span><span class="op">)</span>
  <span class="op">)</span>

  <span class="co">#--- delete all the downloaded files ---#</span>
  <span class="fu"><a href="https://rdrr.io/r/base/unlink.html">unlink</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Data/PRISM/"</span>, <span class="va">folder_name</span><span class="op">)</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="op">}</span> 

<span class="co">#--- run the above code in parallel ---#</span>
<span class="fu">future_lapply</span><span class="op">(</span>
  <span class="fl">1990</span><span class="op">:</span><span class="fl">2018</span>, 
  <span class="kw">function</span> <span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">get_save_prism_y</span><span class="op">(</span><span class="va">x</span>, <span class="st">"tmax"</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
</div>
</div>
<div id="daymet-with-daymetr-and-feddata" class="section level2" number="9.4">
<h2>
<span class="header-section-number">9.4</span> Daymet with <code>daymetr</code> and <code>FedData</code><a class="anchor" aria-label="anchor" href="#daymet-with-daymetr-and-feddata"><i class="fas fa-link"></i></a>
</h2>
<p>For this section, we use the <code>daymetr</code> <span class="citation">(<a href="references.html#ref-daymetr" role="doc-biblioref">Hufkens et al. 2018</a>)</span> and <code>FedData</code> packages <span class="citation">(<a href="references.html#ref-feddata" role="doc-biblioref">Bocinsky 2016</a>)</span>.</p>
<div class="sourceCode" id="cb832"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bluegreen-labs/daymetr">daymetr</a></span><span class="op">)</span>  
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/FedData">FedData</a></span><span class="op">)</span>  </code></pre></div>
<p>Daymet data consists of “tiles,” each of which consisting of raster cells of 1km by 1km. Here is the map of the tiles (Figure <a href="download-data.html#fig:daymet-tiles">9.3</a>)</p>
<div class="figure">
<span style="display:block;" id="fig:daymet-tiles"></span>
<img src="R_GIS_Book_files/figure-html/daymet-tiles-1.png" alt="Daymet Tiles" width="672"><p class="caption">
Figure 9.3: Daymet Tiles
</p>
</div>
<p>Here is the list of weather variables:</p>
<ul>
<li>vapor pressure</li>
<li>minimum and maximum temperature</li>
<li>snow water equivalent</li>
<li>solar radiation</li>
<li>precipitation<br>
</li>
<li>day length</li>
</ul>
<p>So, Daymet provides information about more weather variables than PRISM, which helps to find some weather-dependent metrics, such as evapotranspiration.</p>
<p>The easiest way find Daymet values for your vector data depends on whether it is points or polygons data. For points data, <code><a href="https://rdrr.io/pkg/daymetr/man/download_daymet.html">daymetr::download_daymet()</a></code> is the easiest because it will directly return weather values to the point of interest. Internally, it finds the cell in which the point is located, and then return the values of the cell for the specified length of period. <code><a href="https://rdrr.io/pkg/daymetr/man/download_daymet.html">daymetr::download_daymet()</a></code> does all this for you. For polygons, we need to first download pertinent Daymet data for the region of interest first and then extract values for each of the polygons ourselves, which we learned in Chapter <a href="int-RV.html#int-RV">5</a>. Unfortunately, the netCDF data downloaded from <code><a href="https://rdrr.io/pkg/daymetr/man/download_daymet_ncss.html">daymetr::download_daymet_ncss()</a></code> cannot be easily read by the <code>raster</code> package nor the <code>stars</code> package. On the contrary, <code><a href="https://docs.ropensci.org/FedData/reference/get_daymet.html">FedData::get_daymet()</a></code> download the the requested Daymet data and save it as a <code>RasterBrick</code> object, which can be easily turned into <code>stars</code> object using <code>st_as_stars()</code>.</p>
<div id="for-points-data" class="section level3" number="9.4.1">
<h3>
<span class="header-section-number">9.4.1</span> For points data<a class="anchor" aria-label="anchor" href="#for-points-data"><i class="fas fa-link"></i></a>
</h3>
<p>For points data, the easiest way to associate daily weather values to them is to use <code><a href="https://rdrr.io/pkg/daymetr/man/download_daymet.html">download_daymet()</a></code>. <code><a href="https://rdrr.io/pkg/daymetr/man/download_daymet.html">download_daymet()</a></code> can download daily weather data for a single point at a time by finding which cell of a tile the point is located within.</p>
<p>Here are key parameters for the function:</p>
<ul>
<li>lat: latitude</li>
<li>lon: longitude</li>
<li>start: start_year</li>
<li>end: end_year</li>
<li>internal: <code>TRUE</code> (dafault) or <code>FALSE</code>
</li>
</ul>
<p>For example, the code below downloads daily weather data for a point (lat = <span class="math inline">\(36\)</span>, longitude = <span class="math inline">\(-100\)</span>) starting from 2000 to 2002 and assigns the downloaded data to <code>temp_daymet</code>.</p>
<div class="sourceCode" id="cb833"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#--- download daymet data ---#</span>
<span class="va">temp_daymet</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/daymetr/man/download_daymet.html">download_daymet</a></span><span class="op">(</span>
  lat <span class="op">=</span> <span class="fl">36</span>,
  lon <span class="op">=</span> <span class="op">-</span><span class="fl">100</span>,
  start <span class="op">=</span> <span class="fl">2000</span>,
  end <span class="op">=</span> <span class="fl">2002</span>
<span class="op">)</span> 

<span class="co">#--- structure ---#</span>
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">temp_daymet</span><span class="op">)</span></code></pre></div>
<pre><code>List of 7
 $ site     : chr "Daymet"
 $ tile     : num 11380
 $ latitude : num 36
 $ longitude: num -100
 $ altitude : num 746
 $ tile     : num 11380
 $ data     :'data.frame':  1095 obs. of  9 variables:
  ..$ year         : int [1:1095] 2000 2000 2000 2000 2000 2000 2000 2000 2000 2000 ...
  ..$ yday         : int [1:1095] 1 2 3 4 5 6 7 8 9 10 ...
  ..$ dayl..s.     : num [1:1095] 34571 34606 34644 34685 34729 ...
  ..$ prcp..mm.day.: num [1:1095] 0 0 0 0 0 0 0 0 0 0 ...
  ..$ srad..W.m.2. : num [1:1095] 334 231 148 319 338 ...
  ..$ swe..kg.m.2. : num [1:1095] 18.2 15 13.6 13.6 13.6 ...
  ..$ tmax..deg.c. : num [1:1095] 20.9 13.88 4.49 9.18 13.37 ...
  ..$ tmin..deg.c. : num [1:1095] -2.73 1.69 -2.6 -10.16 -8.97 ...
  ..$ vp..Pa.      : num [1:1095] 500 690 504 282 310 ...
 - attr(*, "class")= chr "daymetr"</code></pre>
<p>As you can see, <code>temp_daymet</code> has bunch of site information other than the download Daymet data.</p>
<div class="sourceCode" id="cb835"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#--- get the data part ---#</span>
<span class="va">temp_daymet_data</span> <span class="op">&lt;-</span> <span class="va">temp_daymet</span><span class="op">$</span><span class="va">data</span>

<span class="co">#--- take a look ---#</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">temp_daymet_data</span><span class="op">)</span></code></pre></div>
<pre><code>  year yday dayl..s. prcp..mm.day. srad..W.m.2. swe..kg.m.2. tmax..deg.c.
1 2000    1 34571.11             0       334.34        18.23        20.90
2 2000    2 34606.19             0       231.20        15.00        13.88
3 2000    3 34644.13             0       148.29        13.57         4.49
4 2000    4 34684.93             0       319.13        13.57         9.18
5 2000    5 34728.55             0       337.67        13.57        13.37
6 2000    6 34774.96             0       275.72        13.11         9.98
  tmin..deg.c. vp..Pa.
1        -2.73  499.56
2         1.69  689.87
3        -2.60  504.40
4       -10.16  282.35
5        -8.97  310.05
6        -4.89  424.78</code></pre>
<p>As you might have noticed, <code>yday</code> is not the date of each observation, but the day of the year. You can easily convert it into dates like this:</p>
<div class="sourceCode" id="cb837"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">temp_daymet_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/mutate.html">mutate</a></span><span class="op">(</span><span class="va">temp_daymet_data</span>, date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">yday</span>, sep <span class="op">=</span> <span class="st">"-"</span><span class="op">)</span>, <span class="st">"%Y-%j"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>One dates are obtained, you can use the <code>lubridate</code> package to extract day, month, and year using <code><a href="https://rdrr.io/pkg/lubridate/man/day.html">day()</a></code>, <code><a href="https://rdrr.io/pkg/lubridate/man/month.html">month()</a></code>, and <code><a href="https://rdrr.io/pkg/lubridate/man/year.html">year()</a></code>, respectively.</p>
<div class="sourceCode" id="cb838"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org">lubridate</a></span><span class="op">)</span>

<span class="va">temp_daymet_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/mutate.html">mutate</a></span><span class="op">(</span><span class="va">temp_daymet_data</span>,
  day <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/lubridate/man/day.html">day</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>,
  month <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/lubridate/man/month.html">month</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>,
  <span class="co">#--- this is already there though ---#</span>
  year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/lubridate/man/year.html">year</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>
<span class="op">)</span>

<span class="co">#--- take a look ---#</span>
<span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/select.html">select</a></span><span class="op">(</span><span class="va">temp_daymet_data</span>, <span class="va">year</span>, <span class="va">month</span>, <span class="va">day</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span>  <span class="va">head</span></code></pre></div>
<pre><code>  year month day
1 2000     1   1
2 2000     1   2
3 2000     1   3
4 2000     1   4
5 2000     1   5
6 2000     1   6</code></pre>
<p>This helps you find group statistics like monthly precipitation.</p>
<div class="sourceCode" id="cb840"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">temp_daymet_data</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/group_by.html">group_by</a></span><span class="op">(</span><span class="va">month</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/summarise.html">summarize</a></span><span class="op">(</span>prcp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">prcp..mm.day.</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code># A tibble: 12 × 2
   month  prcp
   &lt;dbl&gt; &lt;dbl&gt;
 1     1 0.762
 2     2 1.20 
 3     3 2.08 
 4     4 1.24 
 5     5 3.53 
 6     6 3.45 
 7     7 1.78 
 8     8 1.19 
 9     9 1.32 
10    10 4.78 
11    11 0.407
12    12 0.743</code></pre>
<p>Downloading Daymet data for many points is just applying the same operations above to them using a loop. Let’s create random points within California and get their coordinates.</p>
<div class="sourceCode" id="cb842"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">389548</span><span class="op">)</span>

<span class="va">random_points</span> <span class="op">&lt;-</span> 
  <span class="fu">tigris</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tigris/man/counties.html">counties</a></span><span class="op">(</span>state <span class="op">=</span> <span class="st">"CA"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
  <span class="fu">st_as_sf</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
  <span class="co">#--- 10 points ---#</span>
  <span class="fu">st_sample</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
  <span class="co">#--- get the coordinates ---#</span>
  <span class="fu">st_coordinates</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
  <span class="co">#--- as tibble (data.frame) ---#</span>
  <span class="fu"><a href="https://rdrr.io/pkg/tibble/man/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
  <span class="co">#--- assign site id ---#</span>
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/mutate.html">mutate</a></span><span class="op">(</span>site_id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>To loop over the points, you can first write a function like this:</p>
<div class="sourceCode" id="cb843"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">get_daymet</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span><span class="op">{</span>

  <span class="va">temp_lat</span> <span class="op">&lt;-</span> <span class="va">random_points</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/pull.html">pull</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span>
  <span class="va">temp_lon</span> <span class="op">&lt;-</span> <span class="va">random_points</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/pull.html">pull</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>
  <span class="va">temp_site</span> <span class="op">&lt;-</span> <span class="va">random_points</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/pull.html">pull</a></span><span class="op">(</span><span class="va">site_id</span><span class="op">)</span>

  <span class="va">temp_daymet</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/daymetr/man/download_daymet.html">download_daymet</a></span><span class="op">(</span>
    lat <span class="op">=</span> <span class="va">temp_lat</span>,
    lon <span class="op">=</span> <span class="va">temp_lon</span>,
    start <span class="op">=</span> <span class="fl">2000</span>,
    end <span class="op">=</span> <span class="fl">2002</span>
  <span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
  <span class="co">#--- just get the data part ---#</span>
  <span class="va">.</span><span class="op">$</span><span class="va">data</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
  <span class="co">#--- convert to tibble (not strictly necessary) ---#</span>
  <span class="fu"><a href="https://rdrr.io/pkg/tibble/man/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
  <span class="co">#--- assign site_id so you know which record is for which site_id ---#</span>
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/mutate.html">mutate</a></span><span class="op">(</span>site_id <span class="op">=</span> <span class="va">temp_site</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
  <span class="co">#--- get date from day of the year ---#</span>
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/mutate.html">mutate</a></span><span class="op">(</span>date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">yday</span>, sep <span class="op">=</span> <span class="st">"-"</span><span class="op">)</span>, <span class="st">"%Y-%j"</span><span class="op">)</span><span class="op">)</span>

  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">temp_daymet</span><span class="op">)</span>
<span class="op">}</span>  </code></pre></div>
<p>Here is what the function returns for the 1st row of <code>random_points</code>:</p>
<div class="sourceCode" id="cb844"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://docs.ropensci.org/FedData/reference/get_daymet.html">get_daymet</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></code></pre></div>
<pre><code># A tibble: 1,095 × 11
    year  yday dayl..s. prcp..mm.day. srad..W.m.2. swe..kg.m.2. tmax..deg.c.
   &lt;int&gt; &lt;int&gt;    &lt;dbl&gt;         &lt;dbl&gt;        &lt;dbl&gt;        &lt;dbl&gt;        &lt;dbl&gt;
 1  2000     1   34131.             0         246.            0         7.02
 2  2000     2   34168.             0         251.            0         4.67
 3  2000     3   34208.             0         247.            0         7.32
 4  2000     4   34251              0         267.            0        10   
 5  2000     5   34297              0         240.            0         4.87
 6  2000     6   34346.             0         274.            0         7.79
 7  2000     7   34398.             0         262.            0         7.29
 8  2000     8   34453.             0         291.            0        11.2 
 9  2000     9   34510.             0         268.            0        10.0 
10  2000    10   34570.             0         277.            0        11.8 
# … with 1,085 more rows, and 4 more variables: tmin..deg.c. &lt;dbl&gt;,
#   vp..Pa. &lt;dbl&gt;, site_id &lt;int&gt;, date &lt;date&gt;</code></pre>
<p>You can now simply loop over the rows.</p>
<div class="sourceCode" id="cb846"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="op">(</span>
<span class="va">daymet_all_points</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">random_points</span><span class="op">)</span>, <span class="va">get_daymet</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
  <span class="co">#--- need to combine the list of data.frames into a single data.frame ---#</span>
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/bind.html">bind_rows</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<pre><code># A tibble: 10,950 × 11
    year  yday dayl..s. prcp..mm.day. srad..W.m.2. swe..kg.m.2. tmax..deg.c.
   &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;         &lt;dbl&gt;        &lt;dbl&gt;        &lt;dbl&gt;        &lt;dbl&gt;
 1  2000     1   33523.             0         230.            0         12  
 2  2000     2   33523.             0         240             0         11.5
 3  2000     3   33523.             0         243.            0         13.5
 4  2000     4   33523.             1         230.            0         13  
 5  2000     5   33523.             0         243.            0         14  
 6  2000     6   33523.             0         243.            0         13  
 7  2000     7   33523.             0         246.            0         14  
 8  2000     8   33869.             0         230.            0         13  
 9  2000     9   33869.             0         227.            0         12.5
10  2000    10   33869.             0         214.            0         14  
# … with 10,940 more rows, and 4 more variables: tmin..deg.c. &lt;dbl&gt;,
#   vp..Pa. &lt;dbl&gt;, site_id &lt;int&gt;, date &lt;date&gt;</code></pre>
<p>Or better yet, you can easily parallelize this process as follows (see Chapter <a href="par-comp.html#par-comp">A</a> if you are not familiar with parallelization in R):</p>
<div class="sourceCode" id="cb848"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://future.apply.futureverse.org">future.apply</a></span><span class="op">)</span>    
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span>

<span class="co">#--- parallelization planning ---#</span>
<span class="fu"><a href="https://rdrr.io/pkg/future/man/plan.html">plan</a></span><span class="op">(</span><span class="va">multiprocess</span>, workers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>

<span class="co">#--- parallelized lapply ---#</span>
<span class="va">daymet_all_points</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/future.apply/man/future_lapply.html">future_lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">random_points</span><span class="op">)</span>, <span class="va">get_daymet</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
  <span class="co">#--- need to combine the list of data.frames into a single data.frame ---#</span>
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/bind.html">bind_rows</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
</div>
<div id="daymet-poly" class="section level3" number="9.4.2">
<h3>
<span class="header-section-number">9.4.2</span> For polygons data<a class="anchor" aria-label="anchor" href="#daymet-poly"><i class="fas fa-link"></i></a>
</h3>
<p>Suppose you are interested in getting Daymet data for select counties in Michigan (Figure <a href="download-data.html#fig:michi-fig">9.4</a>).</p>
<div class="sourceCode" id="cb849"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#--- entire MI ---#</span>
<span class="va">MI_counties</span> <span class="op">&lt;-</span> <span class="fu">tigris</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tigris/man/counties.html">counties</a></span><span class="op">(</span>state <span class="op">=</span> <span class="st">"MI"</span><span class="op">)</span>

<span class="co">#--- select counties ---#</span>
<span class="va">MI_counties_select</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/filter.html">filter</a></span><span class="op">(</span><span class="va">MI_counties</span>, <span class="va">NAME</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Luce"</span>, <span class="st">"Chippewa"</span>, <span class="st">"Mackinac"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:michi-fig"></span>
<img src="R_GIS_Book_files/figure-html/michi-fig-1.png" alt="Select Michigan counties for which we download Daymet data" width="672"><p class="caption">
Figure 9.4: Select Michigan counties for which we download Daymet data
</p>
</div>
<p>We can use <code><a href="https://docs.ropensci.org/FedData/reference/get_daymet.html">FedData::get_daymet()</a></code> to download Daymet data that covers the spatial extent of the polygons data. The downloaded dataset can be assigned to an R object as <code>RasterBrick</code> (you could alternatively write the downloaded data to a file). In order to let the function know the spatial extent for which it download Daymet data, we supply a <code>SpatialPolygonsDataFrame</code> object supported by the <code>sp</code> package. Since our main vector data handling package is <code>sf</code> we need to convert the <code>sf</code> object to a <code>sp</code> object.</p>
<p>The code below downloads <code>prcp</code> and <code>tmax</code> for the spatial extent of Michigan counties for 2000 and 2001:</p>
<div class="sourceCode" id="cb850"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="op">(</span>
<span class="va">MI_daymet_select</span> <span class="op">&lt;-</span> <span class="fu">FedData</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/FedData/reference/get_daymet.html">get_daymet</a></span><span class="op">(</span>
  <span class="co">#--- supply the vector data in sp ---#</span>
  template <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/methods/as.html">as</a></span><span class="op">(</span><span class="va">MI_counties_select</span>, <span class="st">"Spatial"</span><span class="op">)</span>,
  <span class="co">#--- label ---#</span>
  label <span class="op">=</span> <span class="st">"MI_counties_select"</span>,
  <span class="co">#--- variables to download ---#</span>
  elements <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"prcp"</span>,<span class="st">"tmax"</span><span class="op">)</span>,
  <span class="co">#--- years ---#</span>
  years <span class="op">=</span> <span class="fl">2000</span><span class="op">:</span><span class="fl">2001</span>
<span class="op">)</span>
<span class="op">)</span></code></pre></div>
<pre><code>$prcp
class      : RasterBrick 
dimensions : 96, 156, 14976, 730  (nrow, ncol, ncell, nlayers)
resolution : 1000, 1000  (x, y)
extent     : 1027250, 1183250, 455500, 551500  (xmin, xmax, ymin, ymax)
crs        : +proj=lcc +lon_0=-100 +lat_0=42.5 +x_0=0 +y_0=0 +lat_1=25 +lat_2=60 +ellps=WGS84 
source     : memory
names      : X2000.01.01, X2000.01.02, X2000.01.03, X2000.01.04, X2000.01.05, X2000.01.06, X2000.01.07, X2000.01.08, X2000.01.09, X2000.01.10, X2000.01.11, X2000.01.12, X2000.01.13, X2000.01.14, X2000.01.15, ... 
min values :           0,           0,           0,           0,           0,           0,           0,           0,           0,           0,           0,           0,           0,           0,           0, ... 
max values :           6,          26,          19,          17,           6,           9,           6,           1,           0,          13,          15,           6,           0,           4,           7, ... 


$tmax
class      : RasterBrick 
dimensions : 96, 156, 14976, 730  (nrow, ncol, ncell, nlayers)
resolution : 1000, 1000  (x, y)
extent     : 1027250, 1183250, 455500, 551500  (xmin, xmax, ymin, ymax)
crs        : +proj=lcc +lon_0=-100 +lat_0=42.5 +x_0=0 +y_0=0 +lat_1=25 +lat_2=60 +ellps=WGS84 
source     : memory
names      : X2000.01.01, X2000.01.02, X2000.01.03, X2000.01.04, X2000.01.05, X2000.01.06, X2000.01.07, X2000.01.08, X2000.01.09, X2000.01.10, X2000.01.11, X2000.01.12, X2000.01.13, X2000.01.14, X2000.01.15, ... 
min values :         0.5,        -4.5,        -8.0,        -8.5,        -7.0,        -2.5,        -6.5,        -1.5,         1.5,         2.0,        -1.5,        -8.5,       -14.0,        -9.5,        -3.0, ... 
max values :         3.0,         3.0,         0.5,        -2.5,        -2.5,         0.0,         0.5,         1.5,         4.0,         3.0,         3.5,         0.5,        -6.5,        -4.0,         0.0, ... </code></pre>
<p>As you can see, Daymet <code>prcp</code> and <code>tmax</code> data are stored separately as <code>RasterBrick</code>. Now that you have stars objects, you can extract values for your target polygons data using the methods described in Chapter <a href="int-RV.html#int-RV">5</a>.</p>
<p>If you use the <code>stars</code> package for raster data handling (see Chapter <a href="stars-basics.html#stars-basics">7</a>), you can convert them into <code>stars</code> object using <code>st_as_stars()</code>.</p>
<div class="sourceCode" id="cb852"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#--- tmax as stars ---#</span>
<span class="va">tmax_stars</span> <span class="op">&lt;-</span> <span class="fu">st_as_stars</span><span class="op">(</span><span class="va">MI_daymet_select</span><span class="op">$</span><span class="va">tmax</span><span class="op">)</span>

<span class="co">#--- prcp as stars ---#</span>
<span class="va">prcp_stars</span> <span class="op">&lt;-</span> <span class="fu">st_as_stars</span><span class="op">(</span><span class="va">MI_daymet_select</span><span class="op">$</span><span class="va">prcp</span><span class="op">)</span></code></pre></div>
<p>Now, the third dimension (band) is not recognized as dates. We can use <code>st_set_dimension()</code> to change that (see Chapter <a href="stars-basics.html#stars-set-time">7.5</a>). Before that, we first need to recover <code>Date</code> values from the “band” values as follows:</p>
<div class="sourceCode" id="cb853"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">date_values</span> <span class="op">&lt;-</span> <span class="va">tmax_stars</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
  <span class="co">#--- get band values ---#</span>
  <span class="fu">st_get_dimension_values</span><span class="op">(</span><span class="va">.</span>, <span class="st">"band"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
  <span class="co">#--- remove X ---#</span>
  <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"X"</span>, <span class="st">""</span>, <span class="va">.</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
  <span class="co">#--- convert to date ---#</span>
  <span class="fu"><a href="https://rdrr.io/pkg/lubridate/man/ymd.html">ymd</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>

<span class="co">#--- take a look ---#</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">date_values</span><span class="op">)</span></code></pre></div>
<pre><code>[1] "2000-01-01" "2000-01-02" "2000-01-03" "2000-01-04" "2000-01-05"
[6] "2000-01-06"</code></pre>
<div class="sourceCode" id="cb855"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#--- tmax ---#</span>
<span class="fu">st_set_dimensions</span><span class="op">(</span><span class="va">tmax_stars</span>, <span class="fl">3</span>, values <span class="op">=</span> <span class="va">date_values</span>, names <span class="op">=</span> <span class="st">"date"</span> <span class="op">)</span>  </code></pre></div>
<pre><code>stars object with 3 dimensions and 1 attribute
attribute(s), summary of first 1e+05 cells:
             Min. 1st Qu. Median      Mean 3rd Qu. Max. NA's
X2000.01.01  -8.5      -4     -2 -1.884266       0    3  198
dimension(s):
     from  to  offset delta                       refsys point
x       1 156 1027250  1000 +proj=lcc +lon_0=-100 +la...    NA
y       1  96  551500 -1000 +proj=lcc +lon_0=-100 +la...    NA
date    1 730      NA    NA                         Date    NA
                        values x/y
x                         NULL [x]
y                         NULL [y]
date 2000-01-01,...,2001-12-31    </code></pre>
<div class="sourceCode" id="cb857"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#--- prcp ---#</span>
<span class="fu">st_set_dimensions</span><span class="op">(</span><span class="va">prcp_stars</span>, <span class="fl">3</span>, values <span class="op">=</span> <span class="va">date_values</span>, names <span class="op">=</span> <span class="st">"date"</span> <span class="op">)</span>  </code></pre></div>
<pre><code>stars object with 3 dimensions and 1 attribute
attribute(s), summary of first 1e+05 cells:
             Min. 1st Qu. Median     Mean 3rd Qu. Max. NA's
X2000.01.01     0       0      3 6.231649      12   26  198
dimension(s):
     from  to  offset delta                       refsys point
x       1 156 1027250  1000 +proj=lcc +lon_0=-100 +la...    NA
y       1  96  551500 -1000 +proj=lcc +lon_0=-100 +la...    NA
date    1 730      NA    NA                         Date    NA
                        values x/y
x                         NULL [x]
y                         NULL [y]
date 2000-01-01,...,2001-12-31    </code></pre>
<p>Notice that the date dimension has NA for <code>delta</code>. This is because Daymet removes observations for December 31 in leap years to make the time dimension 365 consistently across years. This means that there is a one-day gap between “2000-12-30” and “2000-01-01” as you can see below:</p>
<div class="sourceCode" id="cb859"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">date_values</span><span class="op">[</span><span class="fl">364</span><span class="op">:</span><span class="fl">367</span><span class="op">]</span></code></pre></div>
<pre><code>[1] "2000-12-29" "2000-12-30" "2001-01-01" "2001-01-02"</code></pre>
</div>
</div>
<div id="gridMET" class="section level2" number="9.5">
<h2>
<span class="header-section-number">9.5</span> gridMET<a class="anchor" aria-label="anchor" href="#gridMET"><i class="fas fa-link"></i></a>
</h2>
<p><a href="http://www.climatologylab.org/gridmet.html">gridMET</a> is a dataset of <strong>daily</strong> meteorological data that covers the contiguous US since 1979. It spatial resolution is the same as PRISM data at 4-km by 4-km. Indeed gridMET is a product of combining <a href="https://prism.oregonstate.edu/">PRISM</a> and Land Data Assimilation System (<a href="https://ldas.gsfc.nasa.gov/nldas/NLDAS2forcing.php" class="uri">https://ldas.gsfc.nasa.gov/nldas/NLDAS2forcing.php</a>) (in particular NLDAS-2). It offer more variables than PRISM, including maximum temperature, minimum temperature, precipitation accumulation, downward surface shortwave radiation, wind-velocity, humidity (maximum and minimum relative humidity and specific humidity. It also offers derived products such as reference evapotranspiration (calculated based on Penman-Montieth equation).</p>
<p>You can use the <code>downloadr::download()</code> function to download gridMET data by variable-year. For example, to download precipitation data for 2018, you can run the following code:</p>
<div class="sourceCode" id="cb861"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">downloader</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/downloader/man/download.html">download</a></span><span class="op">(</span>
  url <span class="op">=</span> <span class="st">"http://www.northwestknowledge.net/metdata/data/pr_2018.nc"</span>,
  destfile <span class="op">=</span> <span class="st">"Data/pr_2018.nc"</span>,
  mode <span class="op">=</span> <span class="st">'wb'</span>
<span class="op">)</span></code></pre></div>
<p>We set the url of the dataset of interest the <code>url</code> option, set the destination file name, and the mode to <code>wb</code> for a binary download.</p>
<p>All the gridMET datasets for direct download has “<a href="http://www.northwestknowledge.net/metdata/data/" class="uri">http://www.northwestknowledge.net/metdata/data/</a>” at the beginning, followed by the file name (here, <strong>pr_2018.nc</strong>). The file names follow the convention of <strong>variable_abbreviation</strong>_<strong>year</strong>.nc. So, we can easily write a loop to get data for multiple variables over multiple years.</p>
<p>Here is the list of variable abbreviations:</p>
<ul>
<li>sph: (Near-Surface Specific Humidity)</li>
<li>vpd: (Mean Vapor Pressure Deficit)</li>
<li>pr: (Precipitation)</li>
<li>rmin: (Minimum Near-Surface Relative Humidity)</li>
<li>rmax: (Maximum Near-Surface Relative Humidity)</li>
<li>srad: (Surface Downwelling Solar Radiation)</li>
<li>tmmn: (Minimum Near-Surface Air Temperature)</li>
<li>tmmx: (Maximum Near-Surface Air Temperature)</li>
<li>vs: (Wind speed at 10 m)</li>
<li>th: (Wind direction at 10 m)</li>
<li>pdsi: (Palmer Drought Severity Index)</li>
<li>pet: (Reference grass evaportranspiration)</li>
<li>etr: (Reference alfalfa evaportranspiration)</li>
<li>erc: (model-G)</li>
<li>bi: (model-G)</li>
<li>fm100: (100-hour dead fuel moisture)</li>
<li>fm1000: (1000-hour dead fuel moisture)</li>
</ul>
<p>As another example, if you are interested in downloading the wind speed data for 2020, then you can use the following code.</p>
<div class="sourceCode" id="cb862"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">downloader</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/downloader/man/download.html">download</a></span><span class="op">(</span>
  url <span class="op">=</span> <span class="st">"http://www.northwestknowledge.net/metdata/data/vs_2020.nc"</span>,
  destfile <span class="op">=</span> <span class="st">"Data/vs_2020.nc"</span>,
  mode <span class="op">=</span> <span class="st">'wb'</span>
<span class="op">)</span></code></pre></div>
<div id="practical-examples" class="section level3" number="9.5.1">
<h3>
<span class="header-section-number">9.5.1</span> Practical Examples<a class="anchor" aria-label="anchor" href="#practical-examples"><i class="fas fa-link"></i></a>
</h3>
<p>Suppose your final goal is to get average daily precipitation (<strong>pr</strong>) and reference grass evapotranspiration (<strong>pet</strong>) from 2015 through 2020 for each of the counties in California.</p>
<p>First get county boundaries for California:</p>
<div class="sourceCode" id="cb863"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">CA_counties</span> <span class="op">&lt;-</span> <span class="fu">tigris</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tigris/man/counties.html">counties</a></span><span class="op">(</span>state <span class="op">=</span> <span class="st">"CA"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/select.html">select</a></span><span class="op">(</span><span class="va">STATEFP</span>, <span class="va">COUNTYFP</span><span class="op">)</span></code></pre></div>
<p>Before writing a loop, let’s work on a single case (<strong>pet</strong> for 2015). First, we download and read the data.</p>
<div class="sourceCode" id="cb864"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#--- download data ---#</span>
<span class="fu">downloader</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/downloader/man/download.html">download</a></span><span class="op">(</span>
  url <span class="op">=</span> <span class="st">"http://www.northwestknowledge.net/metdata/data/pet_2015.nc"</span>,
  destfile <span class="op">=</span> <span class="st">"Data/pet_2015.nc"</span>,
  mode <span class="op">=</span> <span class="st">'wb'</span>
<span class="op">)</span> 

<span class="co">#--- read the raster data ---#</span>
<span class="op">(</span>
<span class="va">pet_2015</span> <span class="op">&lt;-</span> <span class="fu">rast</span><span class="op">(</span><span class="st">"Data/pet_2015.nc"</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<pre><code>class       : SpatRaster 
dimensions  : 585, 1386, 365  (nrow, ncol, nlyr)
resolution  : 0.04166667, 0.04166667  (x, y)
extent      : -124.7875, -67.0375, 25.04583, 49.42083  (xmin, xmax, ymin, ymax)
coord. ref. : lon/lat WGS 84 (EPSG:4326) 
source      : pet_2015.nc 
varname     : potential_evapotranspiration (pet) 
names       : poten~42003, poten~42004, poten~42005, poten~42006, poten~42007, poten~42008, ... 
unit        :          mm,          mm,          mm,          mm,          mm,          mm, ... </code></pre>
<p>As you can see, it is a multi-layer raster object where each layer represents a single day in 2015. Here is a quick visualization of the first layer.</p>
<div class="sourceCode" id="cb866"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">pet_2015</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> </code></pre></div>
<div class="inline-figure"><img src="R_GIS_Book_files/figure-html/gm-2015-pet-viz-1.png" width="672"></div>
<p>Now, we can use <code>exactexactr::exact_extract()</code> to assign cell values to each county and transform it to a more convenient form:</p>
<div class="sourceCode" id="cb867"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pet_county</span> <span class="op">&lt;-</span> 
  <span class="co">#--- extract data for each county ---#</span>
  <span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract</a></span><span class="op">(</span><span class="va">pet_2015</span>, <span class="va">CA_counties</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
  <span class="co">#--- list of data.frames into data.table ---#</span>
  <span class="fu">rbindlist</span><span class="op">(</span>idcol <span class="op">=</span> <span class="st">"rowid"</span><span class="op">)</span>

<span class="co">#--- check the dimension of the output ---#</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">pet_county</span><span class="op">)</span> </code></pre></div>
<pre><code>[1] 28201   367</code></pre>
<p>As you can see the data has 367 columns: 365 (days) + 1 (<code>rowid</code>) + 1 (coverage fraction). Let’s take a look at the name of the first six variables.</p>
<div class="sourceCode" id="cb869"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">pet_county</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>[1] "rowid"                                 
[2] "potential_evapotranspiration_day=42003"
[3] "potential_evapotranspiration_day=42004"
[4] "potential_evapotranspiration_day=42005"
[5] "potential_evapotranspiration_day=42006"
[6] "potential_evapotranspiration_day=42007"</code></pre>
<p>The 5-digit number at the end of the name of the variables for evapotranspiration represents days since Jan 1st, 1900. This can be confirmed using <code>ncdf4:nc_open()</code> (see the middle of the output below under <strong>day</strong> of <strong>4 dimensions</strong>):</p>
<div class="sourceCode" id="cb871"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ncdf4</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/nc_open.html">nc_open</a></span><span class="op">(</span><span class="st">"Data/pet_2015.nc"</span><span class="op">)</span>  </code></pre></div>
<pre><code>File Data/pet_2015.nc (NC_FORMAT_NETCDF4):

     1 variables (excluding dimension variables):
        unsigned short potential_evapotranspiration[lon,lat,day]   (Chunking: [231,98,61])  (Compression: level 9)
            _FillValue: 32767
            units: mm
            description: Daily reference evapotranspiration (short grass)
            long_name: pet
            standard_name: pet
            missing_value: 32767
            dimensions: lon lat time
            grid_mapping: crs
            coordinate_system: WGS84,EPSG:4326
            scale_factor: 0.1
            add_offset: 0
            coordinates: lon lat
            _Unsigned: true

     4 dimensions:
        lon  Size:1386 
            units: degrees_east
            description: longitude
            long_name: longitude
            standard_name: longitude
            axis: X
        lat  Size:585 
            units: degrees_north
            description: latitude
            long_name: latitude
            standard_name: latitude
            axis: Y
        day  Size:365 
            description: days since 1900-01-01
            units: days since 1900-01-01 00:00:00
            long_name: time
            standard_name: time
            calendar: gregorian
        crs  Size:1 
            grid_mapping_name: latitude_longitude
            longitude_of_prime_meridian: 0
            semi_major_axis: 6378137
            long_name: WGS 84
            inverse_flattening: 298.257223563
            GeoTransform: -124.7666666333333 0.041666666666666 0  49.400000000000000 -0.041666666666666
            spatial_ref: GEOGCS["WGS 84",DATUM["WGS_1984",SPHEROID["WGS 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0,AUTHORITY["EPSG","8901"]],UNIT["degree",0.0174532925199433,AUTHORITY["EPSG","9122"]],AUTHORITY["EPSG","4326"]]

    19 global attributes:
        geospatial_bounds_crs: EPSG:4326
        Conventions: CF-1.6
        geospatial_bounds: POLYGON((-124.7666666333333 49.400000000000000, -124.7666666333333 25.066666666666666, -67.058333300000015 25.066666666666666, -67.058333300000015 49.400000000000000, -124.7666666333333 49.400000000000000))
        geospatial_lat_min: 25.066666666666666
        geospatial_lat_max: 49.40000000000000
        geospatial_lon_min: -124.7666666333333
        geospatial_lon_max: -67.058333300000015
        geospatial_lon_resolution: 0.041666666666666
        geospatial_lat_resolution: 0.041666666666666
        geospatial_lat_units: decimal_degrees north
        geospatial_lon_units: decimal_degrees east
        coordinate_system: EPSG:4326
        author: John Abatzoglou - University of Idaho, jabatzoglou@uidaho.edu
        date: 04 July 2019
        note1: The projection information for this file is: GCS WGS 1984.
        note2: Citation: Abatzoglou, J.T., 2013, Development of gridded surface meteorological data for ecological applications and modeling, International Journal of Climatology, DOI: 10.1002/joc.3413
        note3: Data in slices after last_permanent_slice (1-based) are considered provisional and subject to change with subsequent updates
        note4: Data in slices after last_provisional_slice (1-based) are considered early and subject to change with subsequent updates
        note5: Days correspond approximately to calendar days ending at midnight, Mountain Standard Time (7 UTC the next calendar day)</code></pre>
<p>This is universally true for all the gridMET data. We can use this information to recover date. First, let’s transform the data from a wide format to a long format for easier operations:</p>
<div class="sourceCode" id="cb873"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pet_county</span> <span class="op">&lt;-</span>  
  <span class="co">#--- wide to long ---#</span>
  <span class="fu">melt</span><span class="op">(</span><span class="va">pet_county</span>, id.var <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"rowid"</span>, <span class="st">"coverage_fraction"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
  <span class="co">#--- remove observations with NA values ---#</span>
  <span class="va">.</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>, <span class="op">]</span>   

<span class="co">#--- take a look ---#</span>
<span class="va">pet_county</span></code></pre></div>
<pre><code>          rowid coverage_fraction                               variable value
       1:     1       0.004266545 potential_evapotranspiration_day=42003   2.3
       2:     1       0.254054248 potential_evapotranspiration_day=42003   2.2
       3:     1       0.175513789 potential_evapotranspiration_day=42003   2.0
       4:     1       0.442011684 potential_evapotranspiration_day=42003   2.1
       5:     1       1.000000000 potential_evapotranspiration_day=42003   2.2
      ---                                                                     
10115971:    58       0.538234591 potential_evapotranspiration_day=42367   2.1
10115972:    58       0.197555855 potential_evapotranspiration_day=42367   2.7
10115973:    58       0.224901110 potential_evapotranspiration_day=42367   2.2
10115974:    58       0.554238617 potential_evapotranspiration_day=42367   2.2
10115975:    58       0.272462875 potential_evapotranspiration_day=42367   2.1</code></pre>
<p>We now use <code><a href="https://rdrr.io/pkg/stringr/man/str_sub.html">str_sub()</a></code> to get 5-digit numbers from <code>variable</code>, which represents days since Jan 1st, 1900. We can then recover dates using the <code>lubridate</code> package.</p>
<div class="sourceCode" id="cb875"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pet_county</span><span class="op">[</span>, <span class="va">variable</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/pkg/stringr/man/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">variable</span>, <span class="op">-</span><span class="fl">5</span>, <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
  <span class="co">#--- recover dates ---#</span>
  <span class="va">.</span><span class="op">[</span>, <span class="va">date</span> <span class="op">:=</span> <span class="va">variable</span> <span class="op">+</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lubridate/man/ymd.html">ymd</a></span><span class="op">(</span><span class="st">"1900-01-01"</span><span class="op">)</span><span class="op">]</span> 

<span class="co">#--- take a look ---#</span>
<span class="va">pet_county</span></code></pre></div>
<pre><code>          rowid coverage_fraction variable value       date
       1:     1       0.004266545    42003   2.3 2015-01-01
       2:     1       0.254054248    42003   2.2 2015-01-01
       3:     1       0.175513789    42003   2.0 2015-01-01
       4:     1       0.442011684    42003   2.1 2015-01-01
       5:     1       1.000000000    42003   2.2 2015-01-01
      ---                                                  
10115971:    58       0.538234591    42367   2.1 2015-12-31
10115972:    58       0.197555855    42367   2.7 2015-12-31
10115973:    58       0.224901110    42367   2.2 2015-12-31
10115974:    58       0.554238617    42367   2.2 2015-12-31
10115975:    58       0.272462875    42367   2.1 2015-12-31</code></pre>
<p>Finally, let’s calculate the coverage-weighted average of <strong>pet</strong> by county-date.</p>
<div class="sourceCode" id="cb877"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pet_county_avg</span> <span class="op">&lt;-</span> 
  <span class="va">pet_county</span><span class="op">[</span>, 
    <span class="fu">.</span><span class="op">(</span>value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">value</span> <span class="op">*</span> <span class="va">coverage_fraction</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">coverage_fraction</span><span class="op">)</span><span class="op">)</span>,
    by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">rowid</span>, <span class="va">date</span><span class="op">)</span>
  <span class="op">]</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
  <span class="fu">setnames</span><span class="op">(</span><span class="st">"value"</span>, <span class="st">"pet"</span><span class="op">)</span></code></pre></div>
<p>Since <code>rowid</code> value of <strong>n</strong> corresponds to the <strong>n</strong> th row in <code>CA_counties</code>, it is easy to merge <code>pet_county_avg</code> with <code>CA_counties</code> (alternatively, you can use <code><a href="https://rdrr.io/r/base/cbind.html">cbind()</a></code>).</p>
<div class="sourceCode" id="cb878"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">CA_pet</span> <span class="op">&lt;-</span> <span class="va">CA_counties</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/mutate.html">mutate</a></span><span class="op">(</span>rowid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">pet_county_avg</span>, <span class="va">.</span>, by <span class="op">=</span> <span class="st">"rowid"</span><span class="op">)</span></code></pre></div>
<p>Now that we know how to process a single gridMET dataset, we are ready to write a function that goes through the same for a choice of gridMET dataset and then write a loop to achieve our goal. Here is the function:</p>
<div class="sourceCode" id="cb879"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">get_grid_MET</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">var_name</span>, <span class="va">year</span><span class="op">)</span> <span class="op">{</span>
  <span class="co">#--- for testing ---#</span>
  <span class="co"># var_name &lt;- "pet"</span>
  <span class="co"># year &lt;- 2020</span>

  <span class="va">target_url</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span>
    <span class="st">"http://www.northwestknowledge.net/metdata/data/"</span>,
    <span class="va">var_name</span>, <span class="st">"_"</span>, <span class="va">year</span>,
    <span class="st">".nc"</span>
  <span class="op">)</span>

  <span class="va">file_name</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span>
    <span class="st">"Data/"</span>,
    <span class="va">var_name</span>, <span class="st">"_"</span>, <span class="va">year</span>,
    <span class="st">".nc"</span>
  <span class="op">)</span>

  <span class="fu">downloader</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/downloader/man/download.html">download</a></span><span class="op">(</span>
    url <span class="op">=</span> <span class="va">target_url</span>,
    destfile <span class="op">=</span> <span class="va">file_name</span>,
    mode <span class="op">=</span> <span class="st">'wb'</span>
  <span class="op">)</span>

  <span class="co">#--- read the raster data ---#</span>
  <span class="va">temp_rast</span> <span class="op">&lt;-</span> <span class="fu">rast</span><span class="op">(</span><span class="va">file_name</span><span class="op">)</span>

  <span class="va">temp_data</span> <span class="op">&lt;-</span> 
  <span class="co">#--- extract data for each county ---#</span>
  <span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html">exact_extract</a></span><span class="op">(</span><span class="va">temp_rast</span>, <span class="va">CA_counties</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
  <span class="co">#--- list of data.frames into data.table ---#</span>
  <span class="fu">rbindlist</span><span class="op">(</span>idcol <span class="op">=</span> <span class="st">"rowid"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
  <span class="co">#--- wide to long ---#</span>
  <span class="fu">melt</span><span class="op">(</span>id.var <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"rowid"</span>, <span class="st">"coverage_fraction"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
  <span class="co">#--- remove observations with NA values ---#</span>
  <span class="va">.</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>, <span class="op">]</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
  <span class="co">#--- get only the numeric part ---#</span>
  <span class="va">.</span><span class="op">[</span>, <span class="va">variable</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/pkg/stringr/man/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">variable</span>, <span class="op">-</span><span class="fl">5</span>, <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
  <span class="co">#--- recover dates ---#</span>
  <span class="va">.</span><span class="op">[</span>, <span class="va">date</span> <span class="op">:=</span> <span class="va">variable</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/lubridate/man/ymd.html">ymd</a></span><span class="op">(</span><span class="st">"1900-01-01"</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
  <span class="co">#--- find daily coverage-weight average by county ---#</span>
  <span class="va">.</span><span class="op">[</span>, 
    <span class="fu">.</span><span class="op">(</span>value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">value</span> <span class="op">*</span> <span class="va">coverage_fraction</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">coverage_fraction</span><span class="op">)</span><span class="op">)</span>, 
    by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">rowid</span>, <span class="va">date</span><span class="op">)</span>
  <span class="op">]</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
  <span class="va">.</span><span class="op">[</span>, <span class="va">var</span> <span class="op">:=</span> <span class="va">var_name</span><span class="op">]</span>

  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">temp_data</span><span class="op">)</span>

<span class="op">}</span></code></pre></div>
<p>Let’s now loop over the variables and years of interest. We first set up a dataset of variable-year combinations for which we loop over.</p>
<div class="sourceCode" id="cb880"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#--- create a dataset of parameters to be looped over---#</span>
<span class="op">(</span>
<span class="va">par_data</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span>
    var_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pr"</span>, <span class="st">"pet"</span><span class="op">)</span>,
    year <span class="op">=</span> <span class="fl">2015</span><span class="op">:</span><span class="fl">2020</span>
  <span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
  <span class="fu">data.table</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
  <span class="va">.</span><span class="op">[</span>, <span class="va">var_name</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">var_name</span><span class="op">)</span><span class="op">]</span>
<span class="op">)</span></code></pre></div>
<p>We now loop over the rows of <code>par_data</code> in parallel:</p>
<div class="sourceCode" id="cb881"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#--- parallel processing ---#</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://future.apply.futureverse.org">future.apply</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/future/man/plan.html">plan</a></span><span class="op">(</span><span class="va">multiprocess</span>, workers <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>

<span class="op">(</span>
<span class="va">all_data</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/future.apply/man/future_lapply.html">future_lapply</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">par_data</span><span class="op">)</span><span class="op">)</span>, 
    <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">get_grid_MET</span><span class="op">(</span><span class="va">par_data</span><span class="op">[</span><span class="va">x</span>, <span class="va">var_name</span><span class="op">]</span>, <span class="va">par_data</span><span class="op">[</span><span class="va">x</span>, <span class="va">year</span><span class="op">]</span><span class="op">)</span>
  <span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
  <span class="fu">rbindlist</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> 
  <span class="fu">dcast</span><span class="op">(</span><span class="va">rowid</span> <span class="op">+</span> <span class="va">date</span> <span class="op">~</span> <span class="va">var</span>, value.var <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<pre><code>        rowid       date      pet           pr
     1:     1 2015-01-01 1.676250 5.085478e-05
     2:     1 2015-01-02 1.333865 3.675661e-02
     3:     1 2015-01-03 1.299940 0.000000e+00
     4:     1 2015-01-04 1.687250 0.000000e+00
     5:     1 2015-01-05 1.453381 0.000000e+00
    ---                                       
127132:    58 2020-12-27 1.851531 1.670983e+01
127133:    58 2020-12-28 1.025404 1.435838e+01
127134:    58 2020-12-29 1.559160 0.000000e+00
127135:    58 2020-12-30 2.048376 1.066704e-01
127136:    58 2020-12-31 1.398130 1.841696e-01</code></pre>
<!-- 
## USGS (under construction)

Under construction
 -->
<!-- [USGS R](https://owi.usgs.gov/R/index.html)

### Groundwater level data


```r
library(dataRetrieval)
state_ls <- state.abb

data_ne <- whatNWISdata(stateCd = "NE")

KS_gwl <- readNWISdata(
    stateCd="Kansas", 
    startDate = "1980-01-01", 
    endDate = "2020-01-01", 
    service = "gwlevels"
  ) %>% 
  select(site_no, lev_dt, lev_va) %>% 
  rename(date = lev_dt, dwt = lev_va)

KS_site_ls <- KS_gwl[,site_no] %>% unique()

sites_info <- readNWISsite(siteNumbers = KS_site_ls) %>% 
  select(site_no, dec_lat_va, dec_long_va) %>% 
  st_as_sf(coords = c("dec_long_va", "dec_lat_va")) %>% 
  st_set_crs(4269)
```

### Nitrogen concentration


```r
SaltLake_totalN <- readNWISdata(
  bBox = c(-113.0428, 40.6474, -112.0265, 41.7018), 
  service = "qw", 
  parameterCd = "00600", 
  startDate = "2020-01-01"
)

attributes(SaltLake_totalN)

attr(SaltLake_totalN, "variableInfo")


phosphorous: 00665
nitrogen: 00665
```


### Water temperature

```r
MauiCo_avgdailyQ <- readNWISdata(
  stateCd = "Hawaii", 
  service = "dv", 
  parameterCd = "00060"
)

head(MauiCo_avgdailyQ)
```

### WQP 

[WQP user guide](https://www.waterqualitydata.us/portal_userguide/)

[WQP query](https://www.waterqualitydata.us/webservices_documentation/#WQPWebServicesGuide-Submitting)


```r
wqpcounts_ia <- readWQPdata(
  statecode="US:19", 
  querySummary = TRUE
)

IA_lake_phosphorus <- readWQPdata(
  statecode = "IA", 
  siteType = "Lake, Reservoir, Impoundment", 
  characteristicName = "Phosphorus", 
  startDate = "1990-10-01" 
) %>% 
filter(MonitoringLocationIdentifier, ResultMeasureValue, ActivityStartDate)

#--- get longitude and latitude ---#
siteInfo <- attr(IA_lake_phosphorus, "siteInfo") %>% 
  select(MonitoringLocationIdentifier, dec_lat_va, dec_lon_va) %>% 
  st_as_sf(coords = c("dec_lon_va", "dec_lat_va")) %>% 
  st_set_crs(4269)

attributes()
```
 -->
<!-- 
## Sentinel with `sen2r` (under construction)

Under construction


## Census with `tidycensus` (under construction)

Under construction

 -->

</div>
</div>
</div>




  <div class="chapter-nav">
<div class="prev"><a href="create-maps.html"><span class="header-section-number">8</span> Creating Maps using ggplot2</a></div>
<div class="next"><a href="par-comp.html"><span class="header-section-number">A</span> Loop and Parallel Computing</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#download-data"><span class="header-section-number">9</span> Download and process spatial datasets from within R</a></li>
<li>
<a class="nav-link" href="#before-you-start-8">Before you start</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#direction-for-replication-8">Direction for replication</a></li></ul>
</li>
<li>
<a class="nav-link" href="#nass-quick"><span class="header-section-number">9.1</span> USDA NASS QuickStat with tidyUSDA</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#look-for-parameter-values"><span class="header-section-number">9.1.1</span> Look for parameter values</a></li>
<li><a class="nav-link" href="#caveats"><span class="header-section-number">9.1.2</span> Caveats</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#CropScapeR"><span class="header-section-number">9.2</span> CDL with CropScapeR</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#getcdldata-download-the-cdl-data-as-raster-data"><span class="header-section-number">9.2.1</span> GetCDLData: Download the CDL data as raster data</a></li>
<li><a class="nav-link" href="#data-processing-after-downloading-data"><span class="header-section-number">9.2.2</span> Data processing after downloading data</a></li>
<li><a class="nav-link" href="#other-forms-of-cdl-data"><span class="header-section-number">9.2.3</span> Other forms of CDL data</a></li>
<li><a class="nav-link" href="#mac-problem"><span class="header-section-number">9.2.4</span> SSL certificate problem on Mac</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#download-prism"><span class="header-section-number">9.3</span> PRISM with prism</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#basics"><span class="header-section-number">9.3.1</span> Basics</a></li>
<li><a class="nav-link" href="#download-daily-prism-data-for-many-years-and-build-your-own-datasets"><span class="header-section-number">9.3.2</span> Download daily PRISM data for many years and build your own datasets</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#daymet-with-daymetr-and-feddata"><span class="header-section-number">9.4</span> Daymet with daymetr and FedData</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#for-points-data"><span class="header-section-number">9.4.1</span> For points data</a></li>
<li><a class="nav-link" href="#daymet-poly"><span class="header-section-number">9.4.2</span> For polygons data</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#gridMET"><span class="header-section-number">9.5</span> gridMET</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#practical-examples"><span class="header-section-number">9.5.1</span> Practical Examples</a></li></ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>R as GIS for Economists</strong>" was written by Taro Mieno. It was last built on 2022-04-13.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
